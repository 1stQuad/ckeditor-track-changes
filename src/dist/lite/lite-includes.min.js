/* Source version: 1.2.18 */
(function(b){var k=(typeof b.define=="function"&&b.define.amd);var t="object",d="function",z="undefined";var a=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"];var p=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"];var l=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"];var E=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"];function B(M,L){var K=typeof M[L];return K==d||(!!(K==t&&M[L]))||K=="unknown"}function x(L,K){return !!(typeof L[K]==t&&L[K])}function e(L,K){return typeof L[K]!=z}function v(K){return function(N,M){var L=M.length;while(L--){if(!K(N,M[L])){return false}}return true}}var j=v(B);var s=v(x);var g=v(e);function y(K){return K&&j(K,E)&&g(K,l)}function H(K){return x(K,"body")?K.body:K.getElementsByTagName("body")[0]}var u={};var h={version:"1.3alpha.20140716",initialized:false,supported:true,util:{isHostMethod:B,isHostObject:x,isHostProperty:e,areHostMethods:j,areHostObjects:s,areHostProperties:g,isTextRange:y,getBody:H},features:{},modules:u,config:{alertOnFail:true,alertOnWarn:false,preferTextRange:false}};function D(K){if(x(window,"console")&&B(window.console,"log")){window.console.log(K)}}function o(L,K){if(K){window.alert(L)}else{D(L)}}function m(K){h.initialized=true;h.supported=false;o("Rangy is not supported on this page in your browser. Reason: "+K,h.config.alertOnFail)}h.fail=m;function n(K){o("Rangy warning: "+K,h.config.alertOnWarn)}h.warn=n;if({}.hasOwnProperty){h.util.extend=function(O,M,K){var P,N;for(var L in M){if(M.hasOwnProperty(L)){P=O[L];N=M[L];if(K&&P!==null&&typeof P=="object"&&N!==null&&typeof N=="object"){h.util.extend(P,N,true)}O[L]=N}}if(M.hasOwnProperty("toString")){O.toString=M.toString}return O}}else{m("hasOwnProperty not supported")}(function(){var L=document.createElement("div");L.appendChild(document.createElement("span"));var N=[].slice;var K;try{if(N.call(L.childNodes,0)[0].nodeType==1){K=function(O){return N.call(O,0)}}}catch(M){}if(!K){K=function(Q){var P=[];for(var R=0,O=Q.length;R<O;++R){P[R]=Q[R]}return P}}h.util.toArray=K})();var i;if(B(document,"addEventListener")){i=function(M,K,L){M.addEventListener(K,L,false)}}else{if(B(document,"attachEvent")){i=function(M,K,L){M.attachEvent("on"+K,L)}}else{m("Document does not have required addEventListener or attachEvent method")}}h.util.addListener=i;var I=[];function c(K){return K.message||K.description||String(K)}function F(){if(h.initialized){return}var M;var T=false,N=false;if(B(document,"createRange")){M=document.createRange();if(j(M,p)&&g(M,a)){T=true}}var P=H(document);if(!P||P.nodeName.toLowerCase()!="body"){m("No body element found");return}if(P&&B(P,"createTextRange")){M=P.createTextRange();if(y(M)){N=true}}if(!T&&!N){m("Neither Range nor TextRange are available");return}h.initialized=true;h.features={implementsDomRange:T,implementsTextRange:N};var L,R;for(var K in u){if((L=u[K]) instanceof w){L.init(L,h)}}for(var O=0,Q=I.length;O<Q;++O){try{I[O](h)}catch(S){R="Rangy init listener threw an exception. Continuing. Detail: "+c(S);D(R)}}}h.init=F;h.addInitListener=function(K){if(h.initialized){K(h)}else{I.push(K)}};var J=[];h.addCreateMissingNativeApiListener=function(K){J.push(K)};function r(M){M=M||window;F();for(var L=0,K=J.length;L<K;++L){J[L](M)}}h.createMissingNativeApi=r;function w(K,M,L){this.name=K;this.dependencies=M;this.initialized=false;this.supported=false;this.initializer=L}w.prototype={init:function(N){var O=this.dependencies||[];for(var M=0,K=O.length,P,L;M<K;++M){L=O[M];P=u[L];if(!P||!(P instanceof w)){throw new Error("required module '"+L+"' not found")}P.init();if(!P.supported){throw new Error("required module '"+L+"' not supported")}}this.initializer(this)},fail:function(K){this.initialized=true;this.supported=false;throw new Error("Module '"+this.name+"' failed to load: "+K)},warn:function(K){h.warn("Module "+this.name+": "+K)},deprecationNotice:function(K,L){h.warn("DEPRECATED: "+K+" in module "+this.name+"is deprecated. Please use "+L+" instead")},createError:function(K){return new Error("Error in Rangy "+this.name+" module: "+K)}};function q(K,L,N,O){var M=new w(L,N,function(R){if(!R.initialized){R.initialized=true;try{O(h,R);R.supported=true}catch(Q){var P="Module '"+L+"' failed to load: "+c(Q);D(P)}}});u[L]=M}h.createModule=function(K){var M,L;if(arguments.length==2){M=arguments[1];L=[]}else{M=arguments[2];L=arguments[1]}q(false,K,L,M)};h.createCoreModule=function(K,L,M){q(true,K,L,M)};function C(){}h.RangePrototype=C;h.rangePrototype=new C();function A(){}h.selectionPrototype=new A();var f=false;var G=function(K){if(!f){f=true;if(!h.initialized){F()}}};if(typeof window==z){m("No window found");return}if(typeof document==z){m("No document found");return}if(B(document,"addEventListener")){document.addEventListener("DOMContentLoaded",G,false)}i(window,"load",G);if(k){(function(K){K(function(){h.amd=true;return h})})(b.define)}b.rangy=h})(this);rangy.createCoreModule("DomUtil",[],function(d,b){var s="undefined";var f=d.util;if(!f.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])){b.fail("document missing a Node creation method")}if(!f.isHostMethod(document,"getElementsByTagName")){b.fail("document missing getElementsByTagName method")}var E=document.createElement("div");if(!f.areHostMethods(E,["insertBefore","appendChild","cloneNode"]||!f.areHostObjects(E,["previousSibling","nextSibling","childNodes","parentNode"]))){b.fail("Incomplete Element implementation")}if(!f.isHostProperty(E,"innerHTML")){b.fail("Element is missing innerHTML property")}var G=document.createTextNode("test");if(!f.areHostMethods(G,["splitText","deleteData","insertData","appendData","cloneNode"]||!f.areHostObjects(E,["previousSibling","nextSibling","childNodes","parentNode"])||!f.areHostProperties(G,["data"]))){b.fail("Incomplete Text Node implementation")}var J=function(K,M){var L=K.length;while(L--){if(K[L]===M){return true}}return false};function h(L){var K;return typeof L.namespaceURI==s||((K=L.namespaceURI)===null||K=="http://www.w3.org/1999/xhtml")}function t(L){var K=L.parentNode;return(K.nodeType==1)?K:null}function n(L){var K=0;while((L=L.previousSibling)){++K}return K}function v(K){switch(K.nodeType){case 7:case 10:return 0;case 3:case 8:return K.length;default:return K.childNodes.length}}function k(L,K){var M=[],N;for(N=L;N;N=N.parentNode){M.push(N)}for(N=K;N;N=N.parentNode){if(J(M,N)){return N}}return null}function j(K,L,N){var M=N?L:L.parentNode;while(M){if(M===K){return true}else{M=M.parentNode}}return false}function C(K,L){return j(K,L,true)}function A(L,K,O){var M,N=O?L:L.parentNode;while(N){M=N.parentNode;if(M===K){return N}N=M}return null}function c(L){var K=L.nodeType;return K==3||K==4||K==8}function a(L){if(!L){return false}var K=L.nodeType;return K==3||K==8}function g(N,L){var K=L.nextSibling,M=L.parentNode;if(K){M.insertBefore(N,K)}else{M.appendChild(N)}return N}function u(P,M,L){var O=P.cloneNode(false);O.deleteData(0,M);P.deleteData(M,P.length-M);g(O,P);if(L){for(var N=0,K;K=L[N++];){if(K.node==P&&K.offset>M){K.node=O;K.offset-=M}else{if(K.node==P.parentNode&&K.offset>n(P)){++K.offset}}}}return O}function H(K){if(K.nodeType==9){return K}else{if(typeof K.ownerDocument!=s){return K.ownerDocument}else{if(typeof K.document!=s){return K.document}else{if(K.parentNode){return H(K.parentNode)}else{throw b.createError("getDocument: no document found for node")}}}}}function m(K){var L=H(K);if(typeof L.defaultView!=s){return L.defaultView}else{if(typeof L.parentWindow!=s){return L.parentWindow}else{throw b.createError("Cannot get a window object for node")}}}function I(K){if(typeof K.contentDocument!=s){return K.contentDocument}else{if(typeof K.contentWindow!=s){return K.contentWindow.document}else{throw b.createError("getIframeDocument: No Document object found for iframe element")}}}function F(K){if(typeof K.contentWindow!=s){return K.contentWindow}else{if(typeof K.contentDocument!=s){return K.contentDocument.defaultView}else{throw b.createError("getIframeWindow: No Window object found for iframe element")}}}function y(K){return K&&f.isHostMethod(K,"setTimeout")&&f.isHostObject(K,"document")}function x(N,L,K){var M;if(!N){M=document}else{if(f.isHostProperty(N,"nodeType")){M=(N.nodeType==1&&N.tagName.toLowerCase()=="iframe")?I(N):H(N)}else{if(y(N)){M=N.document}}}if(!M){throw L.createError(K+"(): Parameter must be a Window object or DOM node")}return M}function i(L){var K;while((K=L.parentNode)){L=K}return L}function B(N,P,M,O){var K,Q,S,R,L;if(N==M){return P===O?0:(P<O)?-1:1}else{if((K=A(M,N,true))){return P<=n(K)?-1:1}else{if((K=A(N,M,true))){return n(K)<O?-1:1}else{Q=k(N,M);if(!Q){throw new Error("comparePoints error: nodes have no common ancestor")}S=(N===Q)?Q:A(N,Q,true);R=(M===Q)?Q:A(M,Q,true);if(S===R){throw b.createError("comparePoints got to case 4 and childA and childB are the same!")}else{L=Q.firstChild;while(L){if(L===S){return -1}else{if(L===R){return 1}}L=L.nextSibling}}}}}}var q=false;function p(K){var M;try{M=K.parentNode;return false}catch(L){return true}}(function(){var K=document.createElement("b");K.innerHTML="1";var L=K.firstChild;K.innerHTML="<br>";q=p(L);d.features.crashyTextNodes=q})();function r(K){if(!K){return"[No node]"}if(q&&p(K)){return"[Broken node]"}if(c(K)){return'"'+K.data+'"'}if(K.nodeType==1){var L=K.id?' id="'+K.id+'"':"";return"<"+K.nodeName+L+">[index:"+n(K)+",length:"+K.childNodes.length+"]["+(K.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return K.nodeName}function z(L){var K=H(L).createDocumentFragment(),M;while((M=L.firstChild)){K.appendChild(M)}return K}var l;if(typeof window.getComputedStyle!=s){l=function(K,L){return m(K).getComputedStyle(K,null)[L]}}else{if(typeof document.documentElement.currentStyle!=s){l=function(K,L){return K.currentStyle[L]}}else{b.fail("No means of obtaining computed style properties found")}}function e(K){this.root=K;this._next=K}e.prototype={_current:null,hasNext:function(){return !!this._next},next:function(){var M=this._current=this._next;var L,K;if(this._current){L=M.firstChild;if(L){this._next=L}else{K=null;while((M!==this.root)&&!(K=M.nextSibling)){M=M.parentNode}this._next=K}}return this._current},detach:function(){this._current=this._next=this.root=null}};function D(K){return new e(K)}function o(K,L){this.node=K;this.offset=L}o.prototype={equals:function(K){return !!K&&this.node===K.node&&this.offset==K.offset},inspect:function(){return"[DomPosition("+r(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}};function w(K){this.code=this[K];this.codeName=K;this.message="DOMException: "+this.codeName}w.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24};w.prototype.toString=function(){return this.message};d.dom={arrayContains:J,isHtmlNamespace:h,parentElement:t,getNodeIndex:n,getNodeLength:v,getCommonAncestor:k,isAncestorOf:j,isOrIsAncestorOf:C,getClosestAncestorIn:A,isCharacterDataNode:c,isTextOrCommentNode:a,insertAfter:g,splitDataNode:u,getDocument:H,getWindow:m,getIframeWindow:F,getIframeDocument:I,getBody:f.getBody,isWindow:y,getContentDocument:x,getRootContainer:i,comparePoints:B,isBrokenNode:p,inspectNode:r,getComputedStyleProperty:l,fragmentFromNodeChildren:z,createIterator:D,DomPosition:o};d.DOMException=w});rangy.createCoreModule("DomRange",["DomUtil"],function(j,f){var c=j.dom;var r=j.util;var E=c.DomPosition;var W=j.DOMException;var h=c.isCharacterDataNode;var B=c.getNodeIndex;var ag=c.isOrIsAncestorOf;var ar=c.getDocument;var ad=c.comparePoints;var U=c.splitDataNode;var ac=c.getClosestAncestorIn;var V=c.getNodeLength;var at=c.arrayContains;var v=c.getRootContainer;var K=j.features.crashyTextNodes;function x(au,e){return(au.nodeType!=3)&&(ag(au,e.startContainer)||ag(au,e.endContainer))}function n(e){return e.document||ar(e.startContainer)}function A(e){return new E(e.parentNode,B(e))}function Z(e){return new E(e.parentNode,B(e)+1)}function k(au,aw,av){var e=au.nodeType==11?au.firstChild:au;if(h(aw)){if(av==aw.length){c.insertAfter(au,aw)}else{aw.parentNode.insertBefore(au,av==0?aw:U(aw,av))}}else{if(av>=aw.childNodes.length){aw.appendChild(au)}else{aw.insertBefore(au,aw.childNodes[av])}}return e}function aq(aw,av,e){i(aw);i(av);if(n(av)!=n(aw)){throw new W("WRONG_DOCUMENT_ERR")}var ax=ad(aw.startContainer,aw.startOffset,av.endContainer,av.endOffset),au=ad(aw.endContainer,aw.endOffset,av.startContainer,av.startOffset);return e?ax<=0&&au>=0:ax<0&&au>0}function H(av){var au;for(var aw,ax=n(av.range).createDocumentFragment(),e;aw=av.next();){au=av.isPartiallySelectedSubtree();aw=aw.cloneNode(!au);if(au){e=av.getSubtreeIterator();aw.appendChild(H(e));e.detach()}if(aw.nodeType==10){throw new W("HIERARCHY_REQUEST_ERR")}ax.appendChild(aw)}return ax}function Y(au,ax,e){var av,az;e=e||{stop:false};for(var aw,ay;aw=au.next();){if(au.isPartiallySelectedSubtree()){if(ax(aw)===false){e.stop=true;return}else{ay=au.getSubtreeIterator();Y(ay,ax,e);ay.detach();if(e.stop){return}}}else{av=c.createIterator(aw);while((az=av.next())){if(ax(az)===false){e.stop=true;return}}}}}function o(au){var e;while(au.next()){if(au.isPartiallySelectedSubtree()){e=au.getSubtreeIterator();o(e);e.detach()}else{au.remove()}}}function R(au){for(var av,aw=n(au.range).createDocumentFragment(),e;av=au.next();){if(au.isPartiallySelectedSubtree()){av=av.cloneNode(false);e=au.getSubtreeIterator();av.appendChild(R(e));e.detach()}else{au.remove()}if(av.nodeType==10){throw new W("HIERARCHY_REQUEST_ERR")}aw.appendChild(av)}return aw}function q(av,e,aw){var ay=!!(e&&e.length),ax;var az=!!aw;if(ay){ax=new RegExp("^("+e.join("|")+")$")}var au=[];Y(new g(av,false),function(aB){if(ay&&!ax.test(aB.nodeType)){return}if(az&&!aw(aB)){return}var aC=av.startContainer;if(aB==aC&&h(aC)&&av.startOffset==aC.length){return}var aA=av.endContainer;if(aB==aA&&h(aA)&&av.endOffset==0){return}au.push(aB)});return au}function z(e){var au=(typeof e.getName=="undefined")?"Range":e.getName();return"["+au+"("+c.inspectNode(e.startContainer)+":"+e.startOffset+", "+c.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function g(av,au){this.range=av;this.clonePartiallySelectedTextNodes=au;if(!av.collapsed){this.sc=av.startContainer;this.so=av.startOffset;this.ec=av.endContainer;this.eo=av.endOffset;var e=av.commonAncestorContainer;if(this.sc===this.ec&&h(this.sc)){this.isSingleCharacterDataNode=true;this._first=this._last=this._next=this.sc}else{this._first=this._next=(this.sc===e&&!h(this.sc))?this.sc.childNodes[this.so]:ac(this.sc,e,true);this._last=(this.ec===e&&!h(this.ec))?this.ec.childNodes[this.eo-1]:ac(this.ec,e,true)}}}g.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:false,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return !!this._next},next:function(){var e=this._current=this._next;if(e){this._next=(e!==this._last)?e.nextSibling:null;if(h(e)&&this.clonePartiallySelectedTextNodes){if(e===this.ec){(e=e.cloneNode(true)).deleteData(this.eo,e.length-this.eo)}if(this._current===this.sc){(e=e.cloneNode(true)).deleteData(0,this.so)}}}return e},remove:function(){var au=this._current,av,e;if(h(au)&&(au===this.sc||au===this.ec)){av=(au===this.sc)?this.so:0;e=(au===this.ec)?this.eo:au.length;if(av!=e){au.deleteData(av,e-av)}}else{if(au.parentNode){au.parentNode.removeChild(au)}else{}}},isPartiallySelectedSubtree:function(){var e=this._current;return x(e,this.range)},getSubtreeIterator:function(){var au;if(this.isSingleCharacterDataNode){au=this.range.cloneRange();au.collapse(false)}else{au=new ao(n(this.range));var ay=this._current;var aw=ay,e=0,ax=ay,av=V(ay);if(ag(ay,this.sc)){aw=this.sc;e=this.so}if(ag(ay,this.ec)){ax=this.ec;av=this.eo}D(au,aw,e,ax,av)}return new g(au,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var aj=[1,3,4,5,7,8,10];var ah=[2,9,11];var C=[5,6,10,12];var N=[1,3,4,5,7,8,10,11];var F=[1,3,4,5,7,8];function ab(e){return function(av,ax){var au,aw=ax?av:av.parentNode;while(aw){au=aw.nodeType;if(at(e,au)){return aw}aw=aw.parentNode}return null}}var I=ab([9,11]);var L=ab(C);var b=ab([6,10,12]);function t(au,e){if(b(au,e)){throw new W("INVALID_NODE_TYPE_ERR")}}function X(e,au){if(!at(au,e.nodeType)){throw new W("INVALID_NODE_TYPE_ERR")}}function ai(e,au){if(au<0||au>(h(e)?e.length:e.childNodes.length)){throw new W("INDEX_SIZE_ERR")}}function d(au,e){if(I(au,true)!==I(e,true)){throw new W("WRONG_DOCUMENT_ERR")}}function af(e){if(L(e,true)){throw new W("NO_MODIFICATION_ALLOWED_ERR")}}function am(au,e){if(!au){throw new W(e)}}function p(e){return(K&&c.isBrokenNode(e))||!at(ah,e.nodeType)&&!I(e,true)}function ap(e,au){return au<=(h(e)?e.length:e.childNodes.length)}function P(e){return(!!e.startContainer&&!!e.endContainer&&!p(e.startContainer)&&!p(e.endContainer)&&ap(e.startContainer,e.startOffset)&&ap(e.endContainer,e.endOffset))}function i(e){if(!P(e)){throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}}var a=document.createElement("style");var Q=false;try{a.innerHTML="<b>x</b>";Q=(a.firstChild.nodeType==3)}catch(al){}j.features.htmlParsingConforms=Q;var S=Q?function(av){var au=this.startContainer;var aw=ar(au);if(!au){throw new W("INVALID_STATE_ERR")}var e=null;if(au.nodeType==1){e=au}else{if(h(au)){e=c.parentElement(au)}}if(e===null||(e.nodeName=="HTML"&&c.isHtmlNamespace(ar(e).documentElement)&&c.isHtmlNamespace(e))){e=aw.createElement("body")}else{e=e.cloneNode(false)}e.innerHTML=av;return c.fragmentFromNodeChildren(e)}:function(au){var av=n(this);var e=av.createElement("body");e.innerHTML=au;return c.fragmentFromNodeChildren(e)};function an(av,e){i(av);var az=av.startContainer,ay=av.startOffset,aw=av.endContainer,au=av.endOffset;var ax=(az===aw);if(h(aw)&&au>0&&au<aw.length){U(aw,au,e)}if(h(az)&&ay>0&&ay<az.length){az=U(az,ay,e);if(ax){au-=ay;aw=az}else{if(aw==az.parentNode&&au>=B(az)){au++}}ay=0}av.setStartAndEnd(az,ay,aw,au)}var M=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"];var m=0,y=1,ak=2,ae=3;var u=0,w=1,J=2,l=3;r.extend(j.rangePrototype,{compareBoundaryPoints:function(ay,av){i(this);d(this.startContainer,av.startContainer);var aA,au,az,e;var ax=(ay==ae||ay==m)?"start":"end";var aw=(ay==y||ay==m)?"start":"end";aA=this[ax+"Container"];au=this[ax+"Offset"];az=av[aw+"Container"];e=av[aw+"Offset"];return ad(aA,au,az,e)},insertNode:function(au){i(this);X(au,N);af(this.startContainer);if(ag(au,this.startContainer)){throw new W("HIERARCHY_REQUEST_ERR")}var e=k(au,this.startContainer,this.startOffset);this.setStartBefore(e)},cloneContents:function(){i(this);var av,au;if(this.collapsed){return n(this).createDocumentFragment()}else{if(this.startContainer===this.endContainer&&h(this.startContainer)){av=this.startContainer.cloneNode(true);av.data=av.data.slice(this.startOffset,this.endOffset);au=n(this).createDocumentFragment();au.appendChild(av);return au}else{var e=new g(this,true);av=H(e);e.detach()}return av}},canSurroundContents:function(){i(this);af(this.startContainer);af(this.endContainer);var e=new g(this,true);var au=(e._first&&(x(e._first,this))||(e._last&&x(e._last,this)));e.detach();return !au},surroundContents:function(au){X(au,F);if(!this.canSurroundContents()){throw new W("INVALID_STATE_ERR")}var e=this.extractContents();if(au.hasChildNodes()){while(au.lastChild){au.removeChild(au.lastChild)}}k(au,this.startContainer,this.startOffset);au.appendChild(e);this.selectNode(au)},cloneRange:function(){i(this);var e=new ao(n(this));var au=M.length,av;while(au--){av=M[au];e[av]=this[av]}return e},toString:function(){i(this);var av=this.startContainer;if(av===this.endContainer&&h(av)){return(av.nodeType==3||av.nodeType==4)?av.data.slice(this.startOffset,this.endOffset):""}else{var e=[],au=new g(this,true);Y(au,function(aw){if(aw.nodeType==3||aw.nodeType==4){e.push(aw.data)}});au.detach();return e.join("")}},compareNode:function(av){i(this);var au=av.parentNode;var ax=B(av);if(!au){throw new W("NOT_FOUND_ERR")}var aw=this.comparePoint(au,ax),e=this.comparePoint(au,ax+1);if(aw<0){return(e>0)?J:u}else{return(e>0)?w:l}},comparePoint:function(e,au){i(this);am(e,"HIERARCHY_REQUEST_ERR");d(e,this.startContainer);if(ad(e,au,this.startContainer,this.startOffset)<0){return -1}else{if(ad(e,au,this.endContainer,this.endOffset)>0){return 1}}return 0},createContextualFragment:S,toHtml:function(){i(this);var e=this.commonAncestorContainer.parentNode.cloneNode(false);e.appendChild(this.cloneContents());return e.innerHTML},intersectsNode:function(aw,e){i(this);am(aw,"NOT_FOUND_ERR");if(ar(aw)!==n(this)){return false}var av=aw.parentNode,ay=B(aw);am(av,"NOT_FOUND_ERR");var ax=ad(av,ay,this.endContainer,this.endOffset),au=ad(av,ay+1,this.startContainer,this.startOffset);return e?ax<=0&&au>=0:ax<0&&au>0},isPointInRange:function(e,au){i(this);am(e,"HIERARCHY_REQUEST_ERR");d(e,this.startContainer);return(ad(e,au,this.startContainer,this.startOffset)>=0)&&(ad(e,au,this.endContainer,this.endOffset)<=0)},intersectsRange:function(e){return aq(this,e,false)},intersectsOrTouchesRange:function(e){return aq(this,e,true)},intersection:function(e){if(this.intersectsRange(e)){var aw=ad(this.startContainer,this.startOffset,e.startContainer,e.startOffset),au=ad(this.endContainer,this.endOffset,e.endContainer,e.endOffset);var av=this.cloneRange();if(aw==-1){av.setStart(e.startContainer,e.startOffset)}if(au==1){av.setEnd(e.endContainer,e.endOffset)}return av}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var au=this.cloneRange();if(ad(e.startContainer,e.startOffset,this.startContainer,this.startOffset)==-1){au.setStart(e.startContainer,e.startOffset)}if(ad(e.endContainer,e.endOffset,this.endContainer,this.endOffset)==1){au.setEnd(e.endContainer,e.endOffset)}return au}else{throw new W("Ranges do not intersect")}},containsNode:function(au,e){if(e){return this.intersectsNode(au,false)}else{return this.compareNode(au)==l}},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,V(e))<=0},containsRange:function(e){var au=this.intersection(e);return au!==null&&e.equals(au)},containsNodeText:function(av){var aw=this.cloneRange();aw.selectNode(av);var au=aw.getNodes([3]);if(au.length>0){aw.setStart(au[0],0);var e=au.pop();aw.setEnd(e,e.length);return this.containsRange(aw)}else{return this.containsNodeContents(av)}},getNodes:function(e,au){i(this);return q(this,e,au)},getDocument:function(){return n(this)},collapseBefore:function(e){this.setEndBefore(e);this.collapse(false)},collapseAfter:function(e){this.setStartAfter(e);this.collapse(true)},getBookmark:function(e){var ax=n(this);var av=j.createRange(ax);e=e||c.getBody(ax);av.selectNodeContents(e);var aw=this.intersection(av);var ay=0,au=0;if(aw){av.setEnd(aw.startContainer,aw.startOffset);ay=av.toString().length;au=ay+aw.toString().length}return{start:ay,end:au,containerNode:e}},moveToBookmark:function(aA){var aw=aA.containerNode;var e=0;this.setStart(aw,0);this.collapse(true);var ay=[aw],au,av=false,aB=false;var az,ax,aC;while(!aB&&(au=ay.pop())){if(au.nodeType==3){az=e+au.length;if(!av&&aA.start>=e&&aA.start<=az){this.setStart(au,aA.start-e);av=true}if(av&&aA.end>=e&&aA.end<=az){this.setEnd(au,aA.end-e);aB=true}e=az}else{aC=au.childNodes;ax=aC.length;while(ax--){ay.push(aC[ax])}}}},getName:function(){return"DomRange"},equals:function(e){return ao.rangesEqual(this,e)},isValid:function(){return P(this)},inspect:function(){return z(this)},detach:function(){}});function T(e){e.START_TO_START=m;e.START_TO_END=y;e.END_TO_END=ak;e.END_TO_START=ae;e.NODE_BEFORE=u;e.NODE_AFTER=w;e.NODE_BEFORE_AND_AFTER=J;e.NODE_INSIDE=l}function G(e){T(e);T(e.prototype)}function s(e,au){return function(){i(this);var aA=this.startContainer,az=this.startOffset,av=this.commonAncestorContainer;var ax=new g(this,true);var ay,aB;if(aA!==av){ay=ac(aA,av,true);aB=Z(ay);aA=aB.node;az=aB.offset}Y(ax,af);ax.reset();var aw=e(ax);ax.detach();au(this,aA,az,aA,az);return aw}}function aa(au,ay){function ax(aA,az){return function(aB){X(aB,aj);X(v(aB),ah);var aC=(aA?A:Z)(aB);(az?e:aw)(this,aC.node,aC.offset)}}function e(aA,aC,aD){var aB=aA.endContainer,az=aA.endOffset;if(aC!==aA.startContainer||aD!==aA.startOffset){if(v(aC)!=v(aB)||ad(aC,aD,aB,az)==1){aB=aC;az=aD}ay(aA,aC,aD,aB,az)}}function aw(az,aA,aD){var aC=az.startContainer,aB=az.startOffset;if(aA!==az.endContainer||aD!==az.endOffset){if(v(aA)!=v(aC)||ad(aA,aD,aC,aB)==-1){aC=aA;aB=aD}ay(az,aC,aB,aA,aD)}}var av=function(){};av.prototype=j.rangePrototype;au.prototype=new av();r.extend(au.prototype,{setStart:function(az,aA){t(az,true);ai(az,aA);e(this,az,aA)},setEnd:function(az,aA){t(az,true);ai(az,aA);aw(this,az,aA)},setStartAndEnd:function(){var aB=arguments;var aD=aB[0],aC=aB[1],aA=aD,az=aC;switch(aB.length){case 3:az=aB[2];break;case 4:aA=aB[2];az=aB[3];break}ay(this,aD,aC,aA,az)},setBoundary:function(aA,aB,az){this["set"+(az?"Start":"End")](aA,aB)},setStartBefore:ax(true,true),setStartAfter:ax(false,true),setEndBefore:ax(true,false),setEndAfter:ax(false,false),collapse:function(az){i(this);if(az){ay(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset)}else{ay(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)}},selectNodeContents:function(az){t(az,true);ay(this,az,0,az,V(az))},selectNode:function(aA){t(aA,false);X(aA,aj);var aB=A(aA),az=Z(aA);ay(this,aB.node,aB.offset,az.node,az.offset)},extractContents:s(R,ay),deleteContents:s(o,ay),canSurroundContents:function(){i(this);af(this.startContainer);af(this.endContainer);var az=new g(this,true);var aA=(az._first&&x(az._first,this)||(az._last&&x(az._last,this)));az.detach();return !aA},splitBoundaries:function(){an(this)},splitBoundariesPreservingPositions:function(az){an(this,az)},normalizeBoundaries:function(){i(this);var aG=this.startContainer,aB=this.startOffset,aF=this.endContainer,az=this.endOffset;var aC=function(aJ){var aI=aJ.nextSibling;if(aI&&aI.nodeType==aJ.nodeType){aF=aJ;az=aJ.length;aJ.appendData(aI.data);aI.parentNode.removeChild(aI)}};var aH=function(aK){var aJ=aK.previousSibling;if(aJ&&aJ.nodeType==aK.nodeType){aG=aK;var aI=aK.length;aB=aJ.length;aK.insertData(0,aJ.data);aJ.parentNode.removeChild(aJ);if(aG==aF){az+=aB;aF=aG}else{if(aF==aK.parentNode){var aL=B(aK);if(az==aL){aF=aK;az=aI}else{if(az>aL){az--}}}}}};var aE=true;if(h(aF)){if(aF.length==az){aC(aF)}}else{if(az>0){var aD=aF.childNodes[az-1];if(aD&&h(aD)){aC(aD)}}aE=!this.collapsed}if(aE){if(h(aG)){if(aB==0){aH(aG)}}else{if(aB<aG.childNodes.length){var aA=aG.childNodes[aB];if(aA&&h(aA)){aH(aA)}}}}else{aG=aF;aB=az}ay(this,aG,aB,aF,az)},collapseToPoint:function(az,aA){t(az,true);ai(az,aA);this.setStartAndEnd(az,aA)}});G(au)}function O(e){e.collapsed=(e.startContainer===e.endContainer&&e.startOffset===e.endOffset);e.commonAncestorContainer=e.collapsed?e.startContainer:c.getCommonAncestor(e.startContainer,e.endContainer)}function D(au,aw,e,ax,av){au.startContainer=aw;au.startOffset=e;au.endContainer=ax;au.endOffset=av;au.document=c.getDocument(aw);O(au)}function ao(e){this.startContainer=e;this.startOffset=0;this.endContainer=e;this.endOffset=0;this.document=e;O(this)}aa(ao,D);r.extend(ao,{rangeProperties:M,RangeIterator:g,copyComparisonConstants:G,createPrototypeRange:aa,inspect:z,getRangeDocument:n,rangesEqual:function(au,e){return au.startContainer===e.startContainer&&au.startOffset===e.startOffset&&au.endContainer===e.endContainer&&au.endOffset===e.endOffset}});j.DomRange=ao});rangy.createCoreModule("WrappedRange",["DomRange"],function(m,e){var a,b;var i=m.dom;var j=m.util;var d=i.DomPosition;var n=m.DomRange;var k=i.getBody;var p=i.getContentDocument;var l=i.isCharacterDataNode;if(m.features.implementsDomRange){(function(){var t;var A=n.rangeProperties;function q(C){var D=A.length,E;while(D--){E=A[D];C[E]=C.nativeRange[E]}C.collapsed=(C.startContainer===C.endContainer&&C.startOffset===C.endOffset)}function v(E,H,D,I,F){var C=(E.startContainer!==H||E.startOffset!=D);var J=(E.endContainer!==I||E.endOffset!=F);var G=!E.equals(E.nativeRange);if(C||J||G){E.setEnd(I,F);E.setStart(H,D)}}var s;a=function(C){if(!C){throw e.createError("WrappedRange: Range must be specified")}this.nativeRange=C;q(this)};n.createPrototypeRange(a,v);t=a.prototype;t.selectNode=function(C){this.nativeRange.selectNode(C);q(this)};t.cloneContents=function(){return this.nativeRange.cloneContents()};t.surroundContents=function(C){this.nativeRange.surroundContents(C);q(this)};t.collapse=function(C){this.nativeRange.collapse(C);q(this)};t.cloneRange=function(){return new a(this.nativeRange.cloneRange())};t.refresh=function(){q(this)};t.toString=function(){return this.nativeRange.toString()};var z=document.createTextNode("test");k(document).appendChild(z);var w=document.createRange();w.setStart(z,0);w.setEnd(z,0);try{w.setStart(z,1);t.setStart=function(C,D){this.nativeRange.setStart(C,D);q(this)};t.setEnd=function(C,D){this.nativeRange.setEnd(C,D);q(this)};s=function(C){return function(D){this.nativeRange[C](D);q(this)}}}catch(y){t.setStart=function(D,E){try{this.nativeRange.setStart(D,E)}catch(C){this.nativeRange.setEnd(D,E);this.nativeRange.setStart(D,E)}q(this)};t.setEnd=function(D,E){try{this.nativeRange.setEnd(D,E)}catch(C){this.nativeRange.setStart(D,E);this.nativeRange.setEnd(D,E)}q(this)};s=function(C,D){return function(F){try{this.nativeRange[C](F)}catch(E){this.nativeRange[D](F);this.nativeRange[C](F)}q(this)}}}t.setStartBefore=s("setStartBefore","setEndBefore");t.setStartAfter=s("setStartAfter","setEndAfter");t.setEndBefore=s("setEndBefore","setStartBefore");t.setEndAfter=s("setEndAfter","setStartAfter");t.selectNodeContents=function(C){this.setStartAndEnd(C,0,i.getNodeLength(C))};w.selectNodeContents(z);w.setEnd(z,3);var B=document.createRange();B.selectNodeContents(z);B.setEnd(z,4);B.setStart(z,2);if(w.compareBoundaryPoints(w.START_TO_END,B)==-1&&w.compareBoundaryPoints(w.END_TO_START,B)==1){t.compareBoundaryPoints=function(D,C){C=C.nativeRange||C;if(D==C.START_TO_END){D=C.END_TO_START}else{if(D==C.END_TO_START){D=C.START_TO_END}}return this.nativeRange.compareBoundaryPoints(D,C)}}else{t.compareBoundaryPoints=function(D,C){return this.nativeRange.compareBoundaryPoints(D,C.nativeRange||C)}}var r=document.createElement("div");r.innerHTML="123";var u=r.firstChild;var x=k(document);x.appendChild(r);w.setStart(u,1);w.setEnd(u,2);w.deleteContents();if(u.data=="13"){t.deleteContents=function(){this.nativeRange.deleteContents();q(this)};t.extractContents=function(){var C=this.nativeRange.extractContents();q(this);return C}}else{}x.removeChild(r);x=null;if(j.isHostMethod(w,"createContextualFragment")){t.createContextualFragment=function(C){return this.nativeRange.createContextualFragment(C)}}k(document).removeChild(z);t.getName=function(){return"WrappedRange"};m.WrappedRange=a;m.createNativeRange=function(C){C=p(C,e,"createNativeRange");return C.createRange()}})()}if(m.features.implementsTextRange){var f=function(v){var t=v.parentElement();var r=v.duplicate();r.collapse(true);var u=r.parentElement();r=v.duplicate();r.collapse(false);var s=r.parentElement();var q=(u==s)?u:i.getCommonAncestor(u,s);return q==t?q:i.getCommonAncestor(t,q)};var c=function(q){return q.compareEndPoints("StartToEnd",q)==0};var g=function(q,C,A,r,u){var D=q.duplicate();D.collapse(A);var s=D.parentElement();if(!i.isOrIsAncestorOf(C,s)){s=C}if(!s.canHaveHTML){var z=new d(s.parentNode,i.getNodeIndex(s));return{boundaryPosition:z,nodeInfo:{nodeIndex:z.offset,containerElement:z.node}}}var t=i.getDocument(s).createElement("span");if(t.parentNode){t.parentNode.removeChild(t)}var L,J=A?"StartToStart":"StartToEnd";var E,v,B,F;var x=(u&&u.containerElement==s)?u.nodeIndex:0;var G=s.childNodes.length;var w=G;var I=w;while(true){if(I==G){s.appendChild(t)}else{s.insertBefore(t,s.childNodes[I])}D.moveToElementText(t);L=D.compareEndPoints(J,q);if(L==0||x==w){break}else{if(L==-1){if(w==x+1){break}else{x=I}}else{w=(w==x+1)?x:I}}I=Math.floor((x+w)/2);s.removeChild(t)}F=t.nextSibling;if(L==-1&&F&&l(F)){D.setEndPoint(A?"EndToStart":"EndToEnd",q);var y;if(/[\r\n]/.test(F.data)){var H=D.duplicate();var K=H.text.replace(/\r\n/g,"\r").length;y=H.moveStart("character",K);while((L=H.compareEndPoints("StartToEnd",H))==-1){y++;H.moveStart("character",1)}}else{y=D.text.length}B=new d(F,y)}else{E=(r||!A)&&t.previousSibling;v=(r||A)&&t.nextSibling;if(v&&l(v)){B=new d(v,0)}else{if(E&&l(E)){B=new d(E,E.data.length)}else{B=new d(s,i.getNodeIndex(t))}}}t.parentNode.removeChild(t);return{boundaryPosition:B,nodeInfo:{nodeIndex:I,containerElement:s}}};var o=function(q,s){var t,w,u=q.offset;var x=i.getDocument(q.node);var r,y,z=k(x).createTextRange();var v=l(q.node);if(v){t=q.node;w=t.parentNode}else{y=q.node.childNodes;t=(u<y.length)?y[u]:null;w=q.node}r=x.createElement("span");r.innerHTML="&#feff;";if(t){w.insertBefore(r,t)}else{w.appendChild(r)}z.moveToElementText(r);z.collapse(!s);w.removeChild(r);if(v){z[s?"moveStart":"moveEnd"]("character",u)}return z};b=function(q){this.textRange=q;this.refresh()};b.prototype=new n(document);b.prototype.refresh=function(){var t,q,s;var r=f(this.textRange);if(c(this.textRange)){q=t=g(this.textRange,r,true,true).boundaryPosition}else{s=g(this.textRange,r,true,false);t=s.boundaryPosition;q=g(this.textRange,r,false,false,s.nodeInfo).boundaryPosition}this.setStart(t.node,t.offset);this.setEnd(q.node,q.offset)};b.prototype.getName=function(){return"WrappedTextRange"};n.copyComparisonConstants(b);b.rangeToTextRange=function(q){if(q.collapsed){return o(new d(q.startContainer,q.startOffset),true)}else{var t=o(new d(q.startContainer,q.startOffset),true);var s=o(new d(q.endContainer,q.endOffset),false);var r=k(n.getRangeDocument(q)).createTextRange();r.setEndPoint("StartToStart",t);r.setEndPoint("EndToEnd",s);return r}};m.WrappedTextRange=b;if(!m.features.implementsDomRange||m.config.preferTextRange){var h=(function(){return this})();if(typeof h.Range=="undefined"){h.Range=b}m.createNativeRange=function(q){q=p(q,e,"createNativeRange");return k(q).createTextRange()};m.WrappedRange=b}}m.createRange=function(q){q=p(q,e,"createRange");return new m.WrappedRange(m.createNativeRange(q))};m.createRangyRange=function(q){q=p(q,e,"createRangyRange");return new n(q)};m.createIframeRange=function(q){e.deprecationNotice("createIframeRange()","createRange(iframeEl)");return m.createRange(q)};m.createIframeRangyRange=function(q){e.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)");return m.createRangyRange(q)};m.addCreateMissingNativeApiListener(function(r){var q=r.document;if(typeof q.createRange=="undefined"){q.createRange=function(){return m.createRange(q)}}q=r=null})});rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(j,d){j.config.checkSelectionRanges=true;var I="boolean";var L="number";var c=j.dom;var o=j.util;var W=o.isHostMethod;var aa=j.DomRange;var f=j.WrappedRange;var V=j.DOMException;var D=c.DomPosition;var S;var q;var n=j.features;var ai="Control";var ah=c.getDocument;var ag=c.getBody;var N=aa.rangesEqual;function g(ak){return(typeof ak=="string")?/^backward(s)?$/i.test(ak):!!ak}function z(am,ak){if(!am){return window}else{if(c.isWindow(am)){return am}else{if(am instanceof F){return am.win}else{var al=c.getContentDocument(am,d,ak);return c.getWindow(al)}}}}function p(ak){return z(ak,"getWinSelection").getSelection()}function t(ak){return z(ak,"getDocSelection").document.selection}function af(ak){var al=false;if(ak.anchorNode){al=(c.comparePoints(ak.anchorNode,ak.anchorOffset,ak.focusNode,ak.focusOffset)==1)}return al}var ad=W(window,"getSelection"),U=o.isHostObject(document,"selection");n.implementsWinGetSelection=ad;n.implementsDocSelection=U;var w=U&&(!ad||j.config.preferTextRange);if(w){S=t;j.isSelectionValid=function(al){var am=z(al,"isSelectionValid").document,ak=am.selection;return(ak.type!="None"||ah(ak.createRange().parentElement())==am)}}else{if(ad){S=p;j.isSelectionValid=function(){return true}}else{d.fail("Neither document.selection or window.getSelection() detected.")}}j.getNativeSelection=S;var T=S();var G=j.createNativeRange(document);var H=ag(document);var Q=o.areHostProperties(T,["anchorNode","focusNode","anchorOffset","focusOffset"]);n.selectionHasAnchorAndFocus=Q;var s=W(T,"extend");n.selectionHasExtend=s;var aj=(typeof T.rangeCount==L);n.selectionHasRangeCount=aj;var Z=false;var X=true;var A=s?function(an,ak){var am=aa.getRangeDocument(ak);var al=j.createRange(am);al.collapseToPoint(ak.endContainer,ak.endOffset);an.addRange(P(al));an.extend(ak.startContainer,ak.startOffset)}:null;if(o.areHostMethods(T,["addRange","getRangeAt","removeAllRanges"])&&typeof T.rangeCount==L&&n.implementsDomRange){(function(){var al=window.getSelection();if(al){var ap=al.rangeCount;var ar=(ap>1);var au=[];var av=af(al);for(var aq=0;aq<ap;++aq){au[aq]=al.getRangeAt(aq)}var at=ag(document);var ao=at.appendChild(document.createElement("div"));ao.contentEditable="false";var an=ao.appendChild(document.createTextNode("\u00a0\u00a0\u00a0"));var am=document.createRange();am.setStart(an,1);am.collapse(true);al.addRange(am);X=(al.rangeCount==1);al.removeAllRanges();if(!ar){var ak=am.cloneRange();am.setStart(an,0);ak.setEnd(an,3);ak.setStart(an,2);al.addRange(am);al.addRange(ak);Z=(al.rangeCount==2);ak.detach()}at.removeChild(ao);al.removeAllRanges();for(aq=0;aq<ap;++aq){if(aq==0&&av){if(A){A(al,au[aq])}else{j.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend");al.addRange(au[aq])}}else{al.addRange(au[aq])}}}})()}n.selectionSupportsMultipleRanges=Z;n.collapsedNonEditableSelectionsSupported=X;var i=false,l;if(H&&W(H,"createControlRange")){l=H.createControlRange();if(o.areHostProperties(l,["item","add"])){i=true}}n.implementsControlRange=i;if(Q){q=function(ak){return ak.anchorNode===ak.focusNode&&ak.anchorOffset===ak.focusOffset}}else{q=function(ak){return ak.rangeCount?ak.getRangeAt(ak.rangeCount-1).collapsed:false}}function b(am,ak,an){var al=an?"end":"start",ao=an?"start":"end";am.anchorNode=ak[al+"Container"];am.anchorOffset=ak[al+"Offset"];am.focusNode=ak[ao+"Container"];am.focusOffset=ak[ao+"Offset"]}function y(al){var ak=al.nativeSelection;al.anchorNode=ak.anchorNode;al.anchorOffset=ak.anchorOffset;al.focusNode=ak.focusNode;al.focusOffset=ak.focusOffset}function M(ak){ak.anchorNode=ak.focusNode=null;ak.anchorOffset=ak.focusOffset=0;ak.rangeCount=0;ak.isCollapsed=true;ak._ranges.length=0}function P(ak){var al;if(ak instanceof aa){al=j.createNativeRange(ak.getDocument());al.setEnd(ak.endContainer,ak.endOffset);al.setStart(ak.startContainer,ak.startOffset)}else{if(ak instanceof f){al=ak.nativeRange}else{if(n.implementsDomRange&&(ak instanceof c.getWindow(ak.startContainer).Range)){al=ak}}}return al}function m(am){if(!am.length||am[0].nodeType!=1){return false}for(var al=1,ak=am.length;al<ak;++al){if(!c.isAncestorOf(am[0],am[al])){return false}}return true}function R(al){var ak=al.getNodes();if(!m(ak)){throw d.createError("getSingleElementFromRange: range "+al.inspect()+" did not consist of a single element")}return ak[0]}function K(ak){return !!ak&&typeof ak.text!="undefined"}function O(am,al){var ak=new f(al);am._ranges=[ak];b(am,ak,false);am.rangeCount=1;am.isCollapsed=ak.collapsed}function v(an){an._ranges.length=0;if(an.docSelection.type=="None"){M(an)}else{var am=an.docSelection.createRange();if(K(am)){O(an,am)}else{an.rangeCount=am.length;var ak,ao=ah(am.item(0));for(var al=0;al<an.rangeCount;++al){ak=j.createRange(ao);ak.selectNode(am.item(al));an._ranges.push(ak)}an.isCollapsed=an.rangeCount==1&&an._ranges[0].collapsed;b(an,an._ranges[an.rangeCount-1],false)}}}function C(al,ao){var am=al.docSelection.createRange();var ak=R(ao);var at=ah(am.item(0));var ap=ag(at).createControlRange();for(var an=0,aq=am.length;an<aq;++an){ap.add(am.item(an))}try{ap.add(ak)}catch(ar){throw d.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}ap.select();v(al)}var r;if(W(T,"getRangeAt")){r=function(am,ak){try{return am.getRangeAt(ak)}catch(al){return null}}}else{if(Q){r=function(al){var am=ah(al.anchorNode);var ak=j.createRange(am);ak.setStartAndEnd(al.anchorNode,al.anchorOffset,al.focusNode,al.focusOffset);if(ak.collapsed!==this.isCollapsed){ak.setStartAndEnd(al.focusNode,al.focusOffset,al.anchorNode,al.anchorOffset)}return ak}}}function F(ak,am,al){this.nativeSelection=ak;this.docSelection=am;this._ranges=[];this.win=al;this.refresh()}F.prototype=j.selectionPrototype;function B(ak){ak.win=ak.anchorNode=ak.focusNode=ak._ranges=null;ak.rangeCount=ak.anchorOffset=ak.focusOffset=0;ak.detached=true}var ae=[];function Y(ao,an){var ak=ae.length,al,am;while(ak--){al=ae[ak];am=al.selection;if(an=="deleteAll"){B(am)}else{if(al.win==ao){if(an=="delete"){ae.splice(ak,1);return true}else{return am}}}}if(an=="deleteAll"){ae.length=0}return null}var x=function(am){if(am&&am instanceof F){am.refresh();return am}am=z(am,"getNativeSelection");var al=Y(am);var ak=S(am),an=U?t(am):null;if(al){al.nativeSelection=ak;al.docSelection=an;al.refresh()}else{al=new F(ak,an,am);ae.push({win:am,selection:al})}return al};j.getSelection=x;j.getIframeSelection=function(ak){d.deprecationNotice("getIframeSelection()","getSelection(iframeEl)");return j.getSelection(c.getIframeWindow(ak))};var a=F.prototype;function k(aq,al){var ar=ah(al[0].startContainer);var ao=ag(ar).createControlRange();for(var an=0,ap,ak=al.length;an<ak;++an){ap=R(al[an]);try{ao.add(ap)}catch(am){throw d.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}ao.select();v(aq)}if(!w&&Q&&o.areHostMethods(T,["removeAllRanges","addRange"])){a.removeAllRanges=function(){this.nativeSelection.removeAllRanges();M(this)};var e=function(al,ak){A(al.nativeSelection,ak);al.refresh()};if(aj){a.addRange=function(ak,an){if(i&&U&&this.docSelection.type==ai){C(this,ak)}else{if(g(an)&&s){e(this,ak)}else{var al;if(Z){al=this.rangeCount}else{this.removeAllRanges();al=0}this.nativeSelection.addRange(P(ak).cloneRange());this.rangeCount=this.nativeSelection.rangeCount;if(this.rangeCount==al+1){if(j.config.checkSelectionRanges){var am=r(this.nativeSelection,this.rangeCount-1);if(am&&!N(am,ak)){ak=new f(am)}}this._ranges[this.rangeCount-1]=ak;b(this,ak,h(this.nativeSelection));this.isCollapsed=q(this)}else{this.refresh()}}}}}else{a.addRange=function(ak,al){if(g(al)&&s){e(this,ak)}else{this.nativeSelection.addRange(P(ak));this.refresh()}}}a.setRanges=function(al){if(i&&al.length>1){k(this,al)}else{this.removeAllRanges();for(var am=0,ak=al.length;am<ak;++am){this.addRange(al[am])}}}}else{if(W(T,"empty")&&W(G,"select")&&i&&w){a.removeAllRanges=function(){try{this.docSelection.empty();if(this.docSelection.type!="None"){var an;if(this.anchorNode){an=ah(this.anchorNode)}else{if(this.docSelection.type==ai){var al=this.docSelection.createRange();if(al.length){an=ah(al.item(0))}}}if(an){var am=ag(an).createTextRange();am.select();this.docSelection.empty()}}}catch(ak){}M(this)};a.addRange=function(ak){if(this.docSelection.type==ai){C(this,ak)}else{j.WrappedTextRange.rangeToTextRange(ak).select();this._ranges[0]=ak;this.rangeCount=1;this.isCollapsed=this._ranges[0].collapsed;b(this,ak,false)}};a.setRanges=function(ak){this.removeAllRanges();var al=ak.length;if(al>1){k(this,ak)}else{if(al){this.addRange(ak[0])}}}}else{d.fail("No means of selecting a Range or TextRange was found");return false}}a.getRangeAt=function(ak){if(ak<0||ak>=this.rangeCount){throw new V("INDEX_SIZE_ERR")}else{return this._ranges[ak].cloneRange()}};var J;if(w){J=function(al){var ak;if(j.isSelectionValid(al.win)){ak=al.docSelection.createRange()}else{ak=ag(al.win.document).createTextRange();ak.collapse(true)}if(al.docSelection.type==ai){v(al)}else{if(K(ak)){O(al,ak)}else{M(al)}}}}else{if(W(T,"getRangeAt")&&typeof T.rangeCount==L){J=function(am){if(i&&U&&am.docSelection.type==ai){v(am)}else{am._ranges.length=am.rangeCount=am.nativeSelection.rangeCount;if(am.rangeCount){for(var al=0,ak=am.rangeCount;al<ak;++al){am._ranges[al]=new j.WrappedRange(am.nativeSelection.getRangeAt(al))}b(am,am._ranges[am.rangeCount-1],h(am.nativeSelection));am.isCollapsed=q(am)}else{M(am)}}}}else{if(Q&&typeof T.isCollapsed==I&&typeof G.collapsed==I&&n.implementsDomRange){J=function(am){var ak,al=am.nativeSelection;if(al.anchorNode){ak=r(al,0);am._ranges=[ak];am.rangeCount=1;y(am);am.isCollapsed=q(am)}else{M(am)}}}else{d.fail("No means of obtaining a Range or TextRange from the user's selection was found");return false}}}a.refresh=function(al){var ak=al?this._ranges.slice(0):null;var an=this.anchorNode,ao=this.anchorOffset;J(this);if(al){var am=ak.length;if(am!=this._ranges.length){return true}if(this.anchorNode!=an||this.anchorOffset!=ao){return true}while(am--){if(!N(ak[am],this._ranges[am])){return true}}return false}};var E=function(ao,am){var al=ao.getAllRanges();ao.removeAllRanges();for(var an=0,ak=al.length;an<ak;++an){if(!N(am,al[an])){ao.addRange(al[an])}}if(!ao.rangeCount){M(ao)}};if(i){a.removeRange=function(ao){if(this.docSelection.type==ai){var am=this.docSelection.createRange();var ak=R(ao);var at=ah(am.item(0));var aq=ag(at).createControlRange();var al,ar=false;for(var an=0,ap=am.length;an<ap;++an){al=am.item(an);if(al!==ak||ar){aq.add(am.item(an))}else{ar=true}}aq.select();v(this)}else{E(this,ao)}}}else{a.removeRange=function(ak){E(this,ak)}}var h;if(!w&&Q&&n.implementsDomRange){h=af;a.isBackward=function(){return h(this)}}else{h=a.isBackward=function(){return false}}a.isBackwards=a.isBackward;a.toString=function(){var am=[];for(var al=0,ak=this.rangeCount;al<ak;++al){am[al]=""+this._ranges[al]}return am.join("")};function ab(al,ak){if(al.win.document!=ah(ak)){throw new V("WRONG_DOCUMENT_ERR")}}a.collapse=function(al,am){ab(this,al);var ak=j.createRange(al);ak.collapseToPoint(al,am);this.setSingleRange(ak);this.isCollapsed=true};a.collapseToStart=function(){if(this.rangeCount){var ak=this._ranges[0];this.collapse(ak.startContainer,ak.startOffset)}else{throw new V("INVALID_STATE_ERR")}};a.collapseToEnd=function(){if(this.rangeCount){var ak=this._ranges[this.rangeCount-1];this.collapse(ak.endContainer,ak.endOffset)}else{throw new V("INVALID_STATE_ERR")}};a.selectAllChildren=function(al){ab(this,al);var ak=j.createRange(al);ak.selectNodeContents(al);this.setSingleRange(ak)};a.deleteFromDocument=function(){if(i&&U&&this.docSelection.type==ai){var ao=this.docSelection.createRange();var an;while(ao.length){an=ao.item(0);ao.remove(an);an.parentNode.removeChild(an)}this.refresh()}else{if(this.rangeCount){var al=this.getAllRanges();if(al.length){this.removeAllRanges();for(var am=0,ak=al.length;am<ak;++am){al[am].deleteContents()}this.addRange(al[ak-1])}}}};a.eachRange=function(an,am){for(var al=0,ak=this._ranges.length;al<ak;++al){if(an(this.getRangeAt(al))){return am}}};a.getAllRanges=function(){var ak=[];this.eachRange(function(al){ak.push(al)});return ak};a.setSingleRange=function(ak,al){this.removeAllRanges();this.addRange(ak,al)};a.callMethodOnEachRange=function(ak,am){var al=[];this.eachRange(function(an){al.push(an[ak].apply(an,am))});return al};function ac(ak){return function(am,an){var al;if(this.rangeCount){al=this.getRangeAt(0);al["set"+(ak?"Start":"End")](am,an)}else{al=j.createRange(this.win.document);al.setStartAndEnd(am,an)}this.setSingleRange(al,this.isBackward())}}a.setStart=ac(true);a.setEnd=ac(false);j.rangePrototype.select=function(ak){x(this.getDocument()).setSingleRange(this,ak)};a.changeEachRange=function(al){var ak=[];var am=this.isBackward();this.eachRange(function(an){al(an);ak.push(an)});this.removeAllRanges();if(am&&ak.length==1){this.addRange(ak[0],"backward")}else{this.setRanges(ak)}};a.containsNode=function(al,ak){return this.eachRange(function(am){return am.containsNode(al,ak)},true)};a.getBookmark=function(ak){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[ak])}};a.moveToBookmark=function(ao){var ak=[];for(var an=0,am,al;am=ao.rangeBookmarks[an++];){al=j.createRange(this.win);al.moveToBookmark(am);ak.push(al)}if(ao.backward){this.setSingleRange(ak[0],"backward")}else{this.setRanges(ak)}};a.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")};function u(aq){var ap=[];var an=new D(aq.anchorNode,aq.anchorOffset);var al=new D(aq.focusNode,aq.focusOffset);var am=(typeof aq.getName=="function")?aq.getName():"Selection";if(typeof aq.rangeCount!="undefined"){for(var ao=0,ak=aq.rangeCount;ao<ak;++ao){ap[ao]=aa.inspect(aq.getRangeAt(ao))}}return"["+am+"(Ranges: "+ap.join(", ")+")(anchor: "+an.inspect()+", focus: "+al.inspect()+"]"}a.getName=function(){return"WrappedSelection"};a.inspect=function(){return u(this)};a.detach=function(){Y(this.win,"delete");B(this)};F.detachAll=function(){Y(null,"deleteAll")};F.inspect=u;F.isDirectionBackward=g;j.Selection=F;j.selectionPrototype=a;j.addCreateMissingNativeApiListener(function(ak){if(typeof ak.getSelection=="undefined"){ak.getSelection=function(){return x(ak)}}ak=null})});(function(b){var w=this,j,e;var g="br",s="p",o="insertType",n="deleteType",f=[{start:0,end:31},{start:33,end:40},{start:45,end:45},{start:91,end:93},{start:112,end:123},{start:144,end:145}];j={attributes:{changeId:"data-cid",userId:"data-userid",userName:"data-username",sessionId:"data-session-id",time:"data-time",lastTime:"data-last-change-time",changeData:"data-changedata"},attrValuePrefix:"",blockEl:"p",blockEls:["div","p","ol","ul","li","h1","h2","h3","h4","h5","h6","blockquote"],stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"ins",alias:"ins",action:"Inserted"},deleteType:{tag:"del",alias:"del",action:"Deleted"}},contentEditable:undefined,_isTracking:true,tooltips:false,tooltipsDelay:1,_isVisible:true,_changeData:null,_handleSelectAll:false,_sessionId:null};function l(z){if(!z){return true}var y,x=f.length,A;for(y=0;y<x;++y){A=f[y];if(z>=A.start&&z<=A.end){return true}}return false}e=function(y){y||(y={});if(!y.element){throw new Error("options.element must be defined for ice construction.")}this._changes={};this._userStyles={};this.currentUser={name:"",id:""};this._styles={};this._savedNodesMap={};this.$this=b(this);this._browser=ice.dom.browser();this._tooltipMouseOver=this._tooltipMouseOver.bind(this);this._tooltipMouseOut=this._tooltipMouseOut.bind(this);this._boundEventHandler=this.handleEvent.bind(this);ice.dom.extend(true,this,j,y);if(y.tooltips&&(!b.isFunction(y.hostMethods.showTooltip)||!b.isFunction(y.hostMethods.hideTooltip))){throw new Error("hostMethods.showTooltip and hostMethods.hideTooltip must be defined if tooltips is true")}var z=y.userStyles||{};for(var A in z){if(z.hasOwnProperty(A)){var x=z[A];if(!isNaN(x)){this._userStyles[A]=this.stylePrefix+"-"+x;this._uniqueStyleIndex=Math.max(x,this._uniqueStyleIndex);this._styles[x]=true}}}r=y.hostMethods.logError||function(){return undefined};this._insertSelector="."+this._getIceNodeClass(o);this._deleteSelector="."+this._getIceNodeClass(n);this._iceSelector=this._insertSelector+","+this._deleteSelector};e.prototype={_uniqueStyleIndex:0,_browserType:null,_batchChangeId:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:false,startTracking:function(x){if(typeof(this.contentEditable)=="boolean"){this.element.setAttribute("contentEditable",this.contentEditable)}this.initializeEnvironment();this.initializeEditor();this.initializeRange();this._updateTooltipsState();return this},stopTracking:function(y){this._isTracking=false;try{var x=this.element;if(x){x.removeEventListener("keyup",this._boundEventHandler,true);x.removeEventListener("keydown",this._boundEventHandler,true);x.removeEventListener("keypress",this._boundEventHandler,true)}if(!y&&(typeof(this.contentEditable)!=="undefined")){this.element.setAttribute("contentEditable",!this.contentEditable)}}catch(x){r(x,"While trying to stop tracking")}this._updateTooltipsState();return this},listenToEvents:function(){this.unlistenToEvents();if(this.element){this.element.addEventListener("keydown",this._boundEventHandler,true)}},unlistenToEvents:function(){if(this.element){this.element.removeEventListener("keydown",this._boundEventHandler,true)}},initializeEnvironment:function(){this.env||(this.env={});this.env.element=this.element;this.env.document=this.element.ownerDocument;this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window;this.env.frame=this.env.window.frameElement;this.env.selection=this.selection=new ice.Selection(this.env)},initializeRange:function(){},initializeEditor:function(){this._loadFromDom();this._updateTooltipsState()},isTracking:function(){return this._isTracking},enableChangeTracking:function(){this._isTracking=true},disableChangeTracking:function(){this._isTracking=false},toggleChangeTracking:function(x){x=(undefined===x)?!this._isTracking:!!x;this._isTracking=x},setCurrentUser:function(C){var z={};C=C||{};z.name=C.name?String(C.name):"";if(C.id!==undefined&&C.id!==null){z.id=String(C.id)}else{z.id=""}this.currentUser=z;for(var B in this._changes){var D=this._changes[B];if(D.userid==z.id){D.username=z.name}}var y=this.getIceNodes(),A,x=this.attributes.userId;y.each((function(E,F){A=F.getAttribute(x);if(A===null||A===z.id){F.setAttribute(this.attributes.userName,z.name)}}).bind(this))},setSessionId:function(x){this._sessionId=x},toggleTooltips:function(x){x=(undefined===x)?!this.tooltips:Boolean(x);this.tooltips=x;this._updateTooltipsState()},visible:function(x){if(x.nodeType===ice.dom.TEXT_NODE){x=x.parentNode}var y=x.getBoundingClientRect();return(y.top>0&&y.left>0)},_createIceNode:function(x,y,A){var z=this.env.document.createElement(this.changeTypes[x].tag);z.setAttribute("class",this._getIceNodeClass(x));if(y){z.appendChild(y)}this._addChange(x,[z],A);return z},insert:function(F){this.hostMethods.beforeInsert&&this.hostMethods.beforeInsert();var z=this.getCurrentRange(),A=this._isRangeInElement(z,this.element),y=A?null:this.hostMethods.getHostRange(),E=this._startBatchChange(),D=!!(A&&!A.collapsed),C=false;F=F||{};try{if(D){this._deleteContents(false,A);A=this.getCurrentRange()}if(A||y){var x=F.nodes;if(x&&!b.isArray(x)){x=[x]}this._moveRangeToValidTrackingPos(A,y);C=this._insertNodes(A,y,{nodes:x,text:F.text,insertStubText:F.insertStubText!==false})}}catch(B){r(B,"while trying to insert nodes")}finally{this._endBatchChange(E)}return C},_deleteContents:function(A,y){var x=true,z=this._browser;this.hostMethods.beforeDelete&&this.hostMethods.beforeDelete();if(y){this.selection.addRange(y)}else{y=this.getCurrentRange()}var D=this._startBatchChange();try{if(y.collapsed===false){y=this._deleteSelection(y);if(y&&!this.visible(y.endContainer)){y.setEnd(y.endContainer,Math.max(0,y.endOffset-1));y.collapse(false)}}else{this._cleanupSelection(y,false,true);if(this._isCurrentUserIceNode(this._getIceNode(y.startContainer,o))){return false}if(A){if(z.type==="mozilla"){x=this._deleteRight(y);if(!this.visible(y.endContainer)){if(y.endContainer.parentNode.nextSibling){y.setEndBefore(y.endContainer.parentNode.nextSibling)}else{y.setEndAfter(y.endContainer)}y.collapse(false)}}else{if(y.endOffset===ice.dom.getNodeCharacterLength(y.endContainer)){var B=y.startContainer.nextSibling;if(ice.dom.is(B,this._deleteSelector)){while(B){if(ice.dom.is(B,this._deleteSelector)){B=B.nextSibling;continue}y.setStart(B,0);y.collapse(true);break}}}x=this._deleteRight(y);if(!this.visible(y.endContainer)){if(ice.dom.is(y.endContainer.parentNode,this._iceSelector)){y.setStartAfter(y.endContainer.parentNode);y.collapse(true)}}}}else{if(z.mozilla){x=this._deleteLeft(y);if(!this.visible(y.startContainer)){if(y.startContainer.parentNode.previousSibling){y.setEnd(y.startContainer.parentNode.previousSibling,0)}else{y.setEnd(y.startContainer.parentNode,0)}y.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(y.endContainer));y.collapse(false)}}else{if(!this.visible(y.startContainer)){if(y.endOffset===ice.dom.getNodeCharacterLength(y.endContainer)){var C=y.startContainer.previousSibling;if(ice.dom.is(C,this._deleteSelector)){while(C){if(ice.dom.is(C,this._deleteSelector)){C=C.prevSibling;continue}y.setEndBefore(C.nextSibling,0);y.collapse(false);break}}}}x=this._deleteLeft(y)}}}y&&this.selection.addRange(y)}finally{this._endBatchChange(D)}return x},getChanges:function(){return this._changes},getChangeUserids:function(){var y=this,z=Object.keys(this._changes),x=z.map(function(A){return y._changes[z[A]].userid});return x.sort().filter(function(C,B,A){if(B===A.indexOf(C)){return 1}return 0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(x,A,y){var z=this.getCleanDOM(x,{callback:A,prepare:y,clone:true});return(z&&z.innerHTML)||""},getCleanDOM:function(x,z){var A="",y=this;z=z||{};ice.dom.each(this.changeTypes,function(C,B){if(C!==n){if(B>0){A+=","}A+="."+y._getIceNodeClass(C)}});if(x){if(typeof x==="string"){x=ice.dom.create("<div>"+x+"</div>")}else{if(z.clone){x=ice.dom.cloneNode(x,false)[0]}}}else{x=z.clone?ice.dom.cloneNode(this.element,false)[0]:this.element}return this._cleanBody(x,A,z)},_cleanBody:function(x,B,y){x=y.prepare?y.prepare.call(this,x):x;var z=ice.dom.find(x,B);ice.dom.each(z,function(C,D){while(D.firstChild){D.parentNode.insertBefore(D.firstChild,D)}D.parentNode.removeChild(D)});var A=ice.dom.find(x,this._deleteSelector);ice.dom.remove(A);x=y.callback?y.callback.call(this,x):x;return x},acceptAll:function(x){if(x){return this._acceptRejectSome(x,true)}else{this.getCleanDOM(this.element,{clone:false});this._changes={};this._triggerChange()}},rejectAll:function(z){if(z){return this._acceptRejectSome(z,false)}else{var B=this._insertSelector,x=this._deleteSelector,A,y=this;ice.dom.find(this.element,B).each(function(C,D){y._removeNode(D)});ice.dom.each(ice.dom.find(this.element,x),function(C,D){A=ice.dom.contents(D);ice.dom.replaceWith(D,A);b.each(A,function(E,G){var F=G&&G.parentNode;y._normalizeNode(F)})});this._changes={};this._triggerChange()}},acceptChange:function(x){this.acceptRejectChange(x,true)},rejectChange:function(x){this.acceptRejectChange(x,false)},acceptRejectChange:function(H,G){var E,N,L,I,F,R,P,M=ice.dom,Q,D=this,B,K,J,x=this._userStyles,z,y=this.attributes.userId,O=this._getIceNodeClass(n),A=this._getIceNodeClass(o);if(!H){var C=this.getCurrentRange();if(!C||!C.collapsed){return}H=C.startContainer}E=I="."+O;N=F="."+A;if(!G){I=N;F=E}L=E+","+N;R=M.getNode(H,L);B=M.attr(R,this.attributes.changeId);P=M.find(this.element,I+"["+this.attributes.changeId+"="+B+"]");Q=P.length;P.each(function(T,S){D._removeNode(S)});P=M.find(this.element,F+"["+this.attributes.changeId+"="+B+"]");Q+=P.length;M.each(P,function(S,T){if(m(T)){return c(T)}z=T.getAttribute(y);J=z!==null?x[z]||"":"";K=ice.dom.contents(T);b(T).removeClass(A+" "+O+" "+J);M.replaceWith(T,K);b.each(K,function(V,Y){var U=ice.dom.TEXT_NODE==Y.nodeType&&Y.nodeValue;if(U){var X=false;while(U.indexOf("  ")>=0){X=true;U=U.replace("  "," \u00a0")}if(X){Y.nodeValue=U}}var W=Y&&Y.parentNode;D._normalizeNode(W)})});delete this._changes[B];if(Q>0){this._triggerChange()}},isInsideChange:function(z,y,x){try{return Boolean(this.currentChangeNode(z,y,x))}catch(A){r(A,"While testing if isInsideChange");return false}},getIceNodes:function(){var y=[];var x=this;ice.dom.each(this.changeTypes,function(z){y.push("."+x._getIceNodeClass(z))});y=y.join(",");return b(this.element).find(y)},_getIceNode:function(z,y){var x=this.changeTypes[y].tag+"."+this._getIceNodeClass(y);return ice.dom.getNode((z&&z.$)||z,x)},_isNodeOfChangeType:function(z,y){if(!z){return false}var x="."+this._getIceNodeClass(y);return ice.dom.is(z.$||z,x)},_isInsertNode:function(x){return this._isNodeOfChangeType(x,o)},_isDeleteNode:function(x){return this._isNodeOfChangeType(x,n)},_normalizeNode:function(x){return ice.dom.normalizeNode(x,this._browser.msie)},_moveRangeToValidTrackingPos:function(E,A){if(!(E=(A||E))){return}var x,y,C=-1,z,G=[],H,D,B=A?this.hostMethods.getHostNode:d,I=false;while(!I){y=E.startContainer;if(!y||G.indexOf(y)>=0){return}z=B(y);G.push(y);x=this._getVoidElement(z);if(x){if((x!==y)&&(G.indexOf(x)>=0)){return}G.push(x)}else{I=ice.dom.isTextContainer(z)}if(!I){if(-1==C){C=!q(B(E.startContainer),E.startOffset)}H=C?ice.dom.findPrevTextContainer(x||z,this.element):ice.dom.findNextTextContainer(x||z,this.element);D=H.node;if(A){D=this.hostMethods.makeHostElement(D)}try{if(C){E.setStart(D,H.offset)}else{E.setEnd(D,H.offset)}E.collapse(C)}catch(F){r(F,"While trying to move range to valid tracking position");break}}}},_isRangeInElement:function(x,y){var z=x&&x.startContainer;while(z){if(z==y){return x}z=z.parentNode}return null},_getVoidElement:function(y){try{var x=this._getIceNode(y,n);if(!x){if(3==y.nodeType&&y.nodeValue=="\u200B"){return y}}return x}catch(z){r(z,"While trying to get void element of",y);return null}},_cleanupSelection:function(y,x,A){var B;if(!y||!y.collapsed||!(B=y.startContainer)){return}if(x){B=this.hostMethods.getHostNode(B)}var z=B.nodeType;if(ice.dom.TEXT_NODE==z){return this._cleanupTextSelection(y,B,x,A)}else{return this._cleanupElementSelection(y,x)}},_cleanupTextSelection:function(y,D,x,C){this._cleanupAroundNode(D);if(C&&ice.dom.isEmptyTextNode(D)){var z=D.parentNode,B=ice.dom.getNodeIndex(D),A=x?this.hostMethods.makeHostElement:d;z.removeChild(D);B=Math.max(0,B);y.setStart(A(z),B);y.setEnd(A(z),B)}},_cleanupElementSelection:function(B,z){var x,D=false,F=z?this.hostMethods.getHostNode(B.startContainer):B.startContainer,A=F.childNodes.length;if(A<1){return}try{if(B.startOffset>0){x=F.childNodes[B.startOffset-1]}else{x=F.firstChild;D=true}if(!x){return}}catch(E){return}this._cleanupAroundNode(x,D);if(B.startOffset===0){return}var y=ice.dom.getNodeIndex(x)+1;if(ice.dom.isEmptyTextNode(x)){y=Math.max(0,y-1);F.removeChild(x)}if(F.childNodes.length!==A){var C=z?this.hostMethods.makeHostElement:d;B.setStart(C(F),y);B.setEnd(C(F),y)}},_cleanupAroundNode:function(A,B){var z=A.parentNode,x=A.nextSibling,y;while(x){if(ice.dom.isEmptyTextNode(x)){y=x;x=x.nextSibling;z.removeChild(y)}else{x=x.nextSibling}}x=A.previousSibling;while(x){if(ice.dom.isEmptyTextNode(x)){y=x;x=x.previousSibling;z.removeChild(y)}else{x=x.previousSibling}}if(B&&ice.dom.isEmptyTextNode(A)){z.removeChild(A)}},_isCurrentUserIceNode:function(y){var x=Boolean(y&&(ice.dom.attr(y,this.attributes.userId)===this.currentUser.id));if(x&&this._sessionId){x=ice.dom.attr(y,this.attributes.sessionId)===this._sessionId}return x},_getChangeTypeFromAlias:function(y){var z,x=null;for(z in this.changeTypes){if(this.changeTypes.hasOwnProperty(z)){if(this.changeTypes[z].alias==y){x=z}}}return x},_getIceNodeClass:function(x){return this.attrValuePrefix+this.changeTypes[x].alias},_getUserStyle:function(x){if(x===null||x===""||"undefined"==typeof x){return this.stylePrefix}var y=null;if(this._userStyles[x]){y=this._userStyles[x]}else{y=this._setUserStyle(x,this._getNewStyleId())}return y},_setUserStyle:function(x,z){var y=this.stylePrefix+"-"+z;if(!this._styles[z]){this._styles[z]=true}return this._userStyles[x]=y},_getNewStyleId:function(){var x=++this._uniqueStyleIndex;if(this._styles[x]){return this._getNewStyleId()}else{this._styles[x]=true;return x}},_addChange:function(A,C,z){var B=z||this._batchChangeId||this.getNewChangeId(),x=this;if(!this._changes[B]){var y=(new Date()).getTime();this._changes[B]={type:A,time:y,lastTime:y,sessionId:this._sessionId,userid:String(this.currentUser.id),username:this.currentUser.name,data:this._changeData||""};this._triggerChange()}ice.dom.foreach(C,function(D){x._addNodeToChange(B,C[D])});return B},_addNodeToChange:function(B,A){var C=this.getChange(B),y={};if(!A.getAttribute(this.attributes.changeId)){y[this.attributes.changeId]=B}var z=A.getAttribute(this.attributes.userId);if(!z){z=C.userid;y[this.attributes.userId]=z}if(z==C.userid){y[this.attributes.userName]=C.username}var x=A.getAttribute(this.attributes.changeData);if(null===x){y[this.attributes.changeData]=this._changeData||""}if(!A.getAttribute(this.attributes.time)){y[this.attributes.time]=C.time}if(!A.getAttribute(this.attributes.lastTime)){y[this.attributes.lastTime]=C.lastTime}if(C.sessionId&&!A.getAttribute(this.attributes.sessionId)){y[this.attributes.sessionId]=C.sessionId}if(!C.style){C.style=this._getUserStyle(C.userid)}b(A).attr(y).addClass(C.style);this._updateNodeTooltip(A)},getChange:function(x){return this._changes[x]||null},getNewChangeId:function(){var x=++this._uniqueIDIndex;if(this._changes[x]){x=this.getNewChangeId()}return x},_startBatchChange:function(){return this._batchChangeId?null:(this._batchChangeId=this.getNewChangeId())},getContentElement:function(){return this.element},_endBatchChange:function(x){if(x&&(x===this._batchChangeId)){this._batchChangeId=null;this._triggerChangeText()}},getCurrentRange:function(){try{return this.selection.getRangeAt(0)}catch(x){r(x,"While trying to get current range");return null}},_insertNodes:function(y,L,M){var J=L||y,V=M||{},R=J.startContainer,D=(R&&R.$)||R,S=L?this.hostMethods.makeHostElement:d,N=V.nodes,U=V.insertStubText!==false,I=V.text,P,Q,W=this.env.document,B=false;var K=this._getIceNode(D,o),A=this._isCurrentUserIceNode(K);this._cleanupSelection(J,Boolean(L),true);if(A){var E=N&&N[0],G=K.getAttribute(this.attributes.changeId);if(E){B=true;J.insertNode(S(E));var H=E.parentNode,T=E.nextSibling;Q=N.length;for(P=1;P<Q;++P){if(T){H.insertBefore(N[P],T)}else{H.appendChild(N[P])}}var F=N[Q-1];if(ice.dom.TEXT_NODE==F.nodeType){J.setEnd(F,(F.nodeValue&&F.nodeValue.length)||0)}else{J.setEndAfter(F)}J.collapse();if(L){this.hostMethods.setHostRange(L)}else{this.selection.addRange(J)}}else{t(null,J,W,U)}this._updateChangeTime(G)}else{var O=this._createIceNode(o);if(K){var x=K.childNodes.length;this._normalizeNode(K);if(x!==K.childNodes.length){if(L){L=J=this.hostMethods.getHostRange()}else{J.refresh()}}if(K){var C=(L&&this.hostMethods.getHostNode(L.endContainer))||J.endContainer;if((C.nodeType==3&&J.endOffset<J.endContainer.length)||(C!==K.lastChild)){K=this._splitNode(K,J.endContainer,J.endOffset)}}}if(K){J.setStartAfter(S(K));J.collapse(true)}J.insertNode(S(O));Q=(N&&N.length)||0;if(Q){B=true;for(P=0;P<Q;++P){O.appendChild(N[P])}J.setEndAfter(S(O.lastChild));J.collapse()}else{if(I){B=true;var z=W.createTextNode(I);O.appendChild(z);J.setEnd(z,1);J.collapse()}else{t(O,J,W,U)}}if(L){this.hostMethods.setHostRange(L)}else{this.selection.addRange(J)}}return B},_updateChangeTime:function(B){var A=this._changes[B];if(A){var z=(new Date()).getTime(),y=ice.dom.find(this.element,"["+this.attributes.changeId+"="+B+"]"),x=this.attributes.lastTime;A.lastTime=z;y.each(function(C,D){D.setAttribute(x,z)})}},_handleVoidEl:function(y,x){var z=y&&this._getVoidElement(y);if(z&&!this._getIceNode(z,n)){x.collapse(true);return true}return false},_deleteSelection:function(E){var F=new ice.Bookmark(this.env,E),x=ice.dom.getElementsBetween(F.start,F.end),G=[];for(var D=0;D<x.length;D++){var A=x[D];if(!A||!A.parentNode){continue}if(ice.dom.isBlockElement(A)){G.push(A);if(!ice.dom.canContainTextElement(A)){for(var B=0;B<A.childNodes.length;B++){x.push(A.childNodes[B])}continue}}if(ice.dom.isEmptyTextNode(A)){this._removeNode(A);continue}if(!this._getVoidElement(A)){if(A.nodeType!==ice.dom.TEXT_NODE){if(v(A)){this._addDeleteTrackingToBreak(A);continue}if(ice.dom.isStubElement(A)){this._addDeleteTracking(A,{range:null,moveLeft:true});continue}if(ice.dom.hasNoTextOrStubContent(A)){this._removeNode(A);continue}for(var C=0;C<A.childNodes.length;C++){var z=A.childNodes[C];x.push(z)}continue}var y=ice.dom.getBlockParent(A);this._addDeleteTracking(A,{range:null,moveLeft:true});if(ice.dom.hasNoTextOrStubContent(y)){ice.dom.remove(y)}}}F.selectBookmark();if(E=this.getCurrentRange()){E.collapse(true)}return E},_deleteRight:function(H){var y=ice.dom.isBlockElement(H.startContainer)&&H.startContainer||ice.dom.getBlockParent(H.startContainer,this.element)||null,J=y?(ice.dom.hasNoTextOrStubContent(y)):false,F=y&&ice.dom.getNextContentNode(y,this.element),K=F?(ice.dom.hasNoTextOrStubContent(F)):false,C=H.endContainer,B=H.endOffset,L,z=H.commonAncestorContainer,D,O=false;if(J){return false}if(v(z)){this._addDeleteTrackingToBreak(z,{range:H});return true}if(z.nodeType!==ice.dom.TEXT_NODE){if(B===0&&ice.dom.isBlockElement(z)&&(!ice.dom.canContainTextElement(z))){var N=z.firstElementChild;if(N){H.setStart(N,0);H.collapse();return this._deleteRight(H)}}if(z.childNodes.length>B){var I=z.childNodes[B];if(v(I)){this._addDeleteTrackingToBreak(I,{range:H});return true}H.setStart(z.childNodes[B],0);H.collapse(true);O=this._deleteRight(H);H.refresh();return O}else{D=ice.dom.getNextContentNode(z,this.element);if(D){if(v(D)){this._addDeleteTrackingToBreak(D,{range:H});return true}H.setEnd(D,0)}H.collapse();return this._deleteRight(H)}}try{H.moveEnd(ice.dom.CHARACTER_UNIT,1);H.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(M){}if(B===C.data.length&&(!ice.dom.hasNoTextOrStubContent(C))){D=ice.dom.getNextNode(C,this.element);if(!D){H.selectNodeContents(C);H.collapse();return false}if(v(D)){this._addDeleteTrackingToBreak(D,{range:H});return true}if(D.nodeType===ice.dom.TEXT_NODE){D=D.parentNode}if(!D.isContentEditable){O=this._addDeleteTracking(D,{range:null,moveLeft:false,merge:true});var A=this.env.document.createTextNode("");D.parentNode.insertBefore(A,D.nextSibling);H.selectNode(A);H.collapse(true);return O}if(this._handleVoidEl(D,H)){return true}if(ice.dom.isChildOf(D,y)&&ice.dom.isStubElement(D)){return this._addDeleteTracking(D,{range:H,moveLeft:false,merge:true})}}if(this._handleVoidEl(D,H)){return true}if(ice.dom.isOnBlockBoundary(H.startContainer,H.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(D,this.element),this.blockEl)){if(F!==ice.dom.getBlockParent(H.endContainer,this.element)){H.setEnd(F,0)}var G=ice.dom.getElementsBetween(H.startContainer,H.endContainer);for(L=0;L<G.length;L++){ice.dom.remove(G[L])}return ice.dom.mergeBlockWithSibling(H,ice.dom.getBlockParent(H.endContainer,this.element)||y)}else{if(K){ice.dom.remove(F);H.collapse(true);return true}H.setStart(F,0);H.collapse(true);return true}}var x=H.endContainer,E=k(x,H.endOffset,1);return this._addDeleteTracking(E,{range:H,moveLeft:false,merge:true})},_deleteLeft:function(F){var B=ice.dom.isBlockElement(F.startContainer)&&F.startContainer||ice.dom.getBlockParent(F.startContainer,this.element)||null,E=B?ice.dom.hasNoTextOrStubContent(B):false,y=B&&ice.dom.getPrevContentNode(B,this.element),A=y?ice.dom.hasNoTextOrStubContent(y):false,K=F.startContainer,z=F.startOffset,N=F.commonAncestorContainer,M,J;if(E){return false}if(v(N)){this._addDeleteTrackingToBreak(N,{range:F,moveLeft:true});return true}if(z===0||N.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(N)&&(!ice.dom.canContainTextElement(N))){if(z===0){var I=N.firstElementChild;if(I){F.setStart(I,0);F.collapse();return this._deleteLeft(F)}}else{var L=N.lastElementChild;if(L){M=F.getLastSelectableChild(L);if(M){F.setStart(M,M.data.length);F.collapse();return this._deleteLeft(F)}}}}if(z===0){J=ice.dom.getPrevContentNode(K,this.element)}else{J=N.childNodes[z-1]}if(!J){return false}if(ice.dom.is(J,this._iceSelector)&&J.childNodes.length>0&&J.lastChild){J=J.lastChild}if(v(J)){this._addDeleteTrackingToBreak(J,{range:F,moveLeft:true});return true}if(J.nodeType===ice.dom.TEXT_NODE){J=J.parentNode}if(!J.isContentEditable){var x=this._addDeleteTracking(J,{range:null,moveLeft:true,merge:true});var C=document.createTextNode("");J.parentNode.insertBefore(C,J);F.selectNode(C);F.collapse(true);return x}if(this._handleVoidEl(J,F)){return true}if(ice.dom.isStubElement(J)&&ice.dom.isChildOf(J,B)||!J.isContentEditable){this._addDeleteTracking(J,{range:F,moveLeft:true,merge:true});return true}if(ice.dom.isStubElement(J)){ice.dom.remove(J);F.collapse(true);return false}if(J!==B&&!ice.dom.isChildOf(J,B)){if(!ice.dom.canContainTextElement(J)){J=J.lastElementChild}if(J.lastChild&&J.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(J.lastChild)&&J.lastChild.tagName!=="BR"){F.setStartAfter(J.lastChild);F.collapse(true);return true}M=F.getLastSelectableChild(J);if(M&&!ice.dom.isOnBlockBoundary(F.startContainer,M,this.element)){F.selectNodeContents(M);F.collapse();return true}}}if(z===1&&!ice.dom.isBlockElement(N)&&F.startContainer.childNodes.length>1&&F.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&F.startContainer.childNodes[0].data.length===0){F.setStart(F.startContainer,0);return this._deleteLeft(F)}try{F.moveStart(ice.dom.CHARACTER_UNIT,-1);F.moveStart(ice.dom.CHARACTER_UNIT,1)}catch(H){}if(ice.dom.isOnBlockBoundary(F.startContainer,F.endContainer,this.element)){if(A){ice.dom.remove(y);F.collapse();return true}if(y&&y.lastChild&&ice.dom.isStubElement(y.lastChild)){F.setStartAfter(y.lastChild);F.collapse(true);return true}M=F.getLastSelectableChild(y);if(M){F.setStart(M,M.data.length);F.collapse(true)}else{if(y){F.setStart(y,y.childNodes.length);F.collapse(true)}}return true}var D=F.startContainer;if(D&&(D.nodeType===ice.dom.TEXT_NODE)){var G=k(D,F.startOffset-1,1);this._addDeleteTracking(G,{range:F,moveLeft:true,merge:true});return true}return false},_removeNode:function(y){var x=y&&y.parentNode;if(x){x.removeChild(y);if(x!==this.element&&ice.dom.hasNoTextOrStubContent(x)){this._removeNode(x)}}},_addDeleteTracking:function(A,G){var C=G&&G.moveLeft;var D=this._getIceNode(A,o),E;if(D){return this._addDeletionInInsertNode(A,D,G)}var B=G&&G.range;if(B&&this._getIceNode(A,n)){return this._deleteInDeleted(A,G)}if(A.previousSibling&&ice.dom.isEmptyTextNode(A.previousSibling)){A.parentNode.removeChild(A.previousSibling)}if(A.nextSibling&&ice.dom.isEmptyTextNode(A.nextSibling)){A.parentNode.removeChild(A.nextSibling)}var y=this._getIceNode(A.previousSibling,n),F=this._getIceNode(A.nextSibling,n);if(y&&this._isCurrentUserIceNode(y)){E=y;E.appendChild(A);if(F&&this._isCurrentUserIceNode(F)){var z=ice.dom.extractContent(F);ice.dom.append(E,z);F.parentNode.removeChild(F)}}else{if(F&&this._isCurrentUserIceNode(F)){E=F;E.insertBefore(A,E.firstChild)}else{var x=this.getAdjacentChangeId(A,C);E=this._createIceNode(n,null,x);A.parentNode.insertBefore(E,A);E.appendChild(A)}}if(B){if(ice.dom.isStubElement(A)){B.selectNode(A)}else{B.selectNodeContents(A)}if(C){B.collapse(true)}else{B.collapse()}}if(E){this._normalizeNode(E);B&&B.refresh()}return true},_addDeleteTrackingToBreak:function(B,y){var A=Boolean(y&&y.moveLeft);function x(){var D=y&&y.range;if(D){if(v(B)||ice.dom.hasNoTextOrStubContent(B)||A){if(A){D.setStartBefore(B);D.setEndBefore(B)}else{D.setStartAfter(B);D.setEndAfter(B)}}else{if(B.firstChild){D.setStartBefore(B.firstChild);D.setEndBefore(B.firstChild)}}D.collapse()}}if(!v(B)){r("addDeleteTracking to BR: not a break element");return}if(this._isDeleteNode(B)){return x()}c(B);var z=n;ice.dom.addClass(B,this._getIceNodeClass(z));var C=this.getAdjacentChangeId(B,A);this._addChange(z,[B],C);x()},_deleteInDeleted:function(z,F){var A=F.range,B=F.moveLeft,D;this._normalizeNode(z);var E=false;if(B){var x=ice.dom.getPrevContentNode(z,this.element);while(!E){D=this._getIceNode(x,n);if(!D){E=true}else{x=ice.dom.getPrevContentNode(x,this.element)}}if(x){var C=A.getLastSelectableChild(x);if(C){x=C}A.setStart(x,ice.dom.getNodeCharacterLength(x));A.collapse(true)}}else{var y=ice.dom.getNextContentNode(z,this.element);while(!E){D=this._getIceNode(y,n);if(!D){E=true}else{y=ice.dom.getNextContentNode(y,this.element)}}if(y){A.selectNodeContents(y);A.collapse(true)}}return true},_addDeletionInInsertNode:function(z,C,H){var A=H&&H.range,B=H&&H.moveLeft;if(this._isCurrentUserIceNode(C)){if(A){if(B){A.setStartBefore(z)}else{A.setStartAfter(z)}A.collapse(B)}z.parentNode.removeChild(z);if(!this._browser.msie){this._normalizeNode(C)}var F=ice.dom.find(C,".iceBookmark").length,x;if(F>0){x=ice.dom.cloneNode(C);ice.dom.remove(ice.dom.find(x,".iceBookmark"));x=x[0]}else{x=C}if(ice.dom.hasNoTextOrStubContent(x)){if(A){A.setStartBefore(C);A.collapse(true)}ice.dom.replaceWith(C,ice.dom.contents(C))}}else{var y=rangy.dom.getNodeIndex(z),E=z.parentNode,D=E.childNodes.length,G;E.removeChild(z);G=this._createIceNode(n);G.appendChild(z);if(y>0&&y>=(D-1)){ice.dom.insertAfter(C,G)}else{if(y>0){this._splitNode(C,E,y)}C.parentNode.insertBefore(G,C)}this._deleteEmptyNode(C);if(A&&B){A.setStartBefore(G);A.collapse(true);this.selection.addRange(A)}if(H&&H.merge){this._mergeDeleteNode(G)}if(A){A.refresh()}}return true},_deleteEmptyNode:function(y){var x=y&&y.parentNode;if(x&&ice.dom.hasNoTextOrStubContent(y)){x.removeChild(y)}},_mergeDeleteNode:function(z){var y,x;if(this._isCurrentUserIceNode(y=this._getIceNode(z.previousSibling,n))){x=ice.dom.extractContent(z);z.parentNode.removeChild(z);ice.dom.append(y,x);this._mergeDeleteNode(y)}else{if(this._isCurrentUserIceNode(y=this._getIceNode(z.nextSibling,n))){x=ice.dom.extractContent(y);z.parentNode.removeChild(y);ice.dom.append(z,x);this._mergeDeleteNode(z)}}},handleEvent:function(y){if(!this._isTracking){return true}var x=false;if("keypress"==y.type){x=this.keyPress(y)}else{if("keydown"==y.type){x=!this.handleKeyDown(y)}}if(x){y.stopImmediatePropagation();y.preventDefault();this.hostMethods.notifyChange()}return !x},_handleAncillaryKey:function(B){var A=this._browser,z=false,y=this,x=y.getCurrentRange();switch(B){case ice.dom.DOM_VK_DELETE:z=this._deleteContents();break;case 46:z=this._deleteContents(true);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:if(A.type==="mozilla"){if(!this.visible(x.startContainer)){if(x.startContainer.parentNode.previousSibling){x.setEnd(x.startContainer.parentNode.previousSibling,0);x.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(x.endContainer));x.collapse(false)}else{x.setEnd(x.startContainer.parentNode.nextSibling,0);x.collapse(false)}}}z=false;break;case ice.dom.DOM_VK_RIGHT:if(A.type==="mozilla"){if(!this.visible(x.startContainer)){if(x.startContainer.parentNode.nextSibling){x.setStart(x.startContainer.parentNode.nextSibling,0);x.collapse(true)}}}break;default:break}return z},handleKeyDown:function(x){if(this._handleSpecialKey(x)){return true}return !this.keyPress(x)},onKeyDown:function(x){if(this._handleSpecialKey(x)){return false}return this._handleAncillaryKey(x)},keyPress:function(A){var C=null;if(A.ctrlKey||A.metaKey){return false}var x=this.getCurrentRange(),B,z=x&&ice.dom.parents(x.startContainer,"br")[0]||null;if(z){x.moveToNextEl(z)}var y=A.keyCode?A.keyCode:A.which;switch(y){case 32:return this.insert({text:" "});case ice.dom.DOM_VK_DELETE:case 46:case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:case ice.dom.DOM_VK_RIGHT:return this._handleAncillaryKey(y);case ice.dom.DOM_VK_ENTER:this._handleEnter();return false;default:if(l(y)){return false}C=String.fromCharCode(y);if(C){var B=this._browser.msie?{text:C}:null;return this.insert(B)}return false}},_handleEnter:function(){var x=this.getCurrentRange();if(x&&!x.collapsed){this._deleteContents()}},_handleSpecialKey:function(y){var x=y.which;if(x===null){x=y.keyCode}switch(x){case 120:case 88:if(true===y.ctrlKey||true===y.metaKey){this.prepareToCut();return true}break;case 67:case 99:if(true===y.ctrlKey||true===y.metaKey){this.prepareToCopy();return true}break;default:break}return false},currentChangeNode:function(z,x,y){var A=this._iceSelector,D=null;if(!z){D=this.getCurrentRange();if(!D){return false}if(y!==false&&D.collapsed){this._cleanupSelection(D,false,false);z=D.startContainer}else{z=D.commonAncestorContainer}}var E=x?ice.dom.is(z,A)&&z:ice.dom.getNode(z,A);if((!E)&&D&&D.collapsed){var C=D.endContainer,F=D.endOffset,B=null;if(C.nodeType===ice.dom.TEXT_NODE){if(F===C.length){B=ice.dom.getNextNode(C)}else{if(F===0){B=ice.dom.getPrevNode(C,this.element)}}}else{if(C.nodeType===ice.dom.ELEMENT_NODE){if(F===0){B=ice.dom.getPrevNode(C,this.element)}else{if(C.childNodes.length>F){C=C.childNodes[F-1];if(ice.dom.is(C,A)){return C}B=ice.dom.getNextNode(C)}}}}if(B){E=ice.dom.is(B,A)}}return E},setShowChanges:function(x){x=!!x;this._isVisible=x;var y=b(this.element);y.toggleClass("ICE-Tracking",x);this._showTitles(x);this._updateTooltipsState()},reload:function(){this._loadFromDom()},hasChanges:function(){for(var x in this._changes){var y=this._changes[x];if(y&&y.type){return true}}return false},countChanges:function(x){var y=this._filterChanges(x);return y.count},setChangeData:function(x){if(null==x||(typeof x=="undefined")){x=""}this._changeData=String(x)},getDeleteClass:function(){return this._getIceNodeClass(n)},prepareToCopy:function(){var x=this.getCurrentRange();if(x&&!x.collapsed){this._removeTrackingInRange(x)}},prepareToCut:function(){var A=this.getCurrentRange(),x=this.hostMethods.getHostRange();if(A&&x&&A.collapsed&&!x.collapsed){try{var z=this.hostMethods.getHostRangeData(x);A.setStart(z.startContainer,z.startOffset);A.setEnd(z.endContainer,z.endOffset)}catch(B){return}}if(!A||A.collapsed){return false}i(A,this.element);var F=A.cloneContents(),y=A.cloneRange(),E=F.firstChild,C=F.lastChild;this.hostMethods.beforeEdit();A.collapse(false);A.insertNode(F);A.setStartBefore(E);A.setEndAfter(C);var D=this._startBatchChange();try{this._deleteSelection(A)}catch(B){r(B,"While trying to delete selection")}finally{this._endBatchChange(D);this.selection.addRange(y);this._removeTrackingInRange(y,false)}return true},toString:function(){return"ICE "+((this.element&&this.element.id)||"(no element id)")},_splitNode:function(B,E,x){var A=B.parentNode,y=rangy.dom.getNodeIndex(B),D=E.ownerDocument,z=D.createRange(),C;z.setStart(A,y);z.setEnd(E,x);C=z.extractContents();A.insertBefore(C,B);if(this.isInsideChange(B,true)){this._updateNodeTooltip(B.previousSibling)}return B.previousSibling},_triggerChange:function(){if(this._isTracking){this.$this.trigger("change")}},_triggerChangeText:function(){this.$this.trigger("textChange")},_updateNodeTooltip:function(x){if(this.tooltips&&this._isVisible){this._addTooltip(x)}},_acceptRejectSome:function(z,x){var B=(function(D,E){this.acceptRejectChange(E,x)}).bind(this);var A=this._filterChanges(z);for(var C in A.changes){var y=ice.dom.find(this.element,"["+this.attributes.changeId+"="+C+"]");y.each(B)}if(A.count){this._triggerChange()}},_filterChanges:function(H){var B=0,E={},D,I=H||{},z=I.filter,A=I.exclude?b.map(I.exclude,function(J){return String(J)}):null,y=I.include?b.map(I.include,function(J){return String(J)}):null,C=I.verify,x=null;for(var G in this._changes){D=this._changes[G];if(D&&D.type){var F=(z&&!z({userid:D.userid,time:D.time,data:D.data}))||(A&&A.indexOf(D.userid)>=0)||(y&&y.indexOf(D.userid)<0);if(!F){if(C){x=ice.dom.find(this.element,"["+this.attributes.changeId+"]");F=!x.length}if(!F){++B;E[G]=D}}}}return{count:B,changes:E}},_loadFromDom:function(){this._changes={};this._uniqueStyleIndex=0;var C=this.currentUser&&this.currentUser.id,D=(this.currentUser&&this.currentUser.name)||"",z=(new Date()).getTime(),B,F=new RegExp(this.stylePrefix+"-(\\d+)"),x=[];for(var E in this.changeTypes){x.push(this._getIceNodeClass(E))}var y=this.getIceNodes();var A=function(L,H){var P=0,I,R="",L,G=H.className.split(" ");for(L=0;L<G.length;L++){B=F.exec(G[L]);if(B){I=B[0];P=B[1]}var S=new RegExp("("+x.join("|")+")").exec(G[L]);if(S){R=this._getChangeTypeFromAlias(S[1])}}var M=ice.dom.attr(H,this.attributes.userId);var Q;if(C&&(M==C)){Q=D;H.setAttribute(this.attributes.userName,D)}else{Q=H.getAttribute(this.attributes.userName)}this._setUserStyle(M,Number(P));var T=parseInt(ice.dom.attr(H,this.attributes.changeId)||"");if(isNaN(T)){T=this.getNewChangeId();H.setAttribute(this.attributes.changeId,T)}var J=parseInt(H.getAttribute(this.attributes.time)||"");if(isNaN(J)){J=z}var O=parseInt(H.getAttribute(this.attributes.lastTime)||"");if(isNaN(O)){O=J}var K=H.getAttribute(this.attributes.sessionId);var N=ice.dom.attr(H,this.attributes.changeData)||"";this._changes[T]={type:R,style:I,userid:String(M),username:Q,time:J,lastTime:O,sessionId:K,data:N};this._updateNodeTooltip(H)}.bind(this);y.each(A);this._triggerChange()},_showTitles:function(y){var x=this.getIceNodes();if(y){b(x).each((function(z,A){this._updateNodeTooltip(A)}).bind(this))}else{b(x).removeAttr("title")}},_updateTooltipsState:function(){var y,x=this;if(this.tooltips&&this._isVisible){if(!this._showingTips){this._showingTips=true;y=this.getIceNodes();y.each(function(z,A){x._addTooltip(A)})}}else{if(this._showingTips){this._showingTips=false;y=this.getIceNodes();y.each(function(z,A){b(A).unbind("mouseover").unbind("mouseout")})}}},_addTooltip:function(x){b(x).unbind("mouseover").unbind("mouseout").mouseover(this._tooltipMouseOver).mouseout(this._tooltipMouseOut)},_tooltipMouseOver:function(A){var z=A.currentTarget,y=b(z),B,x=this;if(A.buttons||y.data("_tooltip_t")){return}B=setTimeout(function(){var D=x.currentChangeNode(z),F=D&&D.getAttribute(x.attributes.changeId),E=F&&x.getChange(F);if(E){var C=ice.dom.hasClass(D,x._getIceNodeClass(o))?"insert":"delete";y.removeData("_tooltip_t");x.hostMethods.showTooltip(z,{userName:E.username,changeId:F,userId:E.userid,time:E.time,lastTime:E.lastTime,type:C})}},this.tooltipsDelay);y.data("_tooltip_t",B)},_tooltipMouseOut:function(z){var y=z.currentTarget,x=b(y),A=x.data("_tooltip_t");x.removeData("_tooltip_t");if(A){clearTimeout(A)}else{this.hostMethods.hideTooltip(y)}},_removeTrackingInRangeOld:function(z){var D=this._getIceNodeClass(o),y=this._getIceNodeClass(n),x="."+D+",."+y,A="data-ice-class",C=function(I){var H,G=null;if(I.nodeType==ice.dom.TEXT_NODE){G=b(I).parents(x)}else{var F=b(I);if(F.is(x)){G=F}else{G=F.parents(x)}}H=(G&&G[0]);if(H){var E=H.className;H.setAttribute(A,E);H.setAttribute("class","ice-no-decoration");return true}return false};z.getNodes(null,C);var B=this.element;setTimeout(function(){var E=b(B).find("["+A+"]");E.each(function(G,H){var F=H.getAttribute(A);if(F){H.setAttribute("class",F);H.removeAttribute(A)}})},10)},_removeTrackingInRange:function(D){var B=this._getIceNodeClass(o),x=this._getIceNodeClass(n),C="."+B+",."+x,E=this._savedNodesMap,F="data-ice-class",y=Date.now()%1000000,z=function(M){var J,L,I=null;if(M.nodeType==ice.dom.TEXT_NODE){I=b(M).parents(C)}else{J=b(M);if(J.is(C)){I=J}else{I=J.parents(C)}}if(L=(I&&I[0])){var K=u(L),G=L.className,H=String(y++);E[H]={attributes:K,className:G};h(L);L.setAttribute(F,H);L.setAttribute("class","ice-no-decoration");return true}return false};D.getNodes(null,z);var A=this.element;setTimeout(function(){var G=b(A).find("["+F+"]");G.each(function(J,K){var H=K.getAttribute(F),I=E[H];if(H){delete E[H];Object.keys(I.attributes).forEach(function(L){K.setAttribute(L,I.attributes[L])});K.setAttribute("class",I.className);K.removeAttribute(F)}else{r("missing save data for node")}})},10)},getAdjacentChangeId:function(z,A){var y=A?ice.dom.getNextNode(z):ice.dom.getPrevNode(z),x,B=null;x=this._getIceNode(y,o)||this._getIceNode(y,n);if(!x){if(this._isInsertNode(y)||this._isDeleteNode(y)){x=y}}if(x&&this._isCurrentUserIceNode(x)){B=ice.dom.attr(x,this.attributes.changeId)}return B}};var p=(window&&window.console)||{log:function(){},error:function(){},info:function(){},assert:function(){},count:function(){}};function u(C){var A=C.attributes,y,x=A&&A.length,z={};for(var B=0;B<x;++B){y=A[B];z[y.name]=y.value}return z}function h(z){var y=null,x;try{while(z.attributes.length>0){x=z.attributes[0];if(x===y){return}y=x;z.removeAttribute(x.name)}}catch(A){}}function d(x){return x}function c(y){var x=b.map(y.attributes,function(z){return z.name});b(y).removeClass();b.each(x,function(z,A){y.removeAttribute(A)})}function v(x){return g==ice.dom.getTagName(x)}function m(y){var x=ice.dom.getTagName(y);return g===x||s===x}function q(y,z){if(!y){return false}var x=y.nodeType;if(ice.dom.TEXT_NODE==x){return z&&y.nodeValue&&(z>=y.nodeValue.length-1)}if(ice.dom.ELEMENT_NODE==x){return y.childNodes&&y.childNodes.length&&(z>=y.childNodes.length)}return false}var r=null;function i(x,A){if(!x||!A||x.collapsed){return x}var z;try{while((z=x.endContainer)&&(z!==A)&&(x.endOffset==0)&&!x.collapsed){if(z.previousSibling){x.setEndBefore(z)}else{if(z.parentNode&&z.parentNode!==A){x.setEndBefore(z.parentNode)}}if(x.endContainer==z){break}}}catch(y){r(y,"fixSelection, while trying to set end")}try{while((z=x.startContainer)&&(z!==A)&&!x.collapsed){z=x.startContainer;if(z.nodeType==ice.dom.TEXT_NODE){if(x.startOffset>=z.nodeValue.length){x.setStartAfter(z)}}else{if(x.startOffset>=z.childNodes.length){x.setStartAfter(z)}}if(x.startContainer==z){break}}}catch(y){r(y,"fixSelection, while trying to set start")}}function k(B,x,A){var z=B.length,y;if(x<0||x>=z){return B}if(x+A>=z){A=z-x}if(A===z){return B}y=x>0?B.splitText(x):B;if(y.length>A){y.splitText(A)}return y}function t(A,y,B,z){if(z){if(y.collapsed&&y.startContainer&&y.startContainer.nodeType===ice.dom.TEXT_NODE&&y.startContainer.length){return}var x=B.createTextNode("\uFEFF");if(A){A.appendChild(x)}else{y.insertNode(x)}y.selectNode(x)}else{if(A){y.selectNodeContents(A)}}}function a(y,A){if(!y||!y.startContainer||!y.endContainer){return}var B=[];function x(E){if(!E){return""}E=E.replace("/\n/g","\\n").replace("/\r/g","").replace("\u200B","{filler}").replace("\uFEFF","{filler}");if(E.length<=15){return E}return E.substring(0,5)+"..."+E.substring(E.length-5)}function C(F){var G;if(F.nodeType===3){G="Text:"+x(F.nodeValue)}else{var E=F.innerText;G=F.nodeName+(E?"("+x(E)+")":"")}B.push("<"+G+" />")}function D(J,I,H){if("number"!==typeof H){H=-1}if(3==J.nodeType){var E=J.nodeValue;B.push(x(E.substring(0,I)));B.push("|");if(H>I){B.push(x(E.substring(I,H)));B.push("|");B.push(x(E.substring(H)))}else{B.push(x(E.substring(I)))}}else{if(1==J.nodeType){var G=0,F=J.childNodes,L=0;C(J);for(G=L;G<I;++G){C(F[G])}B.push("|");if(H>I){for(G=I;G<H;++G){C(F[G])}B.push("|")}if(H>0&&H<F.length){var K=F[H];while(K){C(K);K=K.nextSibling}}}}}if(y.startContainer===y.endContainer){D(y.startContainer,y.startOffset,y.endOffset)}else{D(y.startContainer,y.startOffset);D(y.endContainer,y.endOffset)}var z=B.join(" ");if(A){p.log(A+":"+z)}return z}w.ice=this.ice||{};this.ice.printRange=a;w.ice.InlineChangeEditor=e}).call(this,window.jQuery);(function(g){var e=this,c={},f=null,d=/^\s*$/,i=/^\d+$/;c.DOM_VK_DELETE=8;c.DOM_VK_LEFT=37;c.DOM_VK_UP=38;c.DOM_VK_RIGHT=39;c.DOM_VK_DOWN=40;c.DOM_VK_ENTER=13;c.ELEMENT_NODE=1;c.ATTRIBUTE_NODE=2;c.TEXT_NODE=3;c.CDATA_SECTION_NODE=4;c.ENTITY_REFERENCE_NODE=5;c.ENTITY_NODE=6;c.PROCESSING_INSTRUCTION_NODE=7;c.COMMENT_NODE=8;c.DOCUMENT_NODE=9;c.DOCUMENT_TYPE_NODE=10;c.DOCUMENT_FRAGMENT_NODE=11;c.NOTATION_NODE=12;c.CHARACTER_UNIT="character";c.WORD_UNIT="word";c.BREAK_ELEMENT="br";c.PARAGRAPH_ELEMENT="p";c.CONTENT_STUB_ELEMENTS=["img","hr","iframe","param","link","meta","input","frame","col","base","area"];c.BLOCK_ELEMENTS=["body","p","div","pre","ul","ol","li","table","tbody","td","th","fieldset","form","blockquote","dl","dt","dd","dir","center","address","h1","h2","h3","h4","h5","h6"];c.TEXT_CONTAINER_ELEMENTS=["body","p","div","pre","span","b","strong","i","li","td","th","blockquote","dt","dd","center","address","h1","h2","h3","h4","h5","h6","ins","del"];c.STUB_ELEMENTS=c.CONTENT_STUB_ELEMENTS.slice();c.STUB_ELEMENTS.push(c.BREAK_ELEMENT);var k=c.CONTENT_STUB_ELEMENTS.join(", ");function j(n){if(!n){return true}var l=n.length-1,m;while(l>=0){m=n[l--];if(m!=="\u200B"&&m!=="\uFEFF"){return false}}return true}c.getKeyChar=function(l){return String.fromCharCode(l.which)};c.getClass=function(n,m,l){if(!m){m=document.body}n="."+n.split(" ").join(".");if(l){n=l+n}return g.makeArray(g(m).find(n))};c.getId=function(m,l){if(!l){l=document}element=l.getElementById(m);return element};c.getTag=function(l,m){if(!m){m=document}return g.makeArray(g(m).find(l))};c.getElementWidth=function(l){return l.offsetWidth};c.getElementHeight=function(l){return l.offsetHeight};c.getElementDimensions=function(l){return{width:c.getElementWidth(l),height:c.getElementHeight(l)}};c.empty=function(l){if(l){return g(l).empty()}};c.remove=function(l){if(l){return g(l).remove()}};c.prepend=function(l,m){g(l).prepend(m)};c.append=function(l,m){g(l).append(m)};c.insertBefore=function(m,l){g(m).before(l)};c.insertAfter=function(o,n){if(o&&n){var m=o.nextSibling,l=o.parentNode;return m?l.insertBefore(n,m):l.appendChild(n)}};c.getHtml=function(l){return g(l).html()};c.setHtml=function(l,m){if(l){g(l).html(m)}};c.removeWhitespace=function(l){g(l).contents().filter(function(){if(this.nodeType!=ice.dom.TEXT_NODE&&this.nodeName=="UL"||this.nodeName=="OL"){c.removeWhitespace(this);return false}else{if(this.nodeType!=ice.dom.TEXT_NODE){return false}else{return !/\S/.test(this.nodeValue)}}}).remove()};c.contents=function(l){return g.makeArray(g(l).contents())};c.extractContent=function(l){var n=document.createDocumentFragment(),m;while((m=l.firstChild)){n.appendChild(m)}return n};c.getNode=function(m,l){if(!m){return null}m=m.$||m;return(m.nodeType!=c.TEXT_NODE&&c.is(m,l))?m:c.parents(m,l)[0]||null};c.getParents=function(r,o,q){var n=g(r).parents(o);var p=n.length;var l=[];for(var m=0;m<p;m++){if(n[m]===q){break}l.push(n[m])}return l};c.hasBlockChildren=function(m){var n=m.childNodes.length;for(var l=0;l<n;l++){if(m.childNodes[l].nodeType===c.ELEMENT_NODE){if(c.isBlockElement(m.childNodes[l])===true){return true}}}return false};c.removeTag=function(m,l){g(m).find(l).replaceWith(function(){return g(this).contents()});return m};c.stripEnclosingTags=function(l,n){var m=g(l);m.find("*").not(n).replaceWith(function(){var o=g();var q;try{q=g(this);o=q.contents()}catch(p){}if(o.length===0){q.remove()}return o});return m[0]};c.getSiblings=function(o,n,p,m){if(p===true){if(n==="prev"){return g(o).prevAll()}else{return g(o).nextAll()}}else{var l=[];if(n==="prev"){while(o.previousSibling){o=o.previousSibling;if(o===m){break}l.push(o)}}else{while(o.nextSibling){o=o.nextSibling;if(o===m){break}l.push(o)}}return l}};c.getNodeTextContent=function(l){return g(l).text()};c.getNodeStubContent=function(l){return g(l).find(k)};c.hasNoTextOrStubContent=function(l){var m=c.getNodeTextContent(l);if(!j(m)){return false}if(!l.firstChild){return true}return g(l).find(k).length===0};c.isEmptyTextNode=function(l){if(!l||(c.TEXT_NODE!==l.nodeType)){return false}if(l.length===0){return true}return j(l.nodeValue)};c.getNodeCharacterLength=function(l){return c.getNodeTextContent(l).length+g(l).find(c.STUB_ELEMENTS.join(", ")).length};c.setNodeTextContent=function(m,l){return g(m).text(l)};c.getTagName=function(l){return l&&l.tagName&&l.tagName.toLowerCase()||null};c.getIframeDocument=function(l){var m=null;if(l.contentDocument){m=l.contentDocument}else{if(l.contentWindow){m=l.contentWindow.document}else{if(l.document){m=l.document}}}return m};c.isBlockElement=function(l){return c.BLOCK_ELEMENTS.indexOf(l.nodeName.toLowerCase())!=-1};c.isStubElement=function(l){return c.STUB_ELEMENTS.indexOf(l.nodeName.toLowerCase())!=-1};c.removeBRFromChild=function(l){if(l&&l.hasChildNodes()){for(var m=0;m<l.childNodes.length;m++){var n=l.childNodes[m];if(n&&(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(n))){n.parentNode.removeChild(n)}}}};c.isChildOf=function(m,l){try{while(m&&m.parentNode){if(m.parentNode===l){return true}m=m.parentNode}}catch(n){}return false};c.isChildOfTagName=function(m,l){try{while(m&&m.parentNode){if(m.parentNode&&m.parentNode.tagName&&m.parentNode.tagName.toLowerCase()===l){return m.parentNode}m=m.parentNode}}catch(n){}return false};c.isChildOfTagNames=function(m,o){try{while(m&&m.parentNode){if(m.parentNode&&m.parentNode.tagName){tagName=m.parentNode.tagName.toLowerCase();for(var l=0;l<o.length;l++){if(tagName===o[l]){return m.parentNode}}}m=m.parentNode}}catch(n){}return null};c.isChildOfClassName=function(m,l){try{while(m&&m.parentNode){if(g(m.parentNode).hasClass(l)){return m.parentNode}m=m.parentNode}}catch(n){}return null};c.cloneNode=function(l,m){if(m===undefined){m=true}return g(l).clone(m)};c.bind=function(l,m,n){return g(l).bind(m,n)};c.unbind=function(l,m,n){return g(l).unbind(m,n)};c.attr=function(m,l,n){if(n){return g(m).attr(l,n)}else{return g(m).attr(l)}};c.replaceWith=function(m,l){return g(m).replaceWith(l)};c.removeAttr=function(m,l){g(m).removeAttr(l)};c.getElementsBetween=function(u,q){var l=[];if(u===q){return l}if(c.isChildOf(q,u)===true){var r=u.childNodes.length;for(var o=0;o<r;o++){if(u.childNodes[o]===q){break}else{if(c.isChildOf(q,u.childNodes[o])===true){return c.arrayMerge(l,c.getElementsBetween(u.childNodes[o],q))}else{l.push(u.childNodes[o])}}}return l}var n=u.nextSibling;while(n){if(c.isChildOf(q,n)===true){l=c.arrayMerge(l,c.getElementsBetween(n,q));return l}else{if(n===q){return l}else{l.push(n);n=n.nextSibling}}}var w=c.getParents(u);var s=c.getParents(q);var v=c.arrayDiff(w,s,true);var t=v.length;for(var m=0;m<(t-1);m++){l=c.arrayMerge(l,c.getSiblings(v[m],"next"))}var p=v[(v.length-1)];l=c.arrayMerge(l,c.getElementsBetween(p,q));return l};c.getCommonAncestor=function(m,l){var n=m;while(n){if(c.isChildOf(l,n)===true){return n}n=n.parentNode}return null};c.getNextNode=function(m,l){if(m){while(m.parentNode){if(m===l){return null}if(m.nextSibling){if(m.nextSibling.nodeType===c.TEXT_NODE&&m.nextSibling.length===0){m=m.nextSibling;continue}return c.getFirstChild(m.nextSibling)}m=m.parentNode}}return null};c.getNextContentNode=function(m,l){if(m){while(m.parentNode){if(m===l){return null}if(m.nextSibling&&c.canContainTextElement(c.getBlockParent(m))){if(m.nextSibling.nodeType===c.TEXT_NODE&&m.nextSibling.length===0){m=m.nextSibling;continue}return m.nextSibling}else{if(m.nextElementSibling){return m.nextElementSibling}}m=m.parentNode}}return null};c.getPrevNode=function(m,l){if(m){while(m.parentNode){if(m===l){return null}if(m.previousSibling){if(m.previousSibling.nodeType===c.TEXT_NODE&&m.previousSibling.length===0){m=m.previousSibling;continue}return c.getLastChild(m.previousSibling)}m=m.parentNode}}return null};c.getPrevContentNode=function(m,l){if(m){while(m.parentNode){if(m===l){return null}if(m.previousSibling&&c.canContainTextElement(c.getBlockParent(m))){if(m.previousSibling.nodeType===c.TEXT_NODE&&m.previousSibling.length===0){m=m.previousSibling;continue}return m.previousSibling}else{if(m.previousElementSibling){return m.previousElementSibling}}m=m.parentNode}}return null};function h(n,l){while(n){if(c.TEXT_NODE==n.nodeType){return n}for(var o=n.firstChild;o;o=o.nextSibling){var m=h(o,l);if(m){return m}}if(c.isTextContainer(n)){return n}n=n.nextSibling}return null}function a(n,l){while(n){if(c.TEXT_NODE==n.nodeType){return n}for(var o=n.lastChild;o;o=o.previousSibling){var m=a(o,l);if(m){return m}}if(c.isTextContainer(n)){return n}n=n.previousSibling}return null}c.findPrevTextContainer=function(n,l){if(!n||n==l){return{node:l,offset:0}}if(n.parentNode&&c.isTextContainer(n.parentNode)){return{node:n.parentNode,offset:c.getNodeIndex(n)}}while(n.previousSibling){var m=a(n.previousSibling);if(m){return{node:m,offset:c.getNodeLength(m)}}n=n.previousSibling}return c.findPrevTextContainer(n.parentNode&&n.parentNode.previousSibling,l)};c.findNextTextContainer=function(n,l){if(!n||n==l){return{node:l,offset:c.getNodeLength(l)}}if(n.parentNode&&c.isTextContainer(n.parentNode)){return{node:n.parentNode,offset:c.getNodeIndex(n)+1}}while(n.nextSibling){var m=h(n.nextSibling);if(m){return{node:m,offset:0}}n=n.previousSibling}return c.findNextTextContainer(n.parentNode&&n.parentNode.nextSibling,l)};c.getNodeLength=function(l){return l?(c.TEXT_NODE==l.nodeType?l.length:((l.childNodes&&l.childNodes.length)||0)):0};c.isTextContainer=function(l){return(l&&(c.TEXT_NODE==l.nodeType)||c.TEXT_CONTAINER_ELEMENTS.indexOf((l.nodeName||"").toLowerCase())>=0)};c.getNodeIndex=function(m){var l=0;while((m=m.previousSibling)){++l}return l};c.canContainTextElement=function(l){if(l&&l.nodeName){return c.TEXT_CONTAINER_ELEMENTS.lastIndexOf(l.nodeName.toLowerCase())!=-1}else{return false}};c.getFirstChild=function(l){if(l.firstChild){if(l.firstChild.nodeType===c.ELEMENT_NODE){return c.getFirstChild(l.firstChild)}else{return l.firstChild}}return l};c.getLastChild=function(l){if(l.lastChild){if(l.lastChild.nodeType===c.ELEMENT_NODE){return c.getLastChild(l.lastChild)}else{return l.lastChild}}return l};c.removeEmptyNodes=function(n,o){var l=g(n).find(":empty");var m=l.length;while(m>0){m--;if(c.isStubElement(l[m])===false){if(!o||o.call(this,l[m])!==false){c.remove(l[m])}}}};c.create=function(l){return g(l)[0]};c.find=function(l,m){return g(l).find(m)};c.children=function(l,m){return g(l).children(m)};c.parent=function(m,l){return g(m).parent(l)[0]};c.parents=function(m,l){return g(m).parents(l)};c.is=function(l,m){return g(l).is(m)};c.extend=function(l,o,n,m){return g.extend.apply(this,arguments)};c.walk=function(m,o,l){if(!m){return}if(!l){l=0}var n=o.call(this,m,l);if(n===false){return}if(m.childNodes&&m.childNodes.length>0){c.walk(m.firstChild,o,(l+1))}else{if(m.nextSibling){c.walk(m.nextSibling,o,l)}else{if(m.parentNode&&m.parentNode.nextSibling){c.walk(m.parentNode.nextSibling,o,(l-1))}}}};c.revWalk=function(l,n){if(!l){return}var m=n.call(this,l);if(m===false){return}if(l.childNodes&&l.childNodes.length>0){c.walk(l.lastChild,n)}else{if(l.previousSibling){c.walk(l.previousSibling,n)}else{if(l.parentNode&&l.parentNode.previousSibling){c.walk(l.parentNode.previousSibling,n)}}}};c.setStyle=function(l,n,m){if(l){g(l).css(n,m)}};c.getStyle=function(l,m){return g(l).css(m)};c.hasClass=function(l,m){return g(l).hasClass(m)};c.addClass=function(l,m){g(l).addClass(m)};c.removeClass=function(l,m){g(l).removeClass(m)};c.preventDefault=function(l){l.preventDefault();c.stopPropagation(l)};c.stopPropagation=function(l){l.stopPropagation()};c.each=function(l,m){g.each(l,function(n,o){m.call(this,n,o)})};c.foreach=function(p,m){var o,l;if(p instanceof Array||p instanceof NodeList||typeof p.length!="undefined"&&typeof p.item!="undefined"){l=p.length;for(var n=0;n<l;n++){o=m.call(this,n,p[n]);if(o===false){break}}}else{for(var q in p){if(p.hasOwnProperty(q)===true){o=m.call(this,q);if(o===false){break}}}}};c.isBlank=function(l){return(!l||d.test(l))};c.isFn=function(l){return(typeof l==="function")};c.isObj=function(l){return(l!==null&&typeof l==="object")};c.isset=function(l){return(typeof l!=="undefined"&&l!==null)};c.isArray=function(l){return g.isArray(l)};c.isNumeric=function(l){return l.match(i)!==null};c.getUniqueId=function(){var m=(new Date()).getTime();var l=Math.ceil(Math.random()*1000000);var n=m+""+l;return n.substr(5,18).replace(/,/,"")};c.inArray=function(o,m){var n=m.length;for(var l=0;l<n;l++){if(o===m[l]){return true}}return false};c.arrayDiff=function(p,o,n){var q=p.length,m,l=[];for(m=0;m<q;m++){if(c.inArray(p[m],o)===false){l.push(p[m])}}if(n!==true){q=o.length;for(m=0;m<q;m++){if(c.inArray(o[m],p)===false){l.push(o[m])}}}return l};c.arrayMerge=function(n,m){var o=m.length,l;for(l=0;l<o;l++){n.push(m[l])}return n};c.stripTags=function(n,q){if(typeof q==="string"){var p=g("<div>"+n+"</div>");p.find("*").not(q).remove();return p.html()}else{var l;var m=new RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim);var o=n;while((l=m.exec(n))!=null){if(c.isset(q)===false||c.inArray(l[1],q)!==true){o=o.replace(l[0],"")}}return o}};c.browser=function(){if(f){return g.extend({},f)}f=(function(){function m(q){q=q.toLowerCase();var p=/(chrome)[ \/]([\w.]+)/.exec(q)||/(webkit)[ \/]([\w.]+)/.exec(q)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(q)||/(msie) ([\w.]+)/.exec(q)||q.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(q)||[];return{browser:p[1]||"",version:p[2]||"0"}}var o=navigator.userAgent.toLowerCase(),l=m(o),n={type:"unknown",version:0,msie:false};if(l.browser){n[l.browser]=true;n.version=l.version||0;n.type=l.browser}if(n.chrome){n.webkit=true}else{if(n.webkit){n.safari=true}}if(n.webkit){n.type="webkit"}n.firefox=(/firefox/.test(o)==true);if(!n.msie){n.msie=Boolean(/trident/.test(o))}return n})();return g.extend({},f)};c.getBrowserType=function(){if(this._browserType===null){var n=["msie","firefox","chrome","safari"];var m=n.length;for(var l=0;l<m;l++){var o=new RegExp(n[l],"i");if(o.test(navigator.userAgent)===true){this._browserType=n[l];return this._browserType}}this._browserType="other"}return this._browserType};c.getWebkitType=function(){if(c.browser().type!=="webkit"){console.log("Not a webkit!");return false}var l=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;if(l){return"safari"}return"chrome"};c.isBrowser=function(l){return(c.browser().type===l)};c.getBlockParent=function(m,l){if(c.isBlockElement(m)===true){return m}if(m){while(m.parentNode){m=m.parentNode;if(c.isBlockElement(m)===true){return m}if(m===l){return null}}}return null};c.findNodeParent=function(n,l,m){if(n){while(n.parentNode){if(n===m){return null}if(c.is(n,l)===true){return n}n=n.parentNode}}return null};c.onBlockBoundary=function(o,m,n){if(!o||!m){return false}var l=c.isChildOfTagNames(o,n)||c.is(o,n.join(", "))&&o||null,p=c.isChildOfTagNames(m,n)||c.is(m,n.join(", "))&&m||null;return(l!==p)};c.isOnBlockBoundary=function(o,n,l){if(!o||!n){return false}var m=c.getBlockParent(o,l)||c.isBlockElement(o,l)&&o||null,p=c.getBlockParent(n,l)||c.isBlockElement(n,l)&&n||null;return(m!==p)};c.mergeContainers=function(m,l){if(!m||!l){return false}if(m.nodeType===c.TEXT_NODE||c.isStubElement(m)){l.appendChild(m)}else{if(m.nodeType===c.ELEMENT_NODE){while(m.firstChild){l.appendChild(m.firstChild)}c.remove(m)}}return true};c.mergeBlockWithSibling=function(l,o,n){var m=n?g(o).next().get(0):g(o).prev().get(0);if(n){c.mergeContainers(m,o)}else{c.mergeContainers(o,m)}l.collapse(true);return true};c.date=function(w,t,m){if(t===null&&m){t=c.tsIso8601ToTimestamp(m);if(!t){return}}var o=new Date(t);var v=w.split("");var n=v.length;var p="";for(var q=0;q<n;q++){var l="";var s=v[q];switch(s){case"D":case"l":var u=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];l=u[o.getDay()];if(s==="D"){l=l.substring(0,3)}break;case"F":case"m":l=o.getMonth()+1;if(l<10){l="0"+l}break;case"M":months=["January","February","March","April","May","June","July","August","September","October","November","December"];l=months[o.getMonth()];if(s==="M"){l=l.substring(0,3)}break;case"d":l=o.getDate();break;case"S":l=c.getOrdinalSuffix(o.getDate());break;case"Y":l=o.getFullYear();break;case"y":l=o.getFullYear();l=l.toString().substring(2);break;case"H":l=o.getHours();break;case"h":l=o.getHours();if(l===0){l=12}else{if(l>12){l-=12}}break;case"i":l=c.addNumberPadding(o.getMinutes());break;case"a":l="am";if(o.getHours()>=12){l="pm"}break;default:l=s;break}p+=l}return p};c.getOrdinalSuffix=function(m){var n="";var l=(m%100);if(l>=4&&l<=20){n="th"}else{switch(m%10){case 1:n="st";break;case 2:n="nd";break;case 3:n="rd";break;default:n="th";break}}return n};c.addNumberPadding=function(l){if(l<10){l="0"+l}return l};c.tsIso8601ToTimestamp=function(l){var n=/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/;var p=l.match(new RegExp(n));if(p){var m=new Date();m.setDate(p[3]);m.setFullYear(p[1]);m.setMonth(p[2]-1);m.setHours(p[4]);m.setMinutes(p[5]);m.setSeconds(p[6]);var o=(p[9]*60);if(p[8]==="+"){o*=-1}o-=m.getTimezoneOffset();return(m.getTime()+(o*60*1000))}return null};c.normalizeNode=function(m,l){if(!m){return}if(!c.browser().msie&&(l!==true&&"function"==typeof m.normalize)){return m.normalize()}return b(m)};function b(o){if(!o){return}var l=1;var m=3;var q=o.firstChild;while(q){if(q.nodeType==l){b(q)}else{if(q.nodeType==m){var n;while((n=q.nextSibling)&&n.nodeType==m){var p=n.nodeValue;if(p!=null&&p.length){q.nodeValue=q.nodeValue+p}o.removeChild(n)}}}q=q.nextSibling}}e.dom=c}).call(this.ice,window.jQuery);(function(){var a=this,b;b=function(c){this._selection=null;this.env=c;this._initializeRangeLibrary();this._getSelection()};b.prototype={_getSelection:function(){if(this._selection){this._selection.refresh()}else{if(this.env.frame){this._selection=rangy.getSelection(this.env.frame)}else{this._selection=rangy.getSelection()}}return this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(f){try{this._selection.refresh();return this._selection.getRangeAt(f)}catch(c){this._selection=null;try{return this._getSelection().getRangeAt(0)}catch(d){}}return null},addRange:function(c){this._selection||(this._selection=this._getSelection());this._selection.setSingleRange(c);this._selection.ranges=[c]},_initializeRangeLibrary:function(){var d=this;rangy.init();rangy.config.checkSelectionRanges=false;var c=function(g,h,f,e){if(f===0){return}var i=g.collapsed;switch(h){case ice.dom.CHARACTER_UNIT:if(f>0){g.moveCharRight(e,f)}else{g.moveCharLeft(e,f*-1)}break;case ice.dom.WORD_UNIT:default:break}if(i){g.collapse(e)}};rangy.rangePrototype.moveStart=function(f,e){c(this,f,e,true)};rangy.rangePrototype.moveEnd=function(f,e){c(this,f,e,false)};rangy.rangePrototype.setRange=function(g,e,f){if(g){this.setStart(e,f)}else{this.setEnd(e,f)}};rangy.rangePrototype.moveCharLeft=function(h,g){var f,j;if(h){f=this.startContainer;j=this.startOffset}else{f=this.endContainer;j=this.endOffset}if(f.nodeType===ice.dom.ELEMENT_NODE){if(f.hasChildNodes()&&j>0){var i=f.childNodes[j-1],e=this.getLastSelectableChild(i);if(e){f=e}else{f=this.getPreviousTextNode(i)}if(!f){return}j=f.data.length-g}else{j=g*-1}}else{j-=g}if(j<0){while(j<0){f=this.getPreviousTextNode(f);if(!f){return}if(f.nodeType===ice.dom.ELEMENT_NODE){continue}j+=f.data.length}}this.setRange(h,f,j)};rangy.rangePrototype.moveCharRight=function(g,f){var e,j;if(g){e=this.startContainer;j=this.startOffset}else{e=this.endContainer;j=this.endOffset}if(e.nodeType===ice.dom.ELEMENT_NODE){var h=this.getNextTextNode(e.childNodes[Math.min(j,e.childNodes.length-1)]);if(h){e=h}else{e=this.getNextTextNode(e)}j=f}else{j+=f}if(!e){return}var i=(j-e.data.length);if(i>0){while(i>0){e=this.getNextContainer(e);if(!e){return}if(e.nodeType===ice.dom.ELEMENT_NODE){continue}if(e.data.length>=i){break}else{if(e.data.length>0){i-=e.data.length}}}j=i}this.setRange(g,e,j)};rangy.rangePrototype.getNextContainer=function(e,h){if(!e){return null}h=h||[];while(e.nextSibling){e=e.nextSibling;if(e.nodeType!==ice.dom.TEXT_NODE){var g=this.getFirstSelectableChild(e);if(g!==null){return g}}else{if(this.isSelectable(e)===true){return e}}}while(e&&!e.nextSibling){e=e.parentNode}if(!e){return null}e=e.nextSibling;if(this.isSelectable(e)===true){return e}else{if(ice.dom.isBlockElement(e)===true){h.push(e)}}var f=this.getFirstSelectableChild(e);if(f!==null){return f}return this.getNextContainer(e,h)};rangy.rangePrototype.getPreviousContainer=function(e,h){if(!e){return null}h=h||[];while(e.previousSibling){e=e.previousSibling;if(e.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isStubElement(e)===true){return e}else{var g=this.getLastSelectableChild(e);if(g!==null){return g}}}else{if(this.isSelectable(e)===true){return e}}}while(e&&!e.previousSibling){e=e.parentNode}if(!e){return null}e=e.previousSibling;if(this.isSelectable(e)===true){return e}else{if(ice.dom.isBlockElement(e)===true){h.push(e)}}var f=this.getLastSelectableChild(e);if(f!==null){return f}return this.getPreviousContainer(e,h)};rangy.rangePrototype.getNextTextNode=function(e){if(e.nodeType===ice.dom.ELEMENT_NODE){if(e.firstChild){var f=this.getFirstSelectableChild(e);if(f){return f}}}e=this.getNextContainer(e);if(!e){return null}if(e.nodeType===ice.dom.TEXT_NODE){return e}return this.getNextTextNode(e)};rangy.rangePrototype.getPreviousTextNode=function(e,f){e=this.getPreviousContainer(e,f);if(!e){return null}if(e.nodeType===ice.dom.TEXT_NODE){return e}return this.getPreviousTextNode(e,f)};rangy.rangePrototype.getFirstSelectableChild=function(f){if(!f){return null}if(f.nodeType===ice.dom.TEXT_NODE){return f}var g=f.firstChild;while(g){if(this.isSelectable(g)===true){return g}else{if(g.firstChild){var e=this.getFirstSelectableChild(g);if(e!==null){return e}else{g=g.nextSibling}}else{g=g.nextSibling}}}return null};rangy.rangePrototype.getLastSelectableChild=function(f){if(!f){return null}if(f.nodeType==ice.dom.TEXT_NODE){return f}var g=f.lastChild;while(g){if(this.isSelectable(g)===true){return g}else{if(g.lastChild){var e=this.getLastSelectableChild(g);if(e!==null){return e}else{g=g.previousSibling}}else{g=g.previousSibling}}}return null};rangy.rangePrototype.isSelectable=function(e){return Boolean(e&&e.nodeType===ice.dom.TEXT_NODE&&e.data.length!==0)};rangy.rangePrototype.getHTMLContents=function(e){if(!e){e=this.cloneContents()}var f=d.env.document.createElement("div");f.appendChild(e.cloneNode(true));return f.innerHTML};rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}};a.Selection=b}).call(this.ice);(function(){var a=this,b;b=function(h,f,m){this.env=h;this.element=h.element;this.selection=this.env.selection;if(!m){this.removeBookmarks(this.element)}var l=f||this.selection.getRangeAt(0),f=l.cloneRange(),c=f.startContainer,k=f.startOffset,d;f.collapse(false);var i=this.env.document.createElement("span");i.style.display="none";ice.dom.setHtml(i,"&nbsp;");ice.dom.addClass(i,"iceBookmark iceBookmark_end");i.setAttribute("iceBookmark","end");f.insertNode(i);if(!ice.dom.isChildOf(i,this.element)){this.element.appendChild(i)}f.setStart(c,k);f.collapse(true);var g=this.env.document.createElement("span");g.style.display="none";ice.dom.addClass(g,"iceBookmark iceBookmark_start");ice.dom.setHtml(g,"&nbsp;");g.setAttribute("iceBookmark","start");try{f.insertNode(g);if(g.previousSibling===i){d=g;g=i;i=d}}catch(j){ice.dom.insertBefore(i,g)}if(ice.dom.isChildOf(g,this.element)===false){if(this.element.firstChild){ice.dom.insertBefore(this.element.firstChild,g)}else{this.element.appendChild(g)}}if(!i.previousSibling){d=this.env.document.createTextNode("");ice.dom.insertBefore(i,d)}if(!g.nextSibling){d=this.env.document.createTextNode("");ice.dom.insertAfter(g,d)}l.setStart(g.nextSibling,0);l.setEnd(i.previousSibling,(i.previousSibling.length||0));this.start=g;this.end=i};b.prototype={selectBookmark:function(){var d=this.selection.getRangeAt(0),h=null,g=null,c=0,f=null,j=this.start&&this.start.parentNode;if(this.start.nextSibling===this.end||ice.dom.getElementsBetween(this.start,this.end).length===0){if(this.end.nextSibling){h=ice.dom.getFirstChild(this.end.nextSibling)}else{if(this.start.previousSibling){h=ice.dom.getFirstChild(this.start.previousSibling);if(h.nodeType===ice.dom.TEXT_NODE){c=h.length}}else{this.end.parentNode.appendChild(this.env.document.createTextNode(""));h=ice.dom.getFirstChild(this.end.nextSibling)}}}else{if(this.start.nextSibling){h=ice.dom.getFirstChild(this.start.nextSibling)}else{if(!this.start.previousSibling){var i=this.env.document.createTextNode("");ice.dom.insertBefore(this.start,i)}h=ice.dom.getLastChild(this.start.previousSibling);c=h.length}if(this.end.previousSibling){g=ice.dom.getLastChild(this.end.previousSibling)}else{g=ice.dom.getFirstChild(this.end.nextSibling||this.end);f=0}}ice.dom.remove([this.start,this.end]);try{ice.dom.normalize(j)}catch(k){}if(g===null){d.setEnd(h,c);d.collapse(false)}else{d.setStart(h,c);if(f===null){f=(g.length||0)}d.setEnd(g,f)}try{this.selection.addRange(d)}catch(k){}},getBookmark:function(d,c){var e=ice.dom.getClass("iceBookmark_"+c,d)[0];return e},removeBookmarks:function(c){ice.dom.remove(ice.dom.getClass("iceBookmark",c,"span"))}};a.Bookmark=b}).call(this.ice);var LITE={Events:{INIT:"lite:init",ACCEPT:"lite:accept",REJECT:"lite:reject",SHOW_HIDE:"lite:showHide",TRACKING:"lite:tracking",CHANGE:"lite:change",HOVER_IN:"lite:hover-in",HOVER_OUT:"lite:hover-out"},Commands:{TOGGLE_TRACKING:"lite-toggletracking",TOGGLE_SHOW:"lite-toggleshow",ACCEPT_ALL:"lite-acceptall",REJECT_ALL:"lite-rejectall",ACCEPT_ONE:"lite-acceptone",REJECT_ONE:"lite-rejectone",TOGGLE_TOOLTIPS:"lite-toggletooltips"}};
/* Copyright (C) 2015 LoopIndex - All Rights Reserved
 * You may use, distribute and modify this code under the
 * terms of the LoopIndex Comments CKEditor plugin license.
 *
 * You should have received a copy of the LoopIndex Comments CKEditor plugin license with
 * this file. If not, please write to: loopindex@gmail.com, or visit http://www.loopindex.com
 * written by (David *)Frenkiel (https://github.com/imdfl) 
 */