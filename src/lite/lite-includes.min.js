/* Source version: 1.1.12 */
(function(b){var k=(typeof b.define=="function"&&b.define.amd);var t="object",d="function",z="undefined";var a=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"];var p=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"];var l=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"];var E=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"];function B(M,L){var K=typeof M[L];return K==d||(!!(K==t&&M[L]))||K=="unknown"}function x(L,K){return !!(typeof L[K]==t&&L[K])}function e(L,K){return typeof L[K]!=z}function v(K){return function(N,M){var L=M.length;while(L--){if(!K(N,M[L])){return false}}return true}}var j=v(B);var s=v(x);var g=v(e);function y(K){return K&&j(K,E)&&g(K,l)}function H(K){return x(K,"body")?K.body:K.getElementsByTagName("body")[0]}var u={};var h={version:"1.3alpha.804",initialized:false,supported:true,util:{isHostMethod:B,isHostObject:x,isHostProperty:e,areHostMethods:j,areHostObjects:s,areHostProperties:g,isTextRange:y,getBody:H},features:{},modules:u,config:{alertOnFail:true,alertOnWarn:false,preferTextRange:false}};function D(K){if(x(window,"console")&&B(window.console,"log")){window.console.log(K)}}function o(L,K){if(K){window.alert(L)}else{D(L)}}function m(K){h.initialized=true;h.supported=false;o("Rangy is not supported on this page in your browser. Reason: "+K,h.config.alertOnFail)}h.fail=m;function n(K){o("Rangy warning: "+K,h.config.alertOnWarn)}h.warn=n;if({}.hasOwnProperty){h.util.extend=function(O,M,K){var P,N;for(var L in M){if(M.hasOwnProperty(L)){P=O[L];N=M[L];if(K&&P!==null&&typeof P=="object"&&N!==null&&typeof N=="object"){h.util.extend(P,N,true)}O[L]=N}}return O}}else{m("hasOwnProperty not supported")}(function(){var L=document.createElement("div");L.appendChild(document.createElement("span"));var N=[].slice;var K;try{if(N.call(L.childNodes,0)[0].nodeType==1){K=function(O){return N.call(O,0)}}}catch(M){}if(!K){K=function(Q){var P=[];for(var R=0,O=Q.length;R<O;++R){P[R]=Q[R]}return P}}h.util.toArray=K})();var i;if(B(document,"addEventListener")){i=function(M,K,L){M.addEventListener(K,L,false)}}else{if(B(document,"attachEvent")){i=function(M,K,L){M.attachEvent("on"+K,L)}}else{m("Document does not have required addEventListener or attachEvent method")}}h.util.addListener=i;var I=[];function c(K){return K.message||K.description||String(K)}function F(){if(h.initialized){return}var M;var T=false,N=false;if(B(document,"createRange")){M=document.createRange();if(j(M,p)&&g(M,a)){T=true}M.detach()}var P=H(document);if(!P||P.nodeName.toLowerCase()!="body"){m("No body element found");return}if(P&&B(P,"createTextRange")){M=P.createTextRange();if(y(M)){N=true}}if(!T&&!N){m("Neither Range nor TextRange are available");return}h.initialized=true;h.features={implementsDomRange:T,implementsTextRange:N};var L,R;for(var K in u){if((L=u[K]) instanceof w){L.init(L,h)}}for(var O=0,Q=I.length;O<Q;++O){try{I[O](h)}catch(S){R="Rangy init listener threw an exception. Continuing. Detail: "+c(S);D(R)}}}h.init=F;h.addInitListener=function(K){if(h.initialized){K(h)}else{I.push(K)}};var J=[];h.addCreateMissingNativeApiListener=function(K){J.push(K)};function r(M){M=M||window;F();for(var L=0,K=J.length;L<K;++L){J[L](M)}}h.createMissingNativeApi=r;function w(K,M,L){this.name=K;this.dependencies=M;this.initialized=false;this.supported=false;this.initializer=L}w.prototype={init:function(N){var O=this.dependencies||[];for(var M=0,K=O.length,P,L;M<K;++M){L=O[M];P=u[L];if(!P||!(P instanceof w)){throw new Error("required module '"+L+"' not found")}P.init();if(!P.supported){throw new Error("required module '"+L+"' not supported")}}this.initializer(this)},fail:function(K){this.initialized=true;this.supported=false;throw new Error("Module '"+this.name+"' failed to load: "+K)},warn:function(K){h.warn("Module "+this.name+": "+K)},deprecationNotice:function(K,L){h.warn("DEPRECATED: "+K+" in module "+this.name+"is deprecated. Please use "+L+" instead")},createError:function(K){return new Error("Error in Rangy "+this.name+" module: "+K)}};function q(K,L,N,O){var M=new w(L,N,function(R){if(!R.initialized){R.initialized=true;try{O(h,R);R.supported=true}catch(Q){var P="Module '"+L+"' failed to load: "+c(Q);D(P)}}});u[L]=M}h.createModule=function(K){var M,L;if(arguments.length==2){M=arguments[1];L=[]}else{M=arguments[2];L=arguments[1]}q(false,K,L,M)};h.createCoreModule=function(K,L,M){q(true,K,L,M)};function C(){}h.RangePrototype=C;h.rangePrototype=new C();function A(){}h.selectionPrototype=new A();var f=false;var G=function(K){if(!f){f=true;if(!h.initialized){F()}}};if(typeof window==z){m("No window found");return}if(typeof document==z){m("No document found");return}if(B(document,"addEventListener")){document.addEventListener("DOMContentLoaded",G,false)}i(window,"load",G);if(k){b.define(function(){h.amd=true;return h})}b.rangy=h})(this);rangy.createCoreModule("DomUtil",[],function(d,b){var s="undefined";var f=d.util;if(!f.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])){b.fail("document missing a Node creation method")}if(!f.isHostMethod(document,"getElementsByTagName")){b.fail("document missing getElementsByTagName method")}var E=document.createElement("div");if(!f.areHostMethods(E,["insertBefore","appendChild","cloneNode"]||!f.areHostObjects(E,["previousSibling","nextSibling","childNodes","parentNode"]))){b.fail("Incomplete Element implementation")}if(!f.isHostProperty(E,"innerHTML")){b.fail("Element is missing innerHTML property")}var G=document.createTextNode("test");if(!f.areHostMethods(G,["splitText","deleteData","insertData","appendData","cloneNode"]||!f.areHostObjects(E,["previousSibling","nextSibling","childNodes","parentNode"])||!f.areHostProperties(G,["data"]))){b.fail("Incomplete Text Node implementation")}var J=function(K,M){var L=K.length;while(L--){if(K[L]===M){return true}}return false};function h(L){var K;return typeof L.namespaceURI==s||((K=L.namespaceURI)===null||K=="http://www.w3.org/1999/xhtml")}function t(L){var K=L.parentNode;return(K.nodeType==1)?K:null}function n(L){var K=0;while((L=L.previousSibling)){++K}return K}function v(K){switch(K.nodeType){case 7:case 10:return 0;case 3:case 8:return K.length;default:return K.childNodes.length}}function k(L,K){var M=[],N;for(N=L;N;N=N.parentNode){M.push(N)}for(N=K;N;N=N.parentNode){if(J(M,N)){return N}}return null}function j(K,L,N){var M=N?L:L.parentNode;while(M){if(M===K){return true}else{M=M.parentNode}}return false}function C(K,L){return j(K,L,true)}function A(L,K,O){var M,N=O?L:L.parentNode;while(N){M=N.parentNode;if(M===K){return N}N=M}return null}function c(L){var K=L.nodeType;return K==3||K==4||K==8}function a(L){if(!L){return false}var K=L.nodeType;return K==3||K==8}function g(N,L){var K=L.nextSibling,M=L.parentNode;if(K){M.insertBefore(N,K)}else{M.appendChild(N)}return N}function u(P,M,L){var O=P.cloneNode(false);O.deleteData(0,M);P.deleteData(M,P.length-M);g(O,P);if(L){for(var N=0,K;K=L[N++];){if(K.node==P&&K.offset>M){K.node=O;K.offset-=M}else{if(K.node==P.parentNode&&K.offset>n(P)){++K.offset}}}}return O}function H(K){if(K.nodeType==9){return K}else{if(typeof K.ownerDocument!=s){return K.ownerDocument}else{if(typeof K.document!=s){return K.document}else{if(K.parentNode){return H(K.parentNode)}else{throw b.createError("getDocument: no document found for node")}}}}}function m(K){var L=H(K);if(typeof L.defaultView!=s){return L.defaultView}else{if(typeof L.parentWindow!=s){return L.parentWindow}else{throw b.createError("Cannot get a window object for node")}}}function I(K){if(typeof K.contentDocument!=s){return K.contentDocument}else{if(typeof K.contentWindow!=s){return K.contentWindow.document}else{throw b.createError("getIframeDocument: No Document object found for iframe element")}}}function F(K){if(typeof K.contentWindow!=s){return K.contentWindow}else{if(typeof K.contentDocument!=s){return K.contentDocument.defaultView}else{throw b.createError("getIframeWindow: No Window object found for iframe element")}}}function y(K){return K&&f.isHostMethod(K,"setTimeout")&&f.isHostObject(K,"document")}function x(N,L,K){var M;if(!N){M=document}else{if(f.isHostProperty(N,"nodeType")){M=(N.nodeType==1&&N.tagName.toLowerCase()=="iframe")?I(N):H(N)}else{if(y(N)){M=N.document}}}if(!M){throw L.createError(K+"(): Parameter must be a Window object or DOM node")}return M}function i(L){var K;while((K=L.parentNode)){L=K}return L}function B(N,P,M,O){var K,Q,S,R,L;if(N==M){return P===O?0:(P<O)?-1:1}else{if((K=A(M,N,true))){return P<=n(K)?-1:1}else{if((K=A(N,M,true))){return n(K)<O?-1:1}else{Q=k(N,M);if(!Q){throw new Error("comparePoints error: nodes have no common ancestor")}S=(N===Q)?Q:A(N,Q,true);R=(M===Q)?Q:A(M,Q,true);if(S===R){throw b.createError("comparePoints got to case 4 and childA and childB are the same!")}else{L=Q.firstChild;while(L){if(L===S){return -1}else{if(L===R){return 1}}L=L.nextSibling}}}}}}var q=false;function p(K){try{K.parentNode;return false}catch(L){return true}}(function(){var K=document.createElement("b");K.innerHTML="1";var L=K.firstChild;K.innerHTML="<br>";q=p(L);d.features.crashyTextNodes=q})();function r(K){if(!K){return"[No node]"}if(q&&p(K)){return"[Broken node]"}if(c(K)){return'"'+K.data+'"'}if(K.nodeType==1){var L=K.id?' id="'+K.id+'"':"";return"<"+K.nodeName+L+">["+n(K)+"]["+K.childNodes.length+"]["+(K.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return K.nodeName}function z(L){var K=H(L).createDocumentFragment(),M;while((M=L.firstChild)){K.appendChild(M)}return K}var l;if(typeof window.getComputedStyle!=s){l=function(K,L){return m(K).getComputedStyle(K,null)[L]}}else{if(typeof document.documentElement.currentStyle!=s){l=function(K,L){return K.currentStyle[L]}}else{b.fail("No means of obtaining computed style properties found")}}function e(K){this.root=K;this._next=K}e.prototype={_current:null,hasNext:function(){return !!this._next},next:function(){var M=this._current=this._next;var L,K;if(this._current){L=M.firstChild;if(L){this._next=L}else{K=null;while((M!==this.root)&&!(K=M.nextSibling)){M=M.parentNode}this._next=K}}return this._current},detach:function(){this._current=this._next=this.root=null}};function D(K){return new e(K)}function o(K,L){this.node=K;this.offset=L}o.prototype={equals:function(K){return !!K&&this.node===K.node&&this.offset==K.offset},inspect:function(){return"[DomPosition("+r(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}};function w(K){this.code=this[K];this.codeName=K;this.message="DOMException: "+this.codeName}w.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};w.prototype.toString=function(){return this.message};d.dom={arrayContains:J,isHtmlNamespace:h,parentElement:t,getNodeIndex:n,getNodeLength:v,getCommonAncestor:k,isAncestorOf:j,isOrIsAncestorOf:C,getClosestAncestorIn:A,isCharacterDataNode:c,isTextOrCommentNode:a,insertAfter:g,splitDataNode:u,getDocument:H,getWindow:m,getIframeWindow:F,getIframeDocument:I,getBody:f.getBody,isWindow:y,getContentDocument:x,getRootContainer:i,comparePoints:B,isBrokenNode:p,inspectNode:r,getComputedStyleProperty:l,fragmentFromNodeChildren:z,createIterator:D,DomPosition:o};d.DOMException=w});rangy.createCoreModule("DomRange",["DomUtil"],function(o,av){var s=o.dom;var ai=o.util;var H=s.DomPosition;var Y=o.DOMException;var L=s.isCharacterDataNode;var c=s.getNodeIndex;var K=s.isOrIsAncestorOf;var aw=s.getDocument;var ak=s.comparePoints;var ap=s.splitDataNode;var ab=s.getClosestAncestorIn;var O=s.getNodeLength;var ar=s.arrayContains;var t=s.getRootContainer;var w=o.features.crashyTextNodes;function ae(ax,e){return(ax.nodeType!=3)&&(K(ax,e.startContainer)||K(ax,e.endContainer))}function al(e){return e.document||aw(e.startContainer)}function x(e){return new H(e.parentNode,c(e))}function h(e){return new H(e.parentNode,c(e)+1)}function d(ax,az,ay){var e=ax.nodeType==11?ax.firstChild:ax;if(L(az)){if(ay==az.length){s.insertAfter(ax,az)}else{az.parentNode.insertBefore(ax,ay==0?az:ap(az,ay))}}else{if(ay>=az.childNodes.length){az.appendChild(ax)}else{az.insertBefore(ax,az.childNodes[ay])}}return e}function i(az,ay,e){a(az);a(ay);if(al(ay)!=al(az)){throw new Y("WRONG_DOCUMENT_ERR")}var aA=ak(az.startContainer,az.startOffset,ay.endContainer,ay.endOffset),ax=ak(az.endContainer,az.endOffset,ay.startContainer,ay.startOffset);return e?aA<=0&&ax>=0:aA<0&&ax>0}function p(ay){var ax;for(var az,aA=al(ay.range).createDocumentFragment(),e;az=ay.next();){ax=ay.isPartiallySelectedSubtree();az=az.cloneNode(!ax);if(ax){e=ay.getSubtreeIterator();az.appendChild(p(e));e.detach(true)}if(az.nodeType==10){throw new Y("HIERARCHY_REQUEST_ERR")}aA.appendChild(az)}return aA}function am(ax,aA,e){var ay,aC;e=e||{stop:false};for(var az,aB;az=ax.next();){if(ax.isPartiallySelectedSubtree()){if(aA(az)===false){e.stop=true;return}else{aB=ax.getSubtreeIterator();am(aB,aA,e);aB.detach(true);if(e.stop){return}}}else{ay=s.createIterator(az);while((aC=ay.next())){if(aA(aC)===false){e.stop=true;return}}}}}function M(ax){var e;while(ax.next()){if(ax.isPartiallySelectedSubtree()){e=ax.getSubtreeIterator();M(e);e.detach(true)}else{ax.remove()}}}function ah(ax){for(var ay,az=al(ax.range).createDocumentFragment(),e;ay=ax.next();){if(ax.isPartiallySelectedSubtree()){ay=ay.cloneNode(false);e=ax.getSubtreeIterator();ay.appendChild(ah(e));e.detach(true)}else{ax.remove()}if(ay.nodeType==10){throw new Y("HIERARCHY_REQUEST_ERR")}az.appendChild(ay)}return az}function P(ay,e,az){var aB=!!(e&&e.length),aA;var aC=!!az;if(aB){aA=new RegExp("^("+e.join("|")+")$")}var ax=[];am(new v(ay,false),function(aE){if(aB&&!aA.test(aE.nodeType)){return}if(aC&&!az(aE)){return}var aF=ay.startContainer;if(aE==aF&&L(aF)&&ay.startOffset==aF.length){return}var aD=ay.endContainer;if(aE==aD&&L(aD)&&ay.endOffset==0){return}ax.push(aE)});return ax}function ao(e){var ax=(typeof e.getName=="undefined")?"Range":e.getName();return"["+ax+"("+s.inspectNode(e.startContainer)+":"+e.startOffset+", "+s.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function v(ay,ax){this.range=ay;this.clonePartiallySelectedTextNodes=ax;if(!ay.collapsed){this.sc=ay.startContainer;this.so=ay.startOffset;this.ec=ay.endContainer;this.eo=ay.endOffset;var e=ay.commonAncestorContainer;if(this.sc===this.ec&&L(this.sc)){this.isSingleCharacterDataNode=true;this._first=this._last=this._next=this.sc}else{this._first=this._next=(this.sc===e&&!L(this.sc))?this.sc.childNodes[this.so]:ab(this.sc,e,true);this._last=(this.ec===e&&!L(this.ec))?this.ec.childNodes[this.eo-1]:ab(this.ec,e,true)}}}v.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:false,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return !!this._next},next:function(){var e=this._current=this._next;if(e){this._next=(e!==this._last)?e.nextSibling:null;if(L(e)&&this.clonePartiallySelectedTextNodes){if(e===this.ec){(e=e.cloneNode(true)).deleteData(this.eo,e.length-this.eo)}if(this._current===this.sc){(e=e.cloneNode(true)).deleteData(0,this.so)}}}return e},remove:function(){var ax=this._current,ay,e;if(L(ax)&&(ax===this.sc||ax===this.ec)){ay=(ax===this.sc)?this.so:0;e=(ax===this.ec)?this.eo:ax.length;if(ay!=e){ax.deleteData(ay,e-ay)}}else{if(ax.parentNode){ax.parentNode.removeChild(ax)}else{}}},isPartiallySelectedSubtree:function(){var e=this._current;return ae(e,this.range)},getSubtreeIterator:function(){var ax;if(this.isSingleCharacterDataNode){ax=this.range.cloneRange();ax.collapse(false)}else{ax=new B(al(this.range));var aB=this._current;var az=aB,e=0,aA=aB,ay=O(aB);if(K(aB,this.sc)){az=this.sc;e=this.so}if(K(aB,this.ec)){aA=this.ec;ay=this.eo}ad(ax,az,e,aA,ay)}return new v(ax,this.clonePartiallySelectedTextNodes)},detach:function(e){if(e){this.range.detach()}this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};function E(e){this.code=this[e];this.codeName=e;this.message="RangeException: "+this.codeName}E.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2};E.prototype.toString=function(){return this.message};var R=[1,3,4,5,7,8,10];var aj=[2,9,11];var j=[5,6,10,12];var z=[1,3,4,5,7,8,10,11];var at=[1,3,4,5,7,8];function m(e){return function(ay,aA){var ax,az=aA?ay:ay.parentNode;while(az){ax=az.nodeType;if(ar(e,ax)){return az}az=az.parentNode}return null}}var aq=m([9,11]);var G=m(j);var y=m([6,10,12]);function n(ax,e){if(y(ax,e)){throw new E("INVALID_NODE_TYPE_ERR")}}function r(e){if(!e.startContainer){throw new Y("INVALID_STATE_ERR")}}function b(e,ax){if(!ar(ax,e.nodeType)){throw new E("INVALID_NODE_TYPE_ERR")}}function S(e,ax){if(ax<0||ax>(L(e)?e.length:e.childNodes.length)){throw new Y("INDEX_SIZE_ERR")}}function aa(ax,e){if(aq(ax,true)!==aq(e,true)){throw new Y("WRONG_DOCUMENT_ERR")}}function N(e){if(G(e,true)){throw new Y("NO_MODIFICATION_ALLOWED_ERR")}}function U(ax,e){if(!ax){throw new Y(e)}}function ac(e){return(w&&s.isBrokenNode(e))||!ar(aj,e.nodeType)&&!aq(e,true)}function g(e,ax){return ax<=(L(e)?e.length:e.childNodes.length)}function C(e){return(!!e.startContainer&&!!e.endContainer&&!ac(e.startContainer)&&!ac(e.endContainer)&&g(e.startContainer,e.startOffset)&&g(e.endContainer,e.endOffset))}function a(e){r(e);if(!C(e)){throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}}var T=document.createElement("style");var J=false;try{T.innerHTML="<b>x</b>";J=(T.firstChild.nodeType==3)}catch(I){}o.features.htmlParsingConforms=J;var u=J?function(ay){var ax=this.startContainer;var az=aw(ax);if(!ax){throw new Y("INVALID_STATE_ERR")}var e=null;if(ax.nodeType==1){e=ax}else{if(L(ax)){e=s.parentElement(ax)}}if(e===null||(e.nodeName=="HTML"&&s.isHtmlNamespace(aw(e).documentElement)&&s.isHtmlNamespace(e))){e=az.createElement("body")}else{e=e.cloneNode(false)}e.innerHTML=ay;return s.fragmentFromNodeChildren(e)}:function(ax){r(this);var ay=al(this);var e=ay.createElement("body");e.innerHTML=ax;return s.fragmentFromNodeChildren(e)};function A(ay,e){a(ay);var aC=ay.startContainer,aB=ay.startOffset,az=ay.endContainer,ax=ay.endOffset;var aA=(aC===az);if(L(az)&&ax>0&&ax<az.length){ap(az,ax,e)}if(L(aC)&&aB>0&&aB<aC.length){aC=ap(aC,aB,e);if(aA){ax-=aB;az=aC}else{if(az==aC.parentNode&&ax>=c(aC)){ax++}}aB=0}ay.setStartAndEnd(aC,aB,az,ax)}var V=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"];var Z=0,af=1,l=2,f=3;var W=0,X=1,ag=2,Q=3;ai.extend(o.rangePrototype,{compareBoundaryPoints:function(aB,ay){a(this);aa(this.startContainer,ay.startContainer);var aD,ax,aC,e;var aA=(aB==f||aB==Z)?"start":"end";var az=(aB==af||aB==Z)?"start":"end";aD=this[aA+"Container"];ax=this[aA+"Offset"];aC=ay[az+"Container"];e=ay[az+"Offset"];return ak(aD,ax,aC,e)},insertNode:function(ax){a(this);b(ax,z);N(this.startContainer);if(K(ax,this.startContainer)){throw new Y("HIERARCHY_REQUEST_ERR")}var e=d(ax,this.startContainer,this.startOffset);this.setStartBefore(e)},cloneContents:function(){a(this);var ay,ax;if(this.collapsed){return al(this).createDocumentFragment()}else{if(this.startContainer===this.endContainer&&L(this.startContainer)){ay=this.startContainer.cloneNode(true);ay.data=ay.data.slice(this.startOffset,this.endOffset);ax=al(this).createDocumentFragment();ax.appendChild(ay);return ax}else{var e=new v(this,true);ay=p(e);e.detach()}return ay}},canSurroundContents:function(){a(this);N(this.startContainer);N(this.endContainer);var e=new v(this,true);var ax=(e._first&&(ae(e._first,this))||(e._last&&ae(e._last,this)));e.detach();return !ax},surroundContents:function(ax){b(ax,at);if(!this.canSurroundContents()){throw new E("BAD_BOUNDARYPOINTS_ERR")}var e=this.extractContents();if(ax.hasChildNodes()){while(ax.lastChild){ax.removeChild(ax.lastChild)}}d(ax,this.startContainer,this.startOffset);ax.appendChild(e);this.selectNode(ax)},cloneRange:function(){a(this);var e=new B(al(this));var ax=V.length,ay;while(ax--){ay=V[ax];e[ay]=this[ay]}return e},toString:function(){a(this);var ay=this.startContainer;if(ay===this.endContainer&&L(ay)){return(ay.nodeType==3||ay.nodeType==4)?ay.data.slice(this.startOffset,this.endOffset):""}else{var e=[],ax=new v(this,true);am(ax,function(az){if(az.nodeType==3||az.nodeType==4){e.push(az.data)}});ax.detach();return e.join("")}},compareNode:function(ay){a(this);var ax=ay.parentNode;var aA=c(ay);if(!ax){throw new Y("NOT_FOUND_ERR")}var az=this.comparePoint(ax,aA),e=this.comparePoint(ax,aA+1);if(az<0){return(e>0)?ag:W}else{return(e>0)?X:Q}},comparePoint:function(e,ax){a(this);U(e,"HIERARCHY_REQUEST_ERR");aa(e,this.startContainer);if(ak(e,ax,this.startContainer,this.startOffset)<0){return -1}else{if(ak(e,ax,this.endContainer,this.endOffset)>0){return 1}}return 0},createContextualFragment:u,toHtml:function(){a(this);var e=this.commonAncestorContainer.parentNode.cloneNode(false);e.appendChild(this.cloneContents());return e.innerHTML},intersectsNode:function(az,e){a(this);U(az,"NOT_FOUND_ERR");if(aw(az)!==al(this)){return false}var ay=az.parentNode,aB=c(az);U(ay,"NOT_FOUND_ERR");var aA=ak(ay,aB,this.endContainer,this.endOffset),ax=ak(ay,aB+1,this.startContainer,this.startOffset);return e?aA<=0&&ax>=0:aA<0&&ax>0},isPointInRange:function(e,ax){a(this);U(e,"HIERARCHY_REQUEST_ERR");aa(e,this.startContainer);return(ak(e,ax,this.startContainer,this.startOffset)>=0)&&(ak(e,ax,this.endContainer,this.endOffset)<=0)},intersectsRange:function(e){return i(this,e,false)},intersectsOrTouchesRange:function(e){return i(this,e,true)},intersection:function(e){if(this.intersectsRange(e)){var az=ak(this.startContainer,this.startOffset,e.startContainer,e.startOffset),ax=ak(this.endContainer,this.endOffset,e.endContainer,e.endOffset);var ay=this.cloneRange();if(az==-1){ay.setStart(e.startContainer,e.startOffset)}if(ax==1){ay.setEnd(e.endContainer,e.endOffset)}return ay}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var ax=this.cloneRange();if(ak(e.startContainer,e.startOffset,this.startContainer,this.startOffset)==-1){ax.setStart(e.startContainer,e.startOffset)}if(ak(e.endContainer,e.endOffset,this.endContainer,this.endOffset)==1){ax.setEnd(e.endContainer,e.endOffset)}return ax}else{throw new E("Ranges do not intersect")}},containsNode:function(ax,e){if(e){return this.intersectsNode(ax,false)}else{return this.compareNode(ax)==Q}},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,O(e))<=0},containsRange:function(e){var ax=this.intersection(e);return ax!==null&&e.equals(ax)},containsNodeText:function(az){var aA=this.cloneRange();aA.selectNode(az);var ay=aA.getNodes([3]);if(ay.length>0){aA.setStart(ay[0],0);var e=ay.pop();aA.setEnd(e,e.length);var ax=this.containsRange(aA);aA.detach();return ax}else{return this.containsNodeContents(az)}},getNodes:function(e,ax){a(this);return P(this,e,ax)},getDocument:function(){return al(this)},collapseBefore:function(e){r(this);this.setEndBefore(e);this.collapse(false)},collapseAfter:function(e){r(this);this.setStartAfter(e);this.collapse(true)},getBookmark:function(e){var aA=al(this);var ay=o.createRange(aA);e=e||s.getBody(aA);ay.selectNodeContents(e);var az=this.intersection(ay);var aB=0,ax=0;if(az){ay.setEnd(az.startContainer,az.startOffset);aB=ay.toString().length;ax=aB+az.toString().length;ay.detach()}return{start:aB,end:ax,containerNode:e}},moveToBookmark:function(aD){var az=aD.containerNode;var e=0;this.setStart(az,0);this.collapse(true);var aB=[az],ax,ay=false,aE=false;var aC,aA,aF;while(!aE&&(ax=aB.pop())){if(ax.nodeType==3){aC=e+ax.length;if(!ay&&aD.start>=e&&aD.start<=aC){this.setStart(ax,aD.start-e);ay=true}if(ay&&aD.end>=e&&aD.end<=aC){this.setEnd(ax,aD.end-e);aE=true}e=aC}else{aF=ax.childNodes;aA=aF.length;while(aA--){aB.push(aF[aA])}}}},getName:function(){return"DomRange"},equals:function(e){return B.rangesEqual(this,e)},isValid:function(){return C(this)},inspect:function(){return ao(this)}});function D(e){e.START_TO_START=Z;e.START_TO_END=af;e.END_TO_END=l;e.END_TO_START=f;e.NODE_BEFORE=W;e.NODE_AFTER=X;e.NODE_BEFORE_AND_AFTER=ag;e.NODE_INSIDE=Q}function q(e){D(e);D(e.prototype)}function an(e,ax){return function(){a(this);var aD=this.startContainer,aC=this.startOffset,ay=this.commonAncestorContainer;var aA=new v(this,true);var aB,aE;if(aD!==ay){aB=ab(aD,ay,true);aE=h(aB);aD=aE.node;aC=aE.offset}am(aA,N);aA.reset();var az=e(aA);aA.detach();ax(this,aD,aC,aD,aC);return az}}function k(ay,aC,e){function aB(aE,aD){return function(aF){r(this);b(aF,R);b(t(aF),aj);var aG=(aE?x:h)(aF);(aD?ax:aA)(this,aG.node,aG.offset)}}function ax(aE,aG,aH){var aF=aE.endContainer,aD=aE.endOffset;if(aG!==aE.startContainer||aH!==aE.startOffset){if(t(aG)!=t(aF)||ak(aG,aH,aF,aD)==1){aF=aG;aD=aH}aC(aE,aG,aH,aF,aD)}}function aA(aD,aE,aH){var aG=aD.startContainer,aF=aD.startOffset;if(aE!==aD.endContainer||aH!==aD.endOffset){if(t(aE)!=t(aG)||ak(aE,aH,aG,aF)==-1){aG=aE;aF=aH}aC(aD,aG,aF,aE,aH)}}var az=function(){};az.prototype=o.rangePrototype;ay.prototype=new az();ai.extend(ay.prototype,{setStart:function(aD,aE){r(this);n(aD,true);S(aD,aE);ax(this,aD,aE)},setEnd:function(aD,aE){r(this);n(aD,true);S(aD,aE);aA(this,aD,aE)},setStartAndEnd:function(){r(this);var aF=arguments;var aH=aF[0],aG=aF[1],aE=aH,aD=aG;switch(aF.length){case 3:aD=aF[2];break;case 4:aE=aF[2];aD=aF[3];break}aC(this,aH,aG,aE,aD)},setBoundary:function(aE,aF,aD){this["set"+(aD?"Start":"End")](aE,aF)},setStartBefore:aB(true,true),setStartAfter:aB(false,true),setEndBefore:aB(true,false),setEndAfter:aB(false,false),collapse:function(aD){a(this);if(aD){aC(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset)}else{aC(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)}},selectNodeContents:function(aD){r(this);n(aD,true);aC(this,aD,0,aD,O(aD))},selectNode:function(aE){r(this);n(aE,false);b(aE,R);var aF=x(aE),aD=h(aE);aC(this,aF.node,aF.offset,aD.node,aD.offset)},extractContents:an(ah,aC),deleteContents:an(M,aC),canSurroundContents:function(){a(this);N(this.startContainer);N(this.endContainer);var aD=new v(this,true);var aE=(aD._first&&(ae(aD._first,this))||(aD._last&&ae(aD._last,this)));aD.detach();return !aE},detach:function(){e(this)},splitBoundaries:function(){A(this)},splitBoundariesPreservingPositions:function(aD){A(this,aD)},normalizeBoundaries:function(){a(this);var aK=this.startContainer,aF=this.startOffset,aJ=this.endContainer,aD=this.endOffset;var aG=function(aN){var aM=aN.nextSibling;if(aM&&aM.nodeType==aN.nodeType){aJ=aN;aD=aN.length;aN.appendData(aM.data);aM.parentNode.removeChild(aM)}};var aL=function(aO){var aN=aO.previousSibling;if(aN&&aN.nodeType==aO.nodeType){aK=aO;var aM=aO.length;aF=aN.length;aO.insertData(0,aN.data);aN.parentNode.removeChild(aN);if(aK==aJ){aD+=aF;aJ=aK}else{if(aJ==aO.parentNode){var aP=c(aO);if(aD==aP){aJ=aO;aD=aM}else{if(aD>aP){aD--}}}}}};var aI=true;if(L(aJ)){if(aJ.length==aD){aG(aJ)}}else{if(aD>0){var aH=aJ.childNodes[aD-1];if(aH&&L(aH)){aG(aH)}}aI=!this.collapsed}if(aI){if(L(aK)){if(aF==0){aL(aK)}}else{if(aF<aK.childNodes.length){var aE=aK.childNodes[aF];if(aE&&L(aE)){aL(aE)}}}}else{aK=aJ;aF=aD}aC(this,aK,aF,aJ,aD)},collapseToPoint:function(aD,aE){r(this);n(aD,true);S(aD,aE);this.setStartAndEnd(aD,aE)}});q(ay)}function F(e){e.collapsed=(e.startContainer===e.endContainer&&e.startOffset===e.endOffset);e.commonAncestorContainer=e.collapsed?e.startContainer:s.getCommonAncestor(e.startContainer,e.endContainer)}function ad(ax,az,e,aA,ay){ax.startContainer=az;ax.startOffset=e;ax.endContainer=aA;ax.endOffset=ay;ax.document=s.getDocument(az);F(ax)}function au(e){r(e);e.startContainer=e.startOffset=e.endContainer=e.endOffset=e.document=null;e.collapsed=e.commonAncestorContainer=null}function B(e){this.startContainer=e;this.startOffset=0;this.endContainer=e;this.endOffset=0;this.document=e;F(this)}k(B,ad,au);ai.extend(B,{rangeProperties:V,RangeIterator:v,copyComparisonConstants:q,createPrototypeRange:k,inspect:ao,getRangeDocument:al,rangesEqual:function(ax,e){return ax.startContainer===e.startContainer&&ax.startOffset===e.startOffset&&ax.endContainer===e.endContainer&&ax.endOffset===e.endOffset}});o.DomRange=B;o.RangeException=E});rangy.createCoreModule("WrappedRange",["DomRange"],function(m,e){var a,b;var i=m.dom;var j=m.util;var d=i.DomPosition;var n=m.DomRange;var k=i.getBody;var p=i.getContentDocument;var l=i.isCharacterDataNode;if(m.features.implementsDomRange){(function(){var t;var A=n.rangeProperties;function q(D){var E=A.length,F;while(E--){F=A[E];D[F]=D.nativeRange[F]}D.collapsed=(D.startContainer===D.endContainer&&D.startOffset===D.endOffset)}function v(F,I,E,J,G){var D=(F.startContainer!==I||F.startOffset!=E);var K=(F.endContainer!==J||F.endOffset!=G);var H=!F.equals(F.nativeRange);if(D||K||H){F.setEnd(J,G);F.setStart(I,E)}}function B(D){D.nativeRange.detach();D.detached=true;var E=A.length;while(E--){D[A[E]]=null}}var s;a=function(D){if(!D){throw e.createError("WrappedRange: Range must be specified")}this.nativeRange=D;q(this)};n.createPrototypeRange(a,v,B);t=a.prototype;t.selectNode=function(D){this.nativeRange.selectNode(D);q(this)};t.cloneContents=function(){return this.nativeRange.cloneContents()};t.surroundContents=function(D){this.nativeRange.surroundContents(D);q(this)};t.collapse=function(D){this.nativeRange.collapse(D);q(this)};t.cloneRange=function(){return new a(this.nativeRange.cloneRange())};t.refresh=function(){q(this)};t.toString=function(){return this.nativeRange.toString()};var z=document.createTextNode("test");k(document).appendChild(z);var w=document.createRange();w.setStart(z,0);w.setEnd(z,0);try{w.setStart(z,1);t.setStart=function(D,E){this.nativeRange.setStart(D,E);q(this)};t.setEnd=function(D,E){this.nativeRange.setEnd(D,E);q(this)};s=function(D){return function(E){this.nativeRange[D](E);q(this)}}}catch(y){t.setStart=function(E,F){try{this.nativeRange.setStart(E,F)}catch(D){this.nativeRange.setEnd(E,F);this.nativeRange.setStart(E,F)}q(this)};t.setEnd=function(E,F){try{this.nativeRange.setEnd(E,F)}catch(D){this.nativeRange.setStart(E,F);this.nativeRange.setEnd(E,F)}q(this)};s=function(D,E){return function(G){try{this.nativeRange[D](G)}catch(F){this.nativeRange[E](G);this.nativeRange[D](G)}q(this)}}}t.setStartBefore=s("setStartBefore","setEndBefore");t.setStartAfter=s("setStartAfter","setEndAfter");t.setEndBefore=s("setEndBefore","setStartBefore");t.setEndAfter=s("setEndAfter","setStartAfter");t.selectNodeContents=function(D){this.setStartAndEnd(D,0,i.getNodeLength(D))};w.selectNodeContents(z);w.setEnd(z,3);var C=document.createRange();C.selectNodeContents(z);C.setEnd(z,4);C.setStart(z,2);if(w.compareBoundaryPoints(w.START_TO_END,C)==-1&&w.compareBoundaryPoints(w.END_TO_START,C)==1){t.compareBoundaryPoints=function(E,D){D=D.nativeRange||D;if(E==D.START_TO_END){E=D.END_TO_START}else{if(E==D.END_TO_START){E=D.START_TO_END}}return this.nativeRange.compareBoundaryPoints(E,D)}}else{t.compareBoundaryPoints=function(E,D){return this.nativeRange.compareBoundaryPoints(E,D.nativeRange||D)}}var r=document.createElement("div");r.innerHTML="123";var u=r.firstChild;var x=k(document);x.appendChild(r);w.setStart(u,1);w.setEnd(u,2);w.deleteContents();if(u.data=="13"){t.deleteContents=function(){this.nativeRange.deleteContents();q(this)};t.extractContents=function(){var D=this.nativeRange.extractContents();q(this);return D}}else{}x.removeChild(r);x=null;if(j.isHostMethod(w,"createContextualFragment")){t.createContextualFragment=function(D){return this.nativeRange.createContextualFragment(D)}}k(document).removeChild(z);w.detach();C.detach();t.getName=function(){return"WrappedRange"};m.WrappedRange=a;m.createNativeRange=function(D){D=p(D,e,"createNativeRange");return D.createRange()}})()}if(m.features.implementsTextRange){var f=function(v){var t=v.parentElement();var r=v.duplicate();r.collapse(true);var u=r.parentElement();r=v.duplicate();r.collapse(false);var s=r.parentElement();var q=(u==s)?u:i.getCommonAncestor(u,s);return q==t?q:i.getCommonAncestor(t,q)};var c=function(q){return q.compareEndPoints("StartToEnd",q)==0};var g=function(q,C,A,r,u){var D=q.duplicate();D.collapse(A);var s=D.parentElement();if(!i.isOrIsAncestorOf(C,s)){s=C}if(!s.canHaveHTML){var z=new d(s.parentNode,i.getNodeIndex(s));return{boundaryPosition:z,nodeInfo:{nodeIndex:z.offset,containerElement:z.node}}}var t=i.getDocument(s).createElement("span");if(t.parentNode){t.parentNode.removeChild(t)}var L,J=A?"StartToStart":"StartToEnd";var E,v,B,F;var x=(u&&u.containerElement==s)?u.nodeIndex:0;var G=s.childNodes.length;var w=G;var I=w;while(true){if(I==G){s.appendChild(t)}else{s.insertBefore(t,s.childNodes[I])}D.moveToElementText(t);L=D.compareEndPoints(J,q);if(L==0||x==w){break}else{if(L==-1){if(w==x+1){break}else{x=I}}else{w=(w==x+1)?x:I}}I=Math.floor((x+w)/2);s.removeChild(t)}F=t.nextSibling;if(L==-1&&F&&l(F)){D.setEndPoint(A?"EndToStart":"EndToEnd",q);var y;if(/[\r\n]/.test(F.data)){var H=D.duplicate();var K=H.text.replace(/\r\n/g,"\r").length;y=H.moveStart("character",K);while((L=H.compareEndPoints("StartToEnd",H))==-1){y++;H.moveStart("character",1)}}else{y=D.text.length}B=new d(F,y)}else{E=(r||!A)&&t.previousSibling;v=(r||A)&&t.nextSibling;if(v&&l(v)){B=new d(v,0)}else{if(E&&l(E)){B=new d(E,E.data.length)}else{B=new d(s,i.getNodeIndex(t))}}}t.parentNode.removeChild(t);return{boundaryPosition:B,nodeInfo:{nodeIndex:I,containerElement:s}}};var o=function(q,s){var t,w,u=q.offset;var x=i.getDocument(q.node);var r,y,z=k(x).createTextRange();var v=l(q.node);if(v){t=q.node;w=t.parentNode}else{y=q.node.childNodes;t=(u<y.length)?y[u]:null;w=q.node}r=x.createElement("span");r.innerHTML="&#feff;";if(t){w.insertBefore(r,t)}else{w.appendChild(r)}z.moveToElementText(r);z.collapse(!s);w.removeChild(r);if(v){z[s?"moveStart":"moveEnd"]("character",u)}return z};b=function(q){this.textRange=q;this.refresh()};b.prototype=new n(document);b.prototype.refresh=function(){var t,q,s;var r=f(this.textRange);if(c(this.textRange)){q=t=g(this.textRange,r,true,true).boundaryPosition}else{s=g(this.textRange,r,true,false);t=s.boundaryPosition;q=g(this.textRange,r,false,false,s.nodeInfo).boundaryPosition}this.setStart(t.node,t.offset);this.setEnd(q.node,q.offset)};b.prototype.getName=function(){return"WrappedTextRange"};n.copyComparisonConstants(b);b.rangeToTextRange=function(q){if(q.collapsed){return o(new d(q.startContainer,q.startOffset),true)}else{var t=o(new d(q.startContainer,q.startOffset),true);var s=o(new d(q.endContainer,q.endOffset),false);var r=k(n.getRangeDocument(q)).createTextRange();r.setEndPoint("StartToStart",t);r.setEndPoint("EndToEnd",s);return r}};m.WrappedTextRange=b;if(!m.features.implementsDomRange||m.config.preferTextRange){var h=(function(){return this})();if(typeof h.Range=="undefined"){h.Range=b}m.createNativeRange=function(q){q=p(q,e,"createNativeRange");return k(q).createTextRange()};m.WrappedRange=b}}m.createRange=function(q){q=p(q,e,"createRange");return new m.WrappedRange(m.createNativeRange(q))};m.createRangyRange=function(q){q=p(q,e,"createRangyRange");return new n(q)};m.createIframeRange=function(q){e.deprecationNotice("createIframeRange()","createRange(iframeEl)");return m.createRange(q)};m.createIframeRangyRange=function(q){e.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)");return m.createRangyRange(q)};m.addCreateMissingNativeApiListener(function(r){var q=r.document;if(typeof q.createRange=="undefined"){q.createRange=function(){return m.createRange(q)}}q=r=null})});rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(j,d){j.config.checkSelectionRanges=true;var I="boolean";var L="number";var c=j.dom;var o=j.util;var W=o.isHostMethod;var aa=j.DomRange;var f=j.WrappedRange;var V=j.DOMException;var D=c.DomPosition;var S;var q;var n=j.features;var ai="Control";var ah=c.getDocument;var ag=c.getBody;var N=aa.rangesEqual;function g(ak){return(typeof ak=="string")?/^backward(s)?$/i.test(ak):!!ak}function z(am,ak){if(!am){return window}else{if(c.isWindow(am)){return am}else{if(am instanceof F){return am.win}else{var al=c.getContentDocument(am,d,ak);return c.getWindow(al)}}}}function p(ak){return z(ak,"getWinSelection").getSelection()}function t(ak){return z(ak,"getDocSelection").document.selection}function af(ak){var al=false;if(ak.anchorNode){al=(c.comparePoints(ak.anchorNode,ak.anchorOffset,ak.focusNode,ak.focusOffset)==1)}return al}var ad=W(window,"getSelection"),U=o.isHostObject(document,"selection");n.implementsWinGetSelection=ad;n.implementsDocSelection=U;var w=U&&(!ad||j.config.preferTextRange);if(w){S=t;j.isSelectionValid=function(al){var am=z(al,"isSelectionValid").document,ak=am.selection;return(ak.type!="None"||ah(ak.createRange().parentElement())==am)}}else{if(ad){S=p;j.isSelectionValid=function(){return true}}else{d.fail("Neither document.selection or window.getSelection() detected.")}}j.getNativeSelection=S;var T=S();var G=j.createNativeRange(document);var H=ag(document);var Q=o.areHostProperties(T,["anchorNode","focusNode","anchorOffset","focusOffset"]);n.selectionHasAnchorAndFocus=Q;var s=W(T,"extend");n.selectionHasExtend=s;var aj=(typeof T.rangeCount==L);n.selectionHasRangeCount=aj;var Z=false;var X=true;var A=s?function(an,ak){var am=aa.getRangeDocument(ak);var al=j.createRange(am);al.collapseToPoint(ak.endContainer,ak.endOffset);an.addRange(P(al));an.extend(ak.startContainer,ak.startOffset)}:null;if(o.areHostMethods(T,["addRange","getRangeAt","removeAllRanges"])&&typeof T.rangeCount==L&&n.implementsDomRange){(function(){var al=window.getSelection();if(al){var ap=al.rangeCount;var ar=(ap>1);var au=[];var av=af(al);for(var aq=0;aq<ap;++aq){au[aq]=al.getRangeAt(aq)}var at=ag(document);var ao=at.appendChild(document.createElement("div"));ao.contentEditable="false";var an=ao.appendChild(document.createTextNode("\u00a0\u00a0\u00a0"));var am=document.createRange();am.setStart(an,1);am.collapse(true);al.addRange(am);X=(al.rangeCount==1);al.removeAllRanges();if(!ar){var ak=am.cloneRange();am.setStart(an,0);ak.setEnd(an,3);ak.setStart(an,2);al.addRange(am);al.addRange(ak);Z=(al.rangeCount==2);ak.detach()}at.removeChild(ao);al.removeAllRanges();am.detach();for(aq=0;aq<ap;++aq){if(aq==0&&av){if(A){A(al,au[aq])}else{j.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because browser does not support Selection.extend");al.addRange(au[aq])}}else{al.addRange(au[aq])}}}})()}n.selectionSupportsMultipleRanges=Z;n.collapsedNonEditableSelectionsSupported=X;var i=false,l;if(H&&W(H,"createControlRange")){l=H.createControlRange();if(o.areHostProperties(l,["item","add"])){i=true}}n.implementsControlRange=i;if(Q){q=function(ak){return ak.anchorNode===ak.focusNode&&ak.anchorOffset===ak.focusOffset}}else{q=function(ak){return ak.rangeCount?ak.getRangeAt(ak.rangeCount-1).collapsed:false}}function b(am,ak,an){var al=an?"end":"start",ao=an?"start":"end";am.anchorNode=ak[al+"Container"];am.anchorOffset=ak[al+"Offset"];am.focusNode=ak[ao+"Container"];am.focusOffset=ak[ao+"Offset"]}function y(al){var ak=al.nativeSelection;al.anchorNode=ak.anchorNode;al.anchorOffset=ak.anchorOffset;al.focusNode=ak.focusNode;al.focusOffset=ak.focusOffset}function M(ak){ak.anchorNode=ak.focusNode=null;ak.anchorOffset=ak.focusOffset=0;ak.rangeCount=0;ak.isCollapsed=true;ak._ranges.length=0}function P(ak){var al;if(ak instanceof aa){al=j.createNativeRange(ak.getDocument());al.setEnd(ak.endContainer,ak.endOffset);al.setStart(ak.startContainer,ak.startOffset)}else{if(ak instanceof f){al=ak.nativeRange}else{if(n.implementsDomRange&&(ak instanceof c.getWindow(ak.startContainer).Range)){al=ak}}}return al}function m(am){if(!am.length||am[0].nodeType!=1){return false}for(var al=1,ak=am.length;al<ak;++al){if(!c.isAncestorOf(am[0],am[al])){return false}}return true}function R(al){var ak=al.getNodes();if(!m(ak)){throw d.createError("getSingleElementFromRange: range "+al.inspect()+" did not consist of a single element")}return ak[0]}function K(ak){return !!ak&&typeof ak.text!="undefined"}function O(am,al){var ak=new f(al);am._ranges=[ak];b(am,ak,false);am.rangeCount=1;am.isCollapsed=ak.collapsed}function v(an){an._ranges.length=0;if(an.docSelection.type=="None"){M(an)}else{var am=an.docSelection.createRange();if(K(am)){O(an,am)}else{an.rangeCount=am.length;var ak,ao=ah(am.item(0));for(var al=0;al<an.rangeCount;++al){ak=j.createRange(ao);ak.selectNode(am.item(al));an._ranges.push(ak)}an.isCollapsed=an.rangeCount==1&&an._ranges[0].collapsed;b(an,an._ranges[an.rangeCount-1],false)}}}function C(al,ao){var am=al.docSelection.createRange();var ak=R(ao);var at=ah(am.item(0));var ap=ag(at).createControlRange();for(var an=0,aq=am.length;an<aq;++an){ap.add(am.item(an))}try{ap.add(ak)}catch(ar){throw d.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}ap.select();v(al)}var r;if(W(T,"getRangeAt")){r=function(am,ak){try{return am.getRangeAt(ak)}catch(al){return null}}}else{if(Q){r=function(al){var am=ah(al.anchorNode);var ak=j.createRange(am);ak.setStartAndEnd(al.anchorNode,al.anchorOffset,al.focusNode,al.focusOffset);if(ak.collapsed!==this.isCollapsed){ak.setStartAndEnd(al.focusNode,al.focusOffset,al.anchorNode,al.anchorOffset)}return ak}}}function F(ak,am,al){this.nativeSelection=ak;this.docSelection=am;this._ranges=[];this.win=al;this.refresh()}F.prototype=j.selectionPrototype;function B(ak){ak.win=ak.anchorNode=ak.focusNode=ak._ranges=null;ak.rangeCount=ak.anchorOffset=ak.focusOffset=0;ak.detached=true}var ae=[];function Y(ao,an){var ak=ae.length,al,am;while(ak--){al=ae[ak];am=al.selection;if(an=="deleteAll"){B(am)}else{if(al.win==ao){if(an=="delete"){ae.splice(ak,1);return true}else{return am}}}}if(an=="deleteAll"){ae.length=0}return null}var x=function(am){if(am&&am instanceof F){am.refresh();return am}am=z(am,"getNativeSelection");var al=Y(am);var ak=S(am),an=U?t(am):null;if(al){al.nativeSelection=ak;al.docSelection=an;al.refresh()}else{al=new F(ak,an,am);ae.push({win:am,selection:al})}return al};j.getSelection=x;j.getIframeSelection=function(ak){d.deprecationNotice("getIframeSelection()","getSelection(iframeEl)");return j.getSelection(c.getIframeWindow(ak))};var a=F.prototype;function k(aq,al){var ar=ah(al[0].startContainer);var ao=ag(ar).createControlRange();for(var an=0,ap,ak=al.length;an<ak;++an){ap=R(al[an]);try{ao.add(ap)}catch(am){throw d.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}ao.select();v(aq)}if(!w&&Q&&o.areHostMethods(T,["removeAllRanges","addRange"])){a.removeAllRanges=function(){this.nativeSelection.removeAllRanges();M(this)};var e=function(al,ak){A(al.nativeSelection,ak);al.refresh()};if(aj){a.addRange=function(ak,an){if(i&&U&&this.docSelection.type==ai){C(this,ak)}else{if(g(an)&&s){e(this,ak)}else{var al;if(Z){al=this.rangeCount}else{this.removeAllRanges();al=0}this.nativeSelection.addRange(P(ak).cloneRange());this.rangeCount=this.nativeSelection.rangeCount;if(this.rangeCount==al+1){if(j.config.checkSelectionRanges){var am=r(this.nativeSelection,this.rangeCount-1);if(am&&!N(am,ak)){ak=new f(am)}}this._ranges[this.rangeCount-1]=ak;b(this,ak,h(this.nativeSelection));this.isCollapsed=q(this)}else{this.refresh()}}}}}else{a.addRange=function(ak,al){if(g(al)&&s){e(this,ak)}else{this.nativeSelection.addRange(P(ak));this.refresh()}}}a.setRanges=function(al){if(i&&al.length>1){k(this,al)}else{this.removeAllRanges();for(var am=0,ak=al.length;am<ak;++am){this.addRange(al[am])}}}}else{if(W(T,"empty")&&W(G,"select")&&i&&w){a.removeAllRanges=function(){try{this.docSelection.empty();if(this.docSelection.type!="None"){var an;if(this.anchorNode){an=ah(this.anchorNode)}else{if(this.docSelection.type==ai){var al=this.docSelection.createRange();if(al.length){an=ah(al.item(0))}}}if(an){var am=ag(an).createTextRange();am.select();this.docSelection.empty()}}}catch(ak){}M(this)};a.addRange=function(ak){if(this.docSelection.type==ai){C(this,ak)}else{j.WrappedTextRange.rangeToTextRange(ak).select();this._ranges[0]=ak;this.rangeCount=1;this.isCollapsed=this._ranges[0].collapsed;b(this,ak,false)}};a.setRanges=function(ak){this.removeAllRanges();var al=ak.length;if(al>1){k(this,ak)}else{if(al){this.addRange(ak[0])}}}}else{d.fail("No means of selecting a Range or TextRange was found");return false}}a.getRangeAt=function(ak){if(ak<0||ak>=this.rangeCount){throw new V("INDEX_SIZE_ERR")}else{return this._ranges[ak].cloneRange()}};var J;if(w){J=function(al){var ak;if(j.isSelectionValid(al.win)){ak=al.docSelection.createRange()}else{ak=ag(al.win.document).createTextRange();ak.collapse(true)}if(al.docSelection.type==ai){v(al)}else{if(K(ak)){O(al,ak)}else{M(al)}}}}else{if(W(T,"getRangeAt")&&typeof T.rangeCount==L){J=function(am){if(i&&U&&am.docSelection.type==ai){v(am)}else{am._ranges.length=am.rangeCount=(am.nativeSelection&&am.nativeSelection.rangeCount)||0;if(am.rangeCount){for(var al=0,ak=am.rangeCount;al<ak;++al){am._ranges[al]=new j.WrappedRange(am.nativeSelection.getRangeAt(al))}b(am,am._ranges[am.rangeCount-1],h(am.nativeSelection));am.isCollapsed=q(am)}else{M(am)}}}}else{if(Q&&typeof T.isCollapsed==I&&typeof G.collapsed==I&&n.implementsDomRange){J=function(am){var ak,al=am.nativeSelection;if(al.anchorNode){ak=r(al,0);am._ranges=[ak];am.rangeCount=1;y(am);am.isCollapsed=q(am)}else{M(am)}}}else{d.fail("No means of obtaining a Range or TextRange from the user's selection was found");return false}}}a.refresh=function(al){var ak=al?this._ranges.slice(0):null;var an=this.anchorNode,ao=this.anchorOffset;J(this);if(al){var am=ak.length;if(am!=this._ranges.length){return true}if(this.anchorNode!=an||this.anchorOffset!=ao){return true}while(am--){if(!N(ak[am],this._ranges[am])){return true}}return false}};var E=function(ao,am){var al=ao.getAllRanges();ao.removeAllRanges();for(var an=0,ak=al.length;an<ak;++an){if(!N(am,al[an])){ao.addRange(al[an])}}if(!ao.rangeCount){M(ao)}};if(i){a.removeRange=function(ao){if(this.docSelection.type==ai){var am=this.docSelection.createRange();var ak=R(ao);var at=ah(am.item(0));var aq=ag(at).createControlRange();var al,ar=false;for(var an=0,ap=am.length;an<ap;++an){al=am.item(an);if(al!==ak||ar){aq.add(am.item(an))}else{ar=true}}aq.select();v(this)}else{E(this,ao)}}}else{a.removeRange=function(ak){E(this,ak)}}var h;if(!w&&Q&&n.implementsDomRange){h=af;a.isBackward=function(){return h(this)}}else{h=a.isBackward=function(){return false}}a.isBackwards=a.isBackward;a.toString=function(){var am=[];for(var al=0,ak=this.rangeCount;al<ak;++al){am[al]=""+this._ranges[al]}return am.join("")};function ab(al,ak){if(al.win.document!=ah(ak)){throw new V("WRONG_DOCUMENT_ERR")}}a.collapse=function(al,am){ab(this,al);var ak=j.createRange(al);ak.collapseToPoint(al,am);this.setSingleRange(ak);this.isCollapsed=true};a.collapseToStart=function(){if(this.rangeCount){var ak=this._ranges[0];this.collapse(ak.startContainer,ak.startOffset)}else{throw new V("INVALID_STATE_ERR")}};a.collapseToEnd=function(){if(this.rangeCount){var ak=this._ranges[this.rangeCount-1];this.collapse(ak.endContainer,ak.endOffset)}else{throw new V("INVALID_STATE_ERR")}};a.selectAllChildren=function(al){ab(this,al);var ak=j.createRange(al);ak.selectNodeContents(al);this.setSingleRange(ak)};a.deleteFromDocument=function(){if(i&&U&&this.docSelection.type==ai){var ao=this.docSelection.createRange();var an;while(ao.length){an=ao.item(0);ao.remove(an);an.parentNode.removeChild(an)}this.refresh()}else{if(this.rangeCount){var al=this.getAllRanges();if(al.length){this.removeAllRanges();for(var am=0,ak=al.length;am<ak;++am){al[am].deleteContents()}this.addRange(al[ak-1])}}}};a.eachRange=function(an,am){for(var al=0,ak=this._ranges.length;al<ak;++al){if(an(this.getRangeAt(al))){return am}}};a.getAllRanges=function(){var ak=[];this.eachRange(function(al){ak.push(al)});return ak};a.setSingleRange=function(ak,al){this.removeAllRanges();this.addRange(ak,al)};a.callMethodOnEachRange=function(ak,am){var al=[];this.eachRange(function(an){al.push(an[ak].apply(an,am))});return al};function ac(ak){return function(am,an){var al;if(this.rangeCount){al=this.getRangeAt(0);al["set"+(ak?"Start":"End")](am,an)}else{al=j.createRange(this.win.document);al.setStartAndEnd(am,an)}this.setSingleRange(al,this.isBackward())}}a.setStart=ac(true);a.setEnd=ac(false);j.rangePrototype.select=function(ak){x(this.getDocument()).setSingleRange(this,ak)};a.changeEachRange=function(al){var ak=[];var am=this.isBackward();this.eachRange(function(an){al(an);ak.push(an)});this.removeAllRanges();if(am&&ak.length==1){this.addRange(ak[0],"backward")}else{this.setRanges(ak)}};a.containsNode=function(al,ak){return this.eachRange(function(am){return am.containsNode(al,ak)},true)};a.getBookmark=function(ak){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[ak])}};a.moveToBookmark=function(ao){var ak=[];for(var an=0,am,al;am=ao.rangeBookmarks[an++];){al=j.createRange(this.win);al.moveToBookmark(am);ak.push(al)}if(ao.backward){this.setSingleRange(ak[0],"backward")}else{this.setRanges(ak)}};a.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")};function u(aq){var ap=[];var an=new D(aq.anchorNode,aq.anchorOffset);var al=new D(aq.focusNode,aq.focusOffset);var am=(typeof aq.getName=="function")?aq.getName():"Selection";if(typeof aq.rangeCount!="undefined"){for(var ao=0,ak=aq.rangeCount;ao<ak;++ao){ap[ao]=aa.inspect(aq.getRangeAt(ao))}}return"["+am+"(Ranges: "+ap.join(", ")+")(anchor: "+an.inspect()+", focus: "+al.inspect()+"]"}a.getName=function(){return"WrappedSelection"};a.inspect=function(){return u(this)};a.detach=function(){Y(this.win,"delete");B(this)};F.detachAll=function(){Y(null,"deleteAll")};F.inspect=u;F.isDirectionBackward=g;j.Selection=F;j.selectionPrototype=a;j.addCreateMissingNativeApiListener(function(ak){if(typeof ak.getSelection=="undefined"){ak.getSelection=function(){return x(ak)}}ak=null})});(function(){var b=this,f,d;f={attributes:{changeId:"data-cid",userId:"data-userid",userName:"data-username",time:"data-time",changeData:"data-changedata",},attrValuePrefix:"",blockEl:"p",blockEls:["div","p","ol","ul","li","h1","h2","h3","h4","h5","h6","blockquote"],stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"span",alias:"ins",action:"Inserted"},deleteType:{tag:"span",alias:"del",action:"Deleted"}},handleEvents:false,contentEditable:undefined,_isTracking:true,noTrack:".ice-no-track",tooltips:false,tooltipsDelay:200,mergeBlocks:true,_isVisible:true,_changeData:null,_handleSelectAll:false,};d=function(h){h||(h={});if(!h.element){throw new Error("`options.element` must be defined for ice construction.")}this._changes={};this._userStyles={};this._styles={};this._refreshInterval=null;this.$this=jQuery(this);this._browser=ice.dom.browser();this._tooltipMouseOver=this._tooltipMouseOver.bind(this);this._tooltipMouseOut=this._tooltipMouseOut.bind(this);ice.dom.extend(true,this,f,h);if(h.tooltips&&(!jQuery.isFunction(h.hostMethods.showTooltip)||!jQuery.isFunction(h.hostMethods.hideTooltip))){throw new Error("hostMethods.showTooltip and hostMethods.hideTooltip must be defined if tooltips is true")}var i=h.userStyles||{};for(var j in i){if(i.hasOwnProperty(j)){var g=i[j];if(!isNaN(g)){this._userStyles[j]=this.stylePrefix+"-"+g;this._uniqueStyleIndex=Math.max(g,this._uniqueStyleIndex);this._styles[g]=true}}}};d.prototype={_uniqueStyleIndex:0,_browserType:null,_batchChangeId:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:false,startTracking:function(){if(typeof(this.contentEditable)=="boolean"){this.element.setAttribute("contentEditable",this.contentEditable)}if(this.handleEvents){var g=this;ice.dom.bind(g.element,"keyup.ice keydown.ice keypress.ice",function(h){return g.handleEvent(h)})}this.initializeEnvironment();this.initializeEditor();this.initializeRange();this._updateTooltipsState();return this},stopTracking:function(h){this._isTracking=false;try{if(this.element){ice.dom.unbind(this.element,"keyup.ice keydown.ice keypress.ice")}if(!h&&(typeof(this.contentEditable)!="undefined")){this.element.setAttribute("contentEditable",!this.contentEditable)}}catch(g){}this._updateTooltipsState();return this},initializeEnvironment:function(){this.env||(this.env={});this.env.element=this.element;this.env.document=this.element.ownerDocument;this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window;this.env.frame=this.env.window.frameElement;this.env.selection=this.selection=new ice.Selection(this.env);this.env.document.createElement(this.changeTypes.insertType.tag);this.env.document.createElement(this.changeTypes.deleteType.tag)},initializeRange:function(){},initializeEditor:function(){this._loadFromDom();this._updateTooltipsState()},isTracking:function(){return this._isTracking},enableChangeTracking:function(){this._isTracking=true},disableChangeTracking:function(){this._isTracking=false},toggleChangeTracking:function(g){g=(undefined===g)?!this._isTracking:!!g;this._isTracking=g},setCurrentUser:function(g){this.currentUser=g;this._updateUserData(g)},toggleTooltips:function(g){g=(undefined===g)?!this.tooltips:!!g;this.tooltips=g;this._updateTooltipsState()},handleEvent:function(h){if(!this._isTracking){return true}if(h.type=="keypress"){var g=this.keyPress(h);if(!g){h.preventDefault()}return g}else{if(h.type=="keydown"){var g=this.keyDown(h);if(!g){h.preventDefault()}return g}}},visible:function(g){if(g.nodeType===ice.dom.TEXT_NODE){g=g.parentNode}var h=g.getBoundingClientRect();return(h.top>0&&h.left>0)},_createIceNode:function(g,h){var i=this.env.document.createElement(this.changeTypes[g].tag);ice.dom.addClass(i,this._getIceNodeClass(g));if(h){i.appendChild(h)}this._addChange(this.changeTypes[g].alias,[i]);return i},insert:function(i){this.hostMethods.beforeInsert&&this.hostMethods.beforeInsert();var h=this.getCurrentRange(),j=h?null:this.hostMethods.getHostRange(),l=this.startBatchChange(),g=!!(h&&!h.collapsed);try{if(g){this._deleteContents(false,h);h=this.getCurrentRange()}if(h||j){if(i&&!jQuery.isArray(i)){i=[i]}this._moveRangeToValidTrackingPos(h,j);this._insertNodes(h,j,i)}}catch(k){a.log(k)}finally{this.endBatchChange(l)}return true},_deleteContents:function(j,h){var g=true,i=this._browser;this.hostMethods.beforeDelete&&this.hostMethods.beforeDelete();if(h){this.selection.addRange(h)}else{h=this.getCurrentRange()}var m=this.startBatchChange();try{if(h.collapsed===false){h=this._deleteSelection(h);if(!this.visible(h.endContainer)){h.setEnd(h.endContainer,Math.max(0,h.endOffset-1));h.collapse(false)}}else{if(j){if(i.type==="mozilla"){g=this._deleteRight(h);if(!this.visible(h.endContainer)){if(h.endContainer.parentNode.nextSibling){h.setEndBefore(h.endContainer.parentNode.nextSibling)}else{h.setEndAfter(h.endContainer)}h.collapse(false)}}else{if(h.endOffset===ice.dom.getNodeCharacterLength(h.endContainer)){var k=h.startContainer.nextSibling;if(ice.dom.is(k,"."+this._getIceNodeClass("deleteType"))){while(k){if(ice.dom.is(k,"."+this._getIceNodeClass("deleteType"))){k=k.nextSibling;continue}h.setStart(k,0);h.collapse(true);break}}}g=this._deleteRight(h);if(!this.visible(h.endContainer)){if(ice.dom.is(h.endContainer.parentNode,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))){h.setStartAfter(h.endContainer.parentNode);h.collapse(true)}}}}else{if(i.mozilla){g=this._deleteLeft(h);if(!this.visible(h.startContainer)){if(h.startContainer.parentNode.previousSibling){h.setEnd(h.startContainer.parentNode.previousSibling,0)}else{h.setEnd(h.startContainer.parentNode,0)}h.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(h.endContainer));h.collapse(false)}}else{if(!this.visible(h.startContainer)){if(h.endOffset===ice.dom.getNodeCharacterLength(h.endContainer)){var l=h.startContainer.previousSibling;if(ice.dom.is(l,"."+this._getIceNodeClass("deleteType"))){while(l){if(ice.dom.is(l,"."+this._getIceNodeClass("deleteType"))){l=l.prevSibling;continue}h.setEndBefore(l.nextSibling,0);h.collapse(false);break}}}}g=this._deleteLeft(h)}}}this.selection.addRange(h)}finally{this.endBatchChange(m)}return g},getChanges:function(){return this._changes},getChangeUserids:function(){var g=[];var i=Object.keys(this._changes);for(var h in i){g.push(this._changes[i[h]].userid)}return g.sort().filter(function(l,k,j){if(k==j.indexOf(l)){return 1}return 0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(g,j,h){var i=this.getCleanDOM(g,{callback:j,prepare:prepace,clone:true});return(i&&i.innerHTML)||""},getCleanDOM:function(g,i){var j="",h=this;i=i||{};ice.dom.each(this.changeTypes,function(l,k){if(l!="deleteType"){if(k>0){j+=","}j+="."+h._getIceNodeClass(l)}});if(g){if(typeof g==="string"){g=ice.dom.create("<div>"+g+"</div>")}else{if(i.clone){g=ice.dom.cloneNode(g,false)[0]}}}else{g=i.clone?ice.dom.cloneNode(this.element,false)[0]:this.element}return this._cleanBody(g,j,i)},_cleanBody:function(g,k,h){g=h.prepare?h.prepare.call(this,g):g;var i=ice.dom.find(g,k);ice.dom.each(i,function(l,m){while(m.firstChild){m.parentNode.insertBefore(m.firstChild,m)}m.parentNode.removeChild(m)});var j=ice.dom.find(g,"."+this._getIceNodeClass("deleteType"));ice.dom.remove(j);g=h.callback?h.callback.call(this,g):g;return g},acceptAll:function(g){if(g){return this._acceptRejectSome(g,true)}else{this.getCleanDOM(this.element,{clone:false});this._changes={};this._triggerChange()}},rejectAll:function(i){if(i){return this._acceptRejectSome(i,false)}else{var k="."+this._getIceNodeClass("insertType"),g="."+this._getIceNodeClass("deleteType"),h=this,j;ice.dom.remove(ice.dom.find(this.element,k));ice.dom.each(ice.dom.find(this.element,g),function(l,m){j=ice.dom.contents(m);ice.dom.replaceWith(m,j);jQuery.each(j,function(n,p){var o=p&&p.parentNode;h._normalizeNode(o)})});this._changes={};this._triggerChange()}},acceptChange:function(g){this.acceptRejectChange(g,true)},rejectChange:function(g){this.acceptRejectChange(g,false)},acceptRejectChange:function(j,q){var t,p,k,s,h,g,o,l=ice.dom,n,i,r=this;if(!j){var m=this.getCurrentRange();if(!m.collapsed){return}j=m.startContainer}t=s="."+this._getIceNodeClass("deleteType");p=h="."+this._getIceNodeClass("insertType");if(!q){s=p;h=t}k=t+","+p;g=l.getNode(j,k);i=l.attr(g,this.attributes.changeId);o=l.find(this.element,s+"["+this.attributes.changeId+"="+i+"]");n=o.length;l.remove(o);o=l.find(this.element,h+"["+this.attributes.changeId+"="+i+"]");n+=o.length;l.each(o,function(u,v){content=ice.dom.contents(v);l.replaceWith(v,content);jQuery.each(content,function(w,y){var x=y&&y.parentNode;r._normalizeNode(x)})});delete this._changes[i];if(n>0){this._triggerChange()}},isInsideChange:function(g){try{return !!this.currentChangeNode(g)}catch(h){return false}},_getIceNode:function(i,h){var g="."+this._getIceNodeClass(h);return ice.dom.getNode((i&&i.$)||i,g)},_moveRangeToValidTrackingPos:function(n,j){if(!(n=(j||n))){return}var g,h,l=-1,i,p=[],q,m,k=j?this.hostMethods.getHostNode:e,r=false;while(!r){h=n.startContainer;if(!h||p.indexOf(h)>=0){return}i=k(h);p.push(h);g=this._getVoidElement(i);if(g){if((g!=h)&&(p.indexOf(g)>=0)){return}p.push(g)}else{r=ice.dom.isTextContainer(i)}if(!r){if(-1==l){l=!c(k(n.startContainer),n.startOffset)}q=l?ice.dom.findPrevTextContainer(g||i,this.element):ice.dom.findNextTextContainer(g||i,this.element);m=q.node;if(j){m=this.hostMethods.makeHostElement(m)}try{if(l){n.setStart(m,q.offset)}else{n.setEnd(m,q.offset)}n.collapse(l)}catch(o){break}}}},_getNoTrackElement:function(i){var h=this._getNoTrackSelector();var g=ice.dom.is(i,h)?i:(ice.dom.parents(i,h)[0]||null);return g},_getNoTrackSelector:function(){return this.noTrack},_getVoidElement:function(i){try{var h=this._getVoidElSelector(),g=ice.dom.is(i,h)?i:(ice.dom.parents(i,h)[0]||null);if(!g){if(3==i.nodeType&&i.nodeValue=="\u200B"){return i}}return g}catch(j){return null}},_getVoidElSelector:function(){return"."+this._getIceNodeClass("deleteType")},_currentUserIceNode:function(g){return ice.dom.attr(g,this.attributes.userId)==this.currentUser.id},_getChangeTypeFromAlias:function(h){var i,g=null;for(i in this.changeTypes){if(this.changeTypes.hasOwnProperty(i)){if(this.changeTypes[i].alias==h){g=i}}}return g},_getIceNodeClass:function(g){return this.attrValuePrefix+this.changeTypes[g].alias},_getUserStyle:function(g){if(g===null||g===""||"undefined"==typeof g){return this.stylePrefix}var h=null;if(this._userStyles[g]){h=this._userStyles[g]}else{h=this._setUserStyle(g,this._getNewStyleId())}return h},_setUserStyle:function(g,i){var h=this.stylePrefix+"-"+i;if(!this._styles[i]){this._styles[i]=true}return this._userStyles[g]=h},_getNewStyleId:function(){var g=++this._uniqueStyleIndex;if(this._styles[g]){return this._getNewStyleId()}else{this._styles[g]=true;return g}},_addChange:function(h,j){var i=this._batchChangeId||this.getNewChangeId(),g=this;if(!this._changes[i]){this._changes[i]={type:this._getChangeTypeFromAlias(h),time:(new Date()).getTime(),userid:String(this.currentUser.id),username:this.currentUser.name,data:this._changeData||""};this._triggerChange()}ice.dom.foreach(j,function(k){g._addNodeToChange(i,j[k])});return i},_addNodeToChange:function(k,j){k=this._batchChangeId||k;var l=this.getChange(k);if(!j.getAttribute(this.attributes.changeId)){j.setAttribute(this.attributes.changeId,k)}var h=j.getAttribute(this.attributes.userId);if(!h){j.setAttribute(this.attributes.userId,h=l.userid)}if(h==l.userid){j.setAttribute(this.attributes.userName,l.username)}var g=j.getAttribute(this.attributes.changeData);if(null==g){j.setAttribute(this.attributes.changeData,this._changeData||"")}if(!j.getAttribute(this.attributes.time)){j.setAttribute(this.attributes.time,l.time)}var i=this._getUserStyle(l.userid);if(!ice.dom.hasClass(j,i)){ice.dom.addClass(j,i)}this._updateNodeTooltip(j)},getChange:function(g){return this._changes[g]||null},getNewChangeId:function(){var g=++this._uniqueIDIndex;if(this._changes[g]){g=this.getNewChangeId()}return g},startBatchChange:function(){return this._batchChangeId?null:(this._batchChangeId=this.getNewChangeId())},endBatchChange:function(g){if(g&&(g===this._batchChangeId)){this._batchChangeId=null;this._triggerChangeText()}},getCurrentRange:function(){try{return this.selection.getRangeAt(0)}catch(g){return null}},_insertNodes:function(g,r,s){var p=r||g,w=p.startContainer,m=(w&&w.$)||w,x=r?this.hostMethods.makeHostElement:e;var q=this._getIceNode(m,"insertType"),k=this._currentUserIceNode(q);if(k){var n=s&&s[0];if(n){p.insertNode(x(n));var o=n.parentNode,y=n.nextSibling;for(var u=1;u<s.length;++u){if(y){o.insertBefore(s[u],y)}else{o.appendChild(s[u])}}}}else{var t=this._createIceNode("insertType");if(q){var h=q.childNodes.length;this._normalizeNode(q);if(h!=q.childNodes.length){if(r){r=p=this.hostMethods.getHostRange()}else{p=this.getCurrentRange()}}if(q){var l=(r&&r.endContainer.$)||p.endContainer;if((l.nodeType==3&&p.endOffset<p.endContainer.length)||(l!=q.lastChild)){q=this._splitNode(q,p.endContainer,p.endOffset)}}}if(q){p.setStartAfter(x(q));p.collapse(true)}p.insertNode(x(t));var v=(s&&s.length)||0;if(v){for(var u=0;u<v;++u){t.appendChild(s[u])}p.setStartAfter(x(t.lastChild))}else{var j=this.element.ownerDocument.createTextNode("\uFEFF");t.appendChild(j);j=x(j);p.setStartAndEnd(j,0,j,1)}if(r){this.hostMethods.setHostRange(r)}else{this.selection.addRange(p)}}},_handleVoidEl:function(h,g){var i=h&&this._getVoidElement(h);if(i&&!this._getIceNode(i,"deleteType")){g.collapse(true);return true}return false},_deleteSelection:function(q){var r=new ice.Bookmark(this.env,q),g=ice.dom.getElementsBetween(r.start,r.end),t=ice.dom.parents(q.startContainer,this.blockEls.join(", "))[0],s=ice.dom.parents(q.endContainer,this.blockEls.join(", "))[0],u=new Array();for(var p=0;p<g.length;p++){var m=g[p];if(ice.dom.isBlockElement(m)){u.push(m);if(!ice.dom.canContainTextElement(m)){for(var n=0;n<m.childNodes.length;n++){g.push(m.childNodes[n])}continue}}if(m.nodeType===ice.dom.TEXT_NODE&&ice.dom.getNodeTextContent(m).length===0){continue}if(!this._getVoidElement(m)){if(m.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(m)){continue}if(ice.dom.isStubElement(m)){this._addNodeTracking(m,false,true);continue}if(ice.dom.hasNoTextOrStubContent(m)){ice.dom.remove(m)}for(var o=0;o<m.childNodes.length;o++){var l=m.childNodes[o];g.push(l)}continue}var h=ice.dom.getBlockParent(m);this._addNodeTracking(m,false,true);if(ice.dom.hasNoTextOrStubContent(h)){ice.dom.remove(h)}}}if(this.mergeBlocks&&t!==s){while(u.length){ice.dom.mergeContainers(u.shift(),t)}ice.dom.mergeContainers(s,t)}r.selectBookmark();q=this.getCurrentRange();q.collapse(true);return q},_deleteRight:function(t){var j=ice.dom.isBlockElement(t.startContainer)&&t.startContainer||ice.dom.getBlockParent(t.startContainer,this.element)||null,u=j?(ice.dom.hasNoTextOrStubContent(j)):false,r=j&&ice.dom.getNextContentNode(j,this.element),v=r?(ice.dom.hasNoTextOrStubContent(r)):false,o=t.endContainer,n=t.endOffset,k=t.commonAncestorContainer,p,z;if(u){return false}if(k.nodeType!==ice.dom.TEXT_NODE){if(n===0&&ice.dom.isBlockElement(k)&&(!ice.dom.canContainTextElement(k))){var x=k.firstElementChild;if(x){t.setStart(x,0);t.collapse();return this._deleteRight(t)}}if(k.childNodes.length>n){var l=document.createTextNode(" ");k.insertBefore(l,k.childNodes[n]);t.setStart(l,1);t.collapse(true);z=this._deleteRight(t);ice.dom.remove(l);return z}else{p=ice.dom.getNextContentNode(k,this.element);t.setEnd(p,0);t.collapse();return this._deleteRight(t)}}t.moveEnd(ice.dom.CHARACTER_UNIT,1);t.moveEnd(ice.dom.CHARACTER_UNIT,-1);if(n===o.data.length&&(!ice.dom.hasNoTextOrStubContent(o))){p=ice.dom.getNextNode(o,this.element);if(!p){t.selectNodeContents(o);t.collapse();return false}if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(p)){p=ice.dom.getNextNode(p,this.element)}if(p.nodeType===ice.dom.TEXT_NODE){p=p.parentNode}if(!p.isContentEditable){z=this._addNodeTracking(p,false,false);var m=document.createTextNode("");p.parentNode.insertBefore(m,p.nextSibling);t.selectNode(m);t.collapse(true);return z}if(this._handleVoidEl(p,t)){return true}if(ice.dom.isChildOf(p,j)&&ice.dom.isStubElement(p)){return this._addNodeTracking(p,t,false)}}if(this._handleVoidEl(p,t)){return true}if(this._getNoTrackElement(t.endContainer.parentElement)){t._deleteContents();return false}if(ice.dom.isOnBlockBoundary(t.startContainer,t.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(p,this.element),this.blockEl)){if(r!==ice.dom.getBlockParent(t.endContainer,this.element)){t.setEnd(r,0)}var s=ice.dom.getElementsBetween(t.startContainer,t.endContainer);for(var w=0;w<s.length;w++){ice.dom.remove(s[w])}var y=t.startContainer;var A=t.endContainer;ice.dom.remove(ice.dom.find(y,"br"));ice.dom.remove(ice.dom.find(A,"br"));return ice.dom.mergeBlockWithSibling(t,ice.dom.getBlockParent(t.endContainer,this.element)||j)}else{if(v){ice.dom.remove(r);t.collapse(true);return true}t.setStart(r,0);t.collapse(true);return true}}var g=t.endContainer,q=g.splitText(t.endOffset),h=q.splitText(1);return this._addNodeTracking(q,t,false)},_deleteLeft:function(t){var k=ice.dom.isBlockElement(t.startContainer)&&t.startContainer||ice.dom.getBlockParent(t.startContainer,this.element)||null,u=k?ice.dom.hasNoTextOrStubContent(k):false,p=k&&ice.dom.getPrevContentNode(k,this.element),x=p?ice.dom.hasNoTextOrStubContent(p):false,o=t.startContainer,n=t.startOffset,l=t.commonAncestorContainer,j,w;if(u){return false}if(n===0||l.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(l)&&(!ice.dom.canContainTextElement(l))){if(n===0){var y=l.firstElementChild;if(y){t.setStart(y,0);t.collapse();return this._deleteLeft(t)}}else{var r=l.lastElementChild;if(r){j=t.getLastSelectableChild(r);if(j){t.setStart(j,j.data.length);t.collapse();return this._deleteLeft(t)}}}}if(n===0){w=ice.dom.getPrevContentNode(o,this.element)}else{w=l.childNodes[n-1]}if(!w){return false}if(ice.dom.is(w,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&w.childNodes.length>0&&w.lastChild){w=w.lastChild}if(w.nodeType===ice.dom.TEXT_NODE){w=w.parentNode}if(!w.isContentEditable){var A=this._addNodeTracking(w,false,true);var m=document.createTextNode("");w.parentNode.insertBefore(m,w);t.selectNode(m);t.collapse(true);return A}if(this._handleVoidEl(w,t)){return true}if(ice.dom.isStubElement(w)&&ice.dom.isChildOf(w,k)||!w.isContentEditable){return this._addNodeTracking(w,t,true)}if(ice.dom.isStubElement(w)){ice.dom.remove(w);t.collapse(true);return false}if(w!==k&&!ice.dom.isChildOf(w,k)){if(!ice.dom.canContainTextElement(w)){w=w.lastElementChild}if(w.lastChild&&w.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(w.lastChild)&&w.lastChild.tagName!=="BR"){t.setStartAfter(w.lastChild);t.collapse(true);return true}j=t.getLastSelectableChild(w);if(j&&!ice.dom.isOnBlockBoundary(t.startContainer,j,this.element)){t.selectNodeContents(j);t.collapse();return true}}}if(n===1&&!ice.dom.isBlockElement(l)&&t.startContainer.childNodes.length>1&&t.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&t.startContainer.childNodes[0].data.length===0){t.setStart(t.startContainer,0);return this._deleteLeft(t)}t.moveStart(ice.dom.CHARACTER_UNIT,-1);t.moveStart(ice.dom.CHARACTER_UNIT,1);if(this._getNoTrackElement(t.startContainer.parentElement)){t._deleteContents();return false}if(ice.dom.isOnBlockBoundary(t.startContainer,t.endContainer,this.element)){if(x){ice.dom.remove(p);t.collapse();return true}if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(w,this.element),this.blockEl)){if(p!==ice.dom.getBlockParent(t.startContainer,this.element)){t.setStart(p,p.childNodes.length)}var s=ice.dom.getElementsBetween(t.startContainer,t.endContainer);for(var v=0;v<s.length;v++){ice.dom.remove(s[v])}var z=t.startContainer;var B=t.endContainer;ice.dom.remove(ice.dom.find(z,"br"));ice.dom.remove(ice.dom.find(B,"br"));return ice.dom.mergeBlockWithSibling(t,ice.dom.getBlockParent(t.endContainer,this.element)||k)}if(p&&p.lastChild&&ice.dom.isStubElement(p.lastChild)){t.setStartAfter(p.lastChild);t.collapse(true);return true}j=t.getLastSelectableChild(p);if(j){t.setStart(j,j.data.length);t.collapse(true)}else{if(p){t.setStart(p,p.childNodes.length);t.collapse(true)}}return true}var g=t.startContainer,q=g.splitText(t.startOffset-1),h=q.splitText(1);return this._addNodeTracking(q,t,true)},_addNodeTracking:function(l,m,n){var o=this._getIceNode(l,"insertType");if(o&&this._currentUserIceNode(o)){if(m&&n){m.selectNode(l)}l.parentNode.removeChild(l);var g=ice.dom.cloneNode(o);ice.dom.remove(ice.dom.find(g,".iceBookmark"));if(o!==null&&(ice.dom.hasNoTextOrStubContent(g[0]))){var p=this.env.document.createTextNode("");ice.dom.insertBefore(o,p);if(m){m.setStart(p,0);m.collapse(true)}ice.dom.replaceWith(o,ice.dom.contents(o))}return true}else{if(m&&this._getIceNode(l,"deleteType")){this._normalizeNode(l);var t=false;if(n){var h=ice.dom.getPrevContentNode(l,this.element);while(!t){r=this._getIceNode(h,"deleteType");if(!r){t=true}else{h=ice.dom.getPrevContentNode(h,this.element)}}if(h){var q=m.getLastSelectableChild(h);if(q){h=q}m.setStart(h,ice.dom.getNodeCharacterLength(h));m.collapse(true)}return true}else{var k=ice.dom.getNextContentNode(l,this.element);while(!t){r=this._getIceNode(k,"deleteType");if(!r){t=true}else{k=ice.dom.getNextContentNode(k,this.element)}}if(k){m.selectNodeContents(k);m.collapse(true)}return true}}}if(l.previousSibling&&l.previousSibling.nodeType===ice.dom.TEXT_NODE&&l.previousSibling.length===0){l.parentNode.removeChild(l.previousSibling)}if(l.nextSibling&&l.nextSibling.nodeType===ice.dom.TEXT_NODE&&l.nextSibling.length===0){l.parentNode.removeChild(l.nextSibling)}var i=this._getIceNode(l.previousSibling,"deleteType"),s=this._getIceNode(l.nextSibling,"deleteType"),r;if(i&&this._currentUserIceNode(i)){r=i;r.appendChild(l);if(s&&this._currentUserIceNode(s)){var j=ice.dom.extractContent(s);ice.dom.append(r,j);s.parentNode.removeChild(s)}}else{if(s&&this._currentUserIceNode(s)){r=s;r.insertBefore(l,r.firstChild)}else{r=this._createIceNode("deleteType");l.parentNode.insertBefore(r,l);r.appendChild(l)}}if(m){if(ice.dom.isStubElement(l)){m.selectNode(l)}else{m.selectNodeContents(l)}if(n){m.collapse(true)}else{m.collapse()}this._normalizeNode(l)}return true},_handleAncillaryKey:function(m){var l=m.keyCode?m.keyCode:m.which,j=this._browser,i=true,k=m.shiftKey,h=this,g=h.getCurrentRange();switch(l){case ice.dom.DOM_VK_DELETE:i=this._deleteContents();break;case 46:i=this._deleteContents(true);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:if(j.type==="mozilla"){if(!this.visible(g.startContainer)){if(g.startContainer.parentNode.previousSibling){g.setEnd(g.startContainer.parentNode.previousSibling,0);g.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(g.endContainer));g.collapse(false)}else{g.setEnd(g.startContainer.parentNode.nextSibling,0);g.collapse(false)}}}i=false;break;case ice.dom.DOM_VK_RIGHT:if(j.type==="mozilla"){if(!this.visible(g.startContainer)){if(g.startContainer.parentNode.nextSibling){g.setStart(g.startContainer.parentNode.nextSibling,0);g.collapse(true)}}}i=false;break;default:i=false;break}if(i===true){ice.dom.preventDefault(m);return false}return true},keyDown:function(h){var g=false;if(this._handleSpecialKey(h)===false){if(ice.dom.isBrowser("msie")!==true){this._preventKeyPress=true}return false}switch(h.keyCode){case 27:break;default:if(!this._browser.firefox){g=!(this._handleAncillaryKey(h))}break}if(g){ice.dom.preventDefault(h);return false}return true},keyPress:function(j){if(this._preventKeyPress===true){this._preventKeyPress=false;return}var k=null;if(j.which==null){k=String.fromCharCode(j.keyCode)}else{if(j.which>0){k=String.fromCharCode(j.which)}}if(j.ctrlKey||j.metaKey){return true}var g=this.getCurrentRange(),i=g&&ice.dom.parents(g.startContainer,"br")[0]||null;if(i){g.moveToNextEl(i)}if(k!==null&&j.ctrlKey!==true&&j.metaKey!==true){var h=j.keyCode?j.keyCode:j.which;switch(h){case ice.dom.DOM_VK_DELETE:return this._handleAncillaryKey(j);case ice.dom.DOM_VK_ENTER:return this._handleEnter();default:return this.insert()}}return this._handleAncillaryKey(j)},_handleEnter:function(){var g=this.getCurrentRange();if(g&&!g.collapsed){this._deleteContents()}return true},_handleSpecialKey:function(l){var k=l.which;if(k===null){k=l.keyCode}var i=false;switch(k){case 65:if(!this._handleSelectAll){return true}if(l.ctrlKey===true||l.metaKey===true){i=true;var h=this.getCurrentRange();if(ice.dom.isBrowser("msie")===true){var m=this.env.document.createTextNode("");var g=this.env.document.createTextNode("");if(this.element.firstChild){ice.dom.insertBefore(this.element.firstChild,m)}else{this.element.appendChild(m)}this.element.appendChild(g);h.setStart(m,0);h.setEnd(g,0)}else{h.setStart(h.getFirstSelectableChild(this.element),0);var j=h.getLastSelectableChild(this.element);h.setEnd(j,j.length)}this.selection.addRange(h)}break;case 120:case 88:if(true===l.ctrlKey||true===l.metaKey){this._tryToCut()}break;default:break}if(i===true){ice.dom.preventDefault(l);return false}return true},getContentElement:function(){return this.element},_getIceNodes:function(){var h=[];var g=this;ice.dom.each(this.changeTypes,function(k,j){h.push("."+g._getIceNodeClass(k))});h=h.join(",");return jQuery(this.element).find(h)},currentChangeNode:function(i){var g="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType");if(!i){var h=this.getCurrentRange();if(!h||!h.collapsed){return false}else{i=h.startContainer}}return ice.dom.getNode(i,g)},setShowChanges:function(g){g=!!g;this._isVisible=g;var h=jQuery(this.element);h.toggleClass("ICE-Tracking",g);this._showTitles(g);this._updateTooltipsState()},reload:function(){this._loadFromDom()},hasChanges:function(){for(var g in this._changes){var h=this._changes[g];if(h&&h.type){return true}}return false},countChanges:function(g){var h=this._filterChanges(g);return h.count},setChangeData:function(g){if(null==g||(typeof g=="undefined")){g=""}this._changeData=String(g)},getDeleteClass:function(){return this._getIceNodeClass("deleteType")},toString:function(){return"ICE "+((this.element&&this.element.id)||"(no element id)")},_splitNode:function(k,n,g){var j=k.parentNode,h=rangy.dom.getNodeIndex(k),m=n.ownerDocument,i=m.createRange(),l;i.setStart(j,h);i.setEnd(n,g);l=i.extractContents();j.insertBefore(l,k);return k.previousSibling},_triggerChange:function(){this.$this.trigger("change")},_triggerChangeText:function(){this.$this.trigger("textChange")},_updateNodeTooltip:function(g){if(this.tooltips&&this._isTracking&&this._isVisible){this._addTooltip(g)}},_acceptRejectSome:function(i,g){var k=(function(m,n){this.acceptRejectChange(n,g)}).bind(this);var j=this._filterChanges(i);for(var l in j.changes){var h=ice.dom.find(this.element,"["+this.attributes.changeId+"="+l+"]");h.each(k)}if(j.count){this._triggerChange()}},_filterChanges:function(o){var j=0,l={};var h=o&&o.filter;var i=o&&o.exclude?jQuery.map(o.exclude,function(p){return String(p)}):null;var g=o&&o.include?jQuery.map(o.include,function(p){return String(p)}):null;for(var n in this._changes){var k=this._changes[n];if(k&&k.type){var m=(h&&!h({userid:k.userid,time:k.time,data:k.data}))||(i&&i.indexOf(k.userid)>=0)||(g&&g.indexOf(k.userid)<0);if(!m){++j;l[n]=k}}}return{count:j,changes:l}},_loadFromDom:function(){this._changes={};this._uniqueStyleIndex=0;var k=this.currentUser&&this.currentUser.id;var j=(this.currentUser&&this.currentUser.name)||"";var i=(new Date()).getTime();var m=[];for(var g in this.changeTypes){m.push(this._getIceNodeClass(g))}var h=this._getIceNodes();function l(q,o){var u=0;var x="";var n=o.className.split(" ");for(var q=0;q<n.length;q++){var w=new RegExp(this.stylePrefix+"-(\\d+)").exec(n[q]);if(w){u=w[1]}var y=new RegExp("("+m.join("|")+")").exec(n[q]);if(y){x=this._getChangeTypeFromAlias(y[1])}}var r=ice.dom.attr(o,this.attributes.userId);var v;if(k&&(r==k)){v=j;o.setAttribute(this.attributes.userName,j)}else{v=o.getAttribute(this.attributes.userName)}this._setUserStyle(r,Number(u));var z=parseInt(ice.dom.attr(o,this.attributes.changeId)||"");if(isNaN(z)){z=this.getNewChangeId();o.setAttribute(this.attributes.changeId,z)}var p=parseInt(o.getAttribute(this.attributes.time)||"");if(isNaN(p)){p=i}var s=ice.dom.attr(o,this.attributes.changeData)||"";var t={type:x,userid:String(r),username:v,time:p,data:s};this._changes[z]=t;this._updateNodeTooltip(o)}h.each(l.bind(this));this._triggerChange()},_updateUserData:function(h){if(h){for(var i in this._changes){var j=this._changes[i];if(j.userid==h.id){j.username=h.name}}}var g=this._getIceNodes();g.each((function(l,m){var k=(!h)||(h.id==m.getAttribute(this.attributes.userId));if(h&&k){m.setAttribute(this.userNameAttribute,h.name)}}).bind(this))},_showTitles:function(h){var g=this._getIceNodes();if(h){jQuery(g).each((function(j,k){this._updateNodeTooltip(k)}).bind(this))}else{jQuery(g).removeAttr("title")}},_updateTooltipsState:function(){if(this.tooltips&&this._isTracking&&this._isVisible){if(!this._showingTips){this._showingTips=true;var h=this._getIceNodes(),g=this;h.each(function(j,k){g._addTooltip(k)})}}else{if(this._showingTips){this._showingTips=false;var h=this._getIceNodes();h.each(function(j,k){jQuery(k).unbind("mouseover").unbind("mouseout")})}}},_addTooltip:function(g){jQuery(g).unbind("mouseover").unbind("mouseout").mouseover(this._tooltipMouseOver).mouseout(this._tooltipMouseOut)},_tooltipMouseOver:function(j){var i=j.currentTarget,h=jQuery(i),g=this;if(!h.data("_tooltip_t")){var k=setTimeout(function(){var m=g.currentChangeNode(i),o=m&&m.getAttribute(g.attributes.changeId),n=o&&g.getChange(o);if(n){var l=ice.dom.hasClass(m,g._getIceNodeClass("insertType"))?"insert":"delete";h.removeData("_tooltip_t");g.hostMethods.showTooltip(i,{userName:n.username,userId:n.userid,time:n.time,type:l})}},this.tooltipsDelay);h.data("_tooltip_t",k)}},_tooltipMouseOut:function(i){var h=i.currentTarget,g=jQuery(h),j=g.data("_tooltip_t");g.removeData("_tooltip_t");if(j){clearTimeout(j)}else{this.hostMethods.hideTooltip(h)}},_normalizeNode:function(g){if(!g){return}if(typeof g.normalize=="function"){return g.normalize()}return this._myNormalizeNode(g)},_myNormalizeNode:function(j){if(!j){return}var g=1;var h=3;var l=j.firstChild;while(l){if(l.nodeType==g){this._myNormalizeNode(l)}else{if(l.nodeType==h){var i;while((i=l.nextSibling)&&i.nodeType==h){var k=i.nodeValue;if(k!=null&&k.length){l.nodeValue=l.nodeValue+k}j.removeChild(i)}}}l=l.nextSibling}},_tryToCut:function(){var g=this.getCurrentRange();if(g&&!g.collapsed){var l=g.cloneContents(),j=g.cloneRange(),i=l.firstChild,h=l.lastChild;g.collapse(false);g.insertNode(l);g.setStartBefore(i);g.setEndAfter(h);var k=this.startBatchChange();try{this._deleteSelection(g)}finally{this.endBatchChange(k);this.selection.addRange(j)}}}};var a=(window&&window.console)||{log:function(){},error:function(){},info:function(){},assert:function(){},count:function(){}};function e(g){return g}function c(h,i){if(!h){return false}var g=h.nodeType;if(ice.dom.TEXT_NODE==g){return i&&h.nodeValue&&(i>=h.nodeValue.length-1)}if(ice.dom.ELEMENT_NODE==g){return h.childNodes&&h.childNodes.length&&(i>=h.childNodes.length)}return false}b.ice=this.ice||{};b.ice.InlineChangeEditor=d}).call(this);(function(){var b=this,f={},a=null;f.DOM_VK_DELETE=8;f.DOM_VK_LEFT=37;f.DOM_VK_UP=38;f.DOM_VK_RIGHT=39;f.DOM_VK_DOWN=40;f.DOM_VK_ENTER=13;f.ELEMENT_NODE=1;f.ATTRIBUTE_NODE=2;f.TEXT_NODE=3;f.CDATA_SECTION_NODE=4;f.ENTITY_REFERENCE_NODE=5;f.ENTITY_NODE=6;f.PROCESSING_INSTRUCTION_NODE=7;f.COMMENT_NODE=8;f.DOCUMENT_NODE=9;f.DOCUMENT_TYPE_NODE=10;f.DOCUMENT_FRAGMENT_NODE=11;f.NOTATION_NODE=12;f.CHARACTER_UNIT="character";f.WORD_UNIT="word";f.BREAK_ELEMENT="br";f.CONTENT_STUB_ELEMENTS=["img","hr","iframe","param","link","meta","input","frame","col","base","area"];f.BLOCK_ELEMENTS=["body","p","div","pre","ul","ol","li","table","tbody","td","th","fieldset","form","blockquote","dl","dt","dd","dir","center","address","h1","h2","h3","h4","h5","h6"];f.TEXT_CONTAINER_ELEMENTS=["body","p","div","pre","span","b","strong","i","li","td","th","blockquote","dt","dd","center","address","h1","h2","h3","h4","h5","h6"];f.STUB_ELEMENTS=f.CONTENT_STUB_ELEMENTS.slice();f.STUB_ELEMENTS.push(f.BREAK_ELEMENT);f.getKeyChar=function(g){return String.fromCharCode(g.which)};f.getClass=function(i,h,g){if(!h){h=document.body}i="."+i.split(" ").join(".");if(g){i=g+i}return jQuery.makeArray(jQuery(h).find(i))};f.getId=function(h,g){if(!g){g=document}element=g.getElementById(h);return element};f.getTag=function(g,h){if(!h){h=document}return jQuery.makeArray(jQuery(h).find(g))};f.getElementWidth=function(g){return g.offsetWidth};f.getElementHeight=function(g){return g.offsetHeight};f.getElementDimensions=function(h){var g={width:f.getElementWidth(h),height:f.getElementHeight(h)};return g};f.trim=function(g){return jQuery.trim(g)};f.empty=function(g){if(g){return jQuery(g).empty()}};f.remove=function(g){if(g){return jQuery(g).remove()}};f.prepend=function(g,h){jQuery(g).prepend(h)};f.append=function(g,h){jQuery(g).append(h)};f.insertBefore=function(h,g){jQuery(h).before(g)};f.insertAfter=function(h,g){jQuery(h).after(g)};f.getHtml=function(g){return jQuery(g).html()};f.setHtml=function(g,h){if(g){jQuery(g).html(h)}};f.removeWhitespace=function(g){jQuery(g).contents().filter(function(){if(this.nodeType!=ice.dom.TEXT_NODE&&this.nodeName=="UL"||this.nodeName=="OL"){f.removeWhitespace(this);return false}else{if(this.nodeType!=ice.dom.TEXT_NODE){return false}else{return !/\S/.test(this.nodeValue)}}}).remove()};f.contents=function(g){return jQuery.makeArray(jQuery(g).contents())};f.extractContent=function(g){var i=document.createDocumentFragment(),h;while((h=g.firstChild)){i.appendChild(h)}return i};f.getNode=function(h,g){if(!h){return null}h=h.$||h;return(h.nodeType!=3&&f.is(h,g))?h:f.parents(h,g)[0]||null},f.getParents=function(n,k,m){var j=jQuery(n).parents(k);var l=j.length;var g=[];for(var h=0;h<l;h++){if(j[h]===m){break}g.push(j[h])}return g};f.hasBlockChildren=function(h){var j=h.childNodes.length;for(var g=0;g<j;g++){if(h.childNodes[g].nodeType===f.ELEMENT_NODE){if(f.isBlockElement(h.childNodes[g])===true){return true}}}return false};f.removeTag=function(h,g){jQuery(h).find(g).replaceWith(function(){return jQuery(this).contents()});return h};f.stripEnclosingTags=function(g,i){var h=jQuery(g);h.find("*").not(i).replaceWith(function(){var j=jQuery();var l;try{l=jQuery(this);j=l.contents()}catch(k){}if(j.length===0){l.remove()}return j});return h[0]};f.getSiblings=function(j,i,k,h){if(k===true){if(i==="prev"){return jQuery(j).prevAll()}else{return jQuery(j).nextAll()}}else{var g=[];if(i==="prev"){while(j.previousSibling){j=j.previousSibling;if(j===h){break}g.push(j)}}else{while(j.nextSibling){j=j.nextSibling;if(j===h){break}g.push(j)}}return g}};f.getNodeTextContent=function(g){return jQuery(g).text()};f.getNodeStubContent=function(g){return jQuery(g).find(f.CONTENT_STUB_ELEMENTS.join(", "))};f.hasNoTextOrStubContent=function(g){if(f.getNodeTextContent(g).length>0){return false}if(jQuery(g).find(f.CONTENT_STUB_ELEMENTS.join(", ")).length>0){return false}return true};f.getNodeCharacterLength=function(g){return f.getNodeTextContent(g).length+jQuery(g).find(f.STUB_ELEMENTS.join(", ")).length};f.setNodeTextContent=function(h,g){return jQuery(h).text(g)};f.getTagName=function(g){return g.tagName&&g.tagName.toLowerCase()||null};f.getIframeDocument=function(g){var h=null;if(g.contentDocument){h=g.contentDocument}else{if(g.contentWindow){h=g.contentWindow.document}else{if(g.document){h=g.document}}}return h};f.isBlockElement=function(g){return f.BLOCK_ELEMENTS.indexOf(g.nodeName.toLowerCase())!=-1};f.isStubElement=function(g){return f.STUB_ELEMENTS.indexOf(g.nodeName.toLowerCase())!=-1};f.removeBRFromChild=function(g){if(g&&g.hasChildNodes()){for(var h=0;h<g.childNodes.length;h++){var i=g.childNodes[h];if(i&&(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(i))){i.parentNode.removeChild(i)}}}};f.isChildOf=function(h,g){try{while(h&&h.parentNode){if(h.parentNode===g){return true}h=h.parentNode}}catch(i){}return false};f.isChildOfTagName=function(h,g){try{while(h&&h.parentNode){if(h.parentNode&&h.parentNode.tagName&&h.parentNode.tagName.toLowerCase()===g){return h.parentNode}h=h.parentNode}}catch(i){}return false};f.isChildOfTagNames=function(h,k){try{while(h&&h.parentNode){if(h.parentNode&&h.parentNode.tagName){tagName=h.parentNode.tagName.toLowerCase();for(var g=0;g<k.length;g++){if(tagName===k[g]){return h.parentNode}}}h=h.parentNode}}catch(j){}return null};f.isChildOfClassName=function(h,g){try{while(h&&h.parentNode){if(jQuery(h.parentNode).hasClass(g)){return h.parentNode}h=h.parentNode}}catch(i){}return null};f.cloneNode=function(g,h){if(h===undefined){h=true}return jQuery(g).clone(h)};f.bind=function(g,h,i){return jQuery(g).bind(h,i)};f.unbind=function(g,h,i){return jQuery(g).unbind(h,i)};f.attr=function(h,g,i){if(i){return jQuery(h).attr(g,i)}else{return jQuery(h).attr(g)}};f.replaceWith=function(h,g){return jQuery(h).replaceWith(g)};f.removeAttr=function(h,g){jQuery(h).removeAttr(g)};f.getElementsBetween=function(r,n){var g=[];if(r===n){return g}if(f.isChildOf(n,r)===true){var o=r.childNodes.length;for(var l=0;l<o;l++){if(r.childNodes[l]===n){break}else{if(f.isChildOf(n,r.childNodes[l])===true){return f.arrayMerge(g,f.getElementsBetween(r.childNodes[l],n))}else{g.push(r.childNodes[l])}}}return g}var k=r.nextSibling;while(k){if(f.isChildOf(n,k)===true){g=f.arrayMerge(g,f.getElementsBetween(k,n));return g}else{if(k===n){return g}else{g.push(k);k=k.nextSibling}}}var t=f.getParents(r);var p=f.getParents(n);var s=f.arrayDiff(t,p,true);var q=s.length;for(var h=0;h<(q-1);h++){g=f.arrayMerge(g,f.getSiblings(s[h],"next"))}var m=s[(s.length-1)];g=f.arrayMerge(g,f.getElementsBetween(m,n));return g};f.getCommonAncestor=function(h,g){var i=h;while(i){if(f.isChildOf(g,i)===true){return i}i=i.parentNode}return null};f.getNextNode=function(h,g){if(h){while(h.parentNode){if(h===g){return null}if(h.nextSibling){if(h.nextSibling.nodeType===f.TEXT_NODE&&h.nextSibling.length===0){h=h.nextSibling;continue}return f.getFirstChild(h.nextSibling)}h=h.parentNode}}return null};f.getNextContentNode=function(h,g){if(h){while(h.parentNode){if(h===g){return null}if(h.nextSibling&&f.canContainTextElement(f.getBlockParent(h))){if(h.nextSibling.nodeType===f.TEXT_NODE&&h.nextSibling.length===0){h=h.nextSibling;continue}return h.nextSibling}else{if(h.nextElementSibling){return h.nextElementSibling}}h=h.parentNode}}return null};f.getPrevNode=function(h,g){if(h){while(h.parentNode){if(h===g){return null}if(h.previousSibling){if(h.previousSibling.nodeType===f.TEXT_NODE&&h.previousSibling.length===0){h=h.previousSibling;continue}return f.getLastChild(h.previousSibling)}h=h.parentNode}}return null};f.getPrevContentNode=function(h,g){if(h){while(h.parentNode){if(h===g){return null}if(h.previousSibling&&f.canContainTextElement(f.getBlockParent(h))){if(h.previousSibling.nodeType===f.TEXT_NODE&&h.previousSibling.length===0){h=h.previousSibling;continue}return h.previousSibling}else{if(h.previousElementSibling){return h.previousElementSibling}}h=h.parentNode}}return null};function e(h,g){if(f.TEXT_NODE==h.nodeType){return h.length}}function d(h){while(h){if(f.TEXT_NODE==h.nodeType){return h}for(var i=h.firstChild;i;i=i.nextSibling){var g=d(i,container);if(g){return g}}if(f.isTextContainer(h)){return h}h=h.nextSibling}return null}function c(h){while(h){if(f.TEXT_NODE==h.nodeType){return h}for(var i=h.lastChild;i;i=i.previousSibling){var g=c(i,container);if(g){return g}}if(f.isTextContainer(h)){return h}h=h.previousSibling}return null}f.findPrevTextContainer=function(i,g){if(!i||i==g){return{node:g,offset:0}}if(i.parentNode&&f.isTextContainer(i.parentNode)){return{node:i.parentNode,offset:f.getNodeIndex(i)}}while(i.previousSibling){var h=c(i.previousSibling);if(h){return{node:h,offset:f.getNodeLength(h)}}i=i.previousSibling}return f.findPrevTextContainer(i.parentNode&&i.parentNode.previousSibling,g)};f.findNextTextContainer=function(i,g){if(!i||i==g){return{node:g,offset:f.getNodeLength(g)}}if(i.parentNode&&f.isTextContainer(i.parentNode)){return{node:i.parentNode,offset:f.getNodeIndex(i)+1}}while(i.nextSibling){var h=d(i.nextSibling);if(h){return{node:h,offset:0}}i=i.previousSibling}return f.findNextTextContainer(i.parentNode&&i.parentNode.nextSibling,g)};f.getNodeLength=function(g){return g?(f.TEXT_NODE==g.nodeType?g.length:((g.childNodes&&g.childNodes.length)||0)):0};f.isTextContainer=function(g){return(g&&(f.TEXT_NODE==g.nodeType)||f.TEXT_CONTAINER_ELEMENTS.indexOf((g.nodeName||"").toLowerCase())>=0)};f.getNodeIndex=function(h){var g=0;while((h=h.previousSibling)){++g}return g};f.canContainTextElement=function(g){if(g&&g.nodeName){return f.TEXT_CONTAINER_ELEMENTS.lastIndexOf(g.nodeName.toLowerCase())!=-1}else{return false}};f.getFirstChild=function(g){if(g.firstChild){if(g.firstChild.nodeType===f.ELEMENT_NODE){return f.getFirstChild(g.firstChild)}else{return g.firstChild}}return g};f.getLastChild=function(g){if(g.lastChild){if(g.lastChild.nodeType===f.ELEMENT_NODE){return f.getLastChild(g.lastChild)}else{return g.lastChild}}return g};f.removeEmptyNodes=function(j,k){var g=jQuery(j).find(":empty");var h=g.length;while(h>0){h--;if(f.isStubElement(g[h])===false){if(!k||k.call(this,g[h])!==false){f.remove(g[h])}}}};f.create=function(g){return jQuery(g)[0]};f.find=function(g,h){return jQuery(g).find(h)};f.children=function(g,h){return jQuery(g).children(h)};f.parent=function(h,g){return jQuery(h).parent(g)[0]};f.parents=function(h,g){return jQuery(h).parents(g)};f.is=function(g,h){return jQuery(g).is(h)};f.extend=function(g,j,i,h){return jQuery.extend.apply(this,arguments)};f.walk=function(h,j,g){if(!h){return}if(!g){g=0}var i=j.call(this,h,g);if(i===false){return}if(h.childNodes&&h.childNodes.length>0){f.walk(h.firstChild,j,(g+1))}else{if(h.nextSibling){f.walk(h.nextSibling,j,g)}else{if(h.parentNode&&h.parentNode.nextSibling){f.walk(h.parentNode.nextSibling,j,(g-1))}}}};f.revWalk=function(g,i){if(!g){return}var h=i.call(this,g);if(h===false){return}if(g.childNodes&&g.childNodes.length>0){f.walk(g.lastChild,i)}else{if(g.previousSibling){f.walk(g.previousSibling,i)}else{if(g.parentNode&&g.parentNode.previousSibling){f.walk(g.parentNode.previousSibling,i)}}}};f.setStyle=function(g,i,h){if(g){jQuery(g).css(i,h)}};f.getStyle=function(g,h){return jQuery(g).css(h)};f.hasClass=function(g,h){return jQuery(g).hasClass(h)};f.addClass=function(g,h){jQuery(g).addClass(h)};f.removeClass=function(g,h){jQuery(g).removeClass(h)};f.preventDefault=function(g){g.preventDefault();f.stopPropagation(g)};f.stopPropagation=function(g){g.stopPropagation()};f.noInclusionInherits=function(i,h){if(h instanceof String||typeof h==="string"){h=window[h]}if(i instanceof String||typeof i==="string"){i=window[i]}var g=function(){};if(f.isset(h)===true){for(value in h.prototype){if(i.prototype[value]){g.prototype[value]=h.prototype[value];continue}i.prototype[value]=h.prototype[value]}}if(i.prototype){g.prototype.constructor=h;i.prototype["super"]=new g()}};f.each=function(g,h){jQuery.each(g,function(j,k){h.call(this,j,k)})};f.foreach=function(l,h){if(l instanceof Array||l instanceof NodeList||typeof l.length!="undefined"&&typeof l.item!="undefined"){var g=l.length;for(var k=0;k<g;k++){var j=h.call(this,k,l[k]);if(j===false){break}}}else{for(var m in l){if(l.hasOwnProperty(m)===true){var j=h.call(this,m);if(j===false){break}}}}};f.isBlank=function(g){if(!g||/^\s*$/.test(g)){return true}return false};f.isFn=function(g){if(typeof g==="function"){return true}return false};f.isObj=function(g){if(g!==null&&typeof g==="object"){return true}return false};f.isset=function(g){if(typeof g!=="undefined"&&g!==null){return true}return false};f.isArray=function(g){return jQuery.isArray(g)};f.isNumeric=function(h){var g=h.match(/^\d+$/);if(g!==null){return true}return false};f.getUniqueId=function(){var h=(new Date()).getTime();var g=Math.ceil(Math.random()*1000000);var i=h+""+g;return i.substr(5,18).replace(/,/,"")};f.inArray=function(k,h){var j=h.length;for(var g=0;g<j;g++){if(k===h[g]){return true}}return false};f.arrayDiff=function(l,k,j){var m=l.length;var h=[];for(var g=0;g<m;g++){if(f.inArray(l[g],k)===false){h.push(l[g])}}if(j!==true){m=k.length;for(var g=0;g<m;g++){if(f.inArray(k[g],l)===false){h.push(k[g])}}}return h};f.arrayMerge=function(j,h){var k=h.length;for(var g=0;g<k;g++){j.push(h[g])}return j};f.stripTags=function(i,l){if(typeof l==="string"){var k=jQuery("<div>"+i+"</div>");k.find("*").not(l).remove();return k.html()}else{var g;var h=new RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim);var j=i;while((g=h.exec(i))!=null){if(f.isset(l)===false||f.inArray(g[1],l)!==true){j=j.replace(g[0],"")}}return j}};f.browser=function(){if(a){return jQuery.extend({},a)}a=(function(){function h(k){k=k.toLowerCase();var j=/(chrome)[ \/]([\w.]+)/.exec(k)||/(webkit)[ \/]([\w.]+)/.exec(k)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(k)||/(msie) ([\w.]+)/.exec(k)||k.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(k)||[];return{browser:j[1]||"",version:j[2]||"0"}}var g=h(navigator.userAgent);var i={type:"unknown",version:0};if(g.browser){i[g.browser]=true;i.version=g.version||0;i.type=g.browser}if(i.chrome){i.webkit=true}else{if(i.webkit){i.safari=true}}if(i.webkit){i.type="webkit"}i.firefox=(/Firefox/.test(navigator.userAgent)==true);return i})();return jQuery.extend({},a)};f.getBrowserType=function(){if(this._browserType===null){var j=["msie","firefox","chrome","safari"];var h=j.length;for(var g=0;g<h;g++){var k=new RegExp(j[g],"i");if(k.test(navigator.userAgent)===true){this._browserType=j[g];return this._browserType}}this._browserType="other"}return this._browserType};f.getWebkitType=function(){if(f.browser().type!=="webkit"){console.log("Not a webkit!");return false}var g=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;if(g){return"safari"}return"chrome"};f.isBrowser=function(g){return(f.browser().type===g)};f.getBlockParent=function(h,g){if(f.isBlockElement(h)===true){return h}if(h){while(h.parentNode){h=h.parentNode;if(f.isBlockElement(h)===true){return h}if(h===g){return null}}}return null};f.findNodeParent=function(i,g,h){if(i){while(i.parentNode){if(i===h){return null}if(f.is(i,g)===true){return i}i=i.parentNode}}return null};f.onBlockBoundary=function(j,h,i){if(!j||!h){return false}var g=f.isChildOfTagNames(j,i)||f.is(j,i.join(", "))&&j||null;var k=f.isChildOfTagNames(h,i)||f.is(h,i.join(", "))&&h||null;return(g!==k)};f.isOnBlockBoundary=function(j,i,g){if(!j||!i){return false}var h=f.getBlockParent(j,g)||f.isBlockElement(j,g)&&j||null;var k=f.getBlockParent(i,g)||f.isBlockElement(i,g)&&i||null;return(h!==k)};f.mergeContainers=function(h,g){if(!h||!g){return false}if(h.nodeType===f.TEXT_NODE||f.isStubElement(h)){g.appendChild(h)}else{if(h.nodeType===f.ELEMENT_NODE){while(h.firstChild){g.appendChild(h.firstChild)}f.remove(h)}}return true};f.mergeBlockWithSibling=function(g,j,i){var h=i?jQuery(j).next().get(0):jQuery(j).prev().get(0);if(i){f.mergeContainers(h,j)}else{f.mergeContainers(j,h)}g.collapse(true);return true};f.date=function(s,o,h){if(o===null&&h){o=f.tsIso8601ToTimestamp(h);if(!o){return}}var k=new Date(o);var q=s.split("");var j=q.length;var l="";for(var m=0;m<j;m++){var g="";var n=q[m];switch(n){case"D":case"l":var p=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];g=p[k.getDay()];if(n==="D"){g=g.substring(0,3)}break;case"F":case"m":g=k.getMonth()+1;if(g<10){g="0"+g}break;case"M":months=["January","February","March","April","May","June","July","August","September","October","November","December"];g=months[k.getMonth()];if(n==="M"){g=g.substring(0,3)}break;case"d":g=k.getDate();break;case"S":g=f.getOrdinalSuffix(k.getDate());break;case"Y":g=k.getFullYear();break;case"y":g=k.getFullYear();g=g.toString().substring(2);break;case"H":g=k.getHours();break;case"h":g=k.getHours();if(g===0){g=12}else{if(g>12){g-=12}}break;case"i":g=f.addNumberPadding(k.getMinutes());break;case"a":g="am";if(k.getHours()>=12){g="pm"}break;default:g=n;break}l+=g}return l};f.getOrdinalSuffix=function(h){var i="";var g=(h%100);if(g>=4&&g<=20){i="th"}else{switch(h%10){case 1:i="st";break;case 2:i="nd";break;case 3:i="rd";break;default:i="th";break}}return i};f.addNumberPadding=function(g){if(g<10){g="0"+g}return g};f.tsIso8601ToTimestamp=function(g){var j=/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/;var l=g.match(new RegExp(j));if(l){var h=new Date();h.setDate(l[3]);h.setFullYear(l[1]);h.setMonth(l[2]-1);h.setHours(l[4]);h.setMinutes(l[5]);h.setSeconds(l[6]);var k=(l[9]*60);if(l[8]==="+"){k*=-1}k-=h.getTimezoneOffset();var i=(h.getTime()+(k*60*1000));return i}return null};b.dom=f}).call(this.ice);(function(){var a=this,b;b=function(c){this._selection=null;this.env=c;this._initializeRangeLibrary();this._getSelection()};b.prototype={_getSelection:function(){if(this._selection){this._selection.refresh()}else{if(this.env.frame){this._selection=rangy.getSelection(this.env.frame)}else{this._selection=rangy.getSelection()}}return this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(d){this._selection.refresh();try{return this._selection.getRangeAt(d)}catch(c){this._selection=null;return this._getSelection().getRangeAt(0)}},addRange:function(c){this._selection||(this._selection=this._getSelection());this._selection.setSingleRange(c);this._selection.ranges=[c];return},_initializeRangeLibrary:function(){var d=this;rangy.init();rangy.config.checkSelectionRanges=false;var c=function(g,h,f,e){if(f===0){return}switch(h){case ice.dom.CHARACTER_UNIT:if(f>0){g.moveCharRight(e,f)}else{g.moveCharLeft(e,f*-1)}break;case ice.dom.WORD_UNIT:default:break}};rangy.rangePrototype.moveStart=function(f,e){c(this,f,e,true)};rangy.rangePrototype.moveEnd=function(f,e){c(this,f,e,false)};rangy.rangePrototype.setRange=function(g,e,f){if(g){this.setStart(e,f)}else{this.setEnd(e,f)}};rangy.rangePrototype.moveCharLeft=function(h,g){var f,i;if(h){f=this.startContainer;i=this.startOffset}else{f=this.endContainer;i=this.endOffset}if(f.nodeType===ice.dom.ELEMENT_NODE){if(f.hasChildNodes()){f=f.childNodes[i];f=this.getPreviousTextNode(f);while(f&&f.nodeType==ice.dom.TEXT_NODE&&f.nodeValue===""){f=this.getPreviousTextNode(f)}i=f.data.length-g}else{i=g*-1}}else{i-=g}if(i<0){while(i<0){var e=[];f=this.getPreviousTextNode(f,e);if(!f){return}if(f.nodeType===ice.dom.ELEMENT_NODE){continue}i+=f.data.length}}this.setRange(h,f,i)};rangy.rangePrototype.moveCharRight=function(h,g){var f,j;if(h){f=this.startContainer;j=this.startOffset}else{f=this.endContainer;j=this.endOffset}if(f.nodeType===ice.dom.ELEMENT_NODE){f=f.childNodes[j];if(f.nodeType!==ice.dom.TEXT_NODE){f=this.getNextTextNode(f)}j=g}else{j+=g}var i=(j-f.data.length);if(i>0){var e=[];while(i>0){f=this.getNextContainer(f,e);if(!f){return}if(f.nodeType===ice.dom.ELEMENT_NODE){continue}if(f.data.length>=i){break}else{if(f.data.length>0){i-=f.data.length}}}j=i}this.setRange(h,f,j)};rangy.rangePrototype.getNextContainer=function(f,e){if(!f){return null}while(f.nextSibling){f=f.nextSibling;if(f.nodeType!==ice.dom.TEXT_NODE){var h=this.getFirstSelectableChild(f);if(h!==null){return h}}else{if(this.isSelectable(f)===true){return f}}}while(f&&!f.nextSibling){f=f.parentNode}if(!f){return null}f=f.nextSibling;if(this.isSelectable(f)===true){return f}else{if(e&&ice.dom.isBlockElement(f)===true){e.push(f)}}var g=this.getFirstSelectableChild(f);if(g!==null){return g}return this.getNextContainer(f,e)};rangy.rangePrototype.getPreviousContainer=function(f,e){if(!f){return null}while(f.previousSibling){f=f.previousSibling;if(f.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isStubElement(f)===true){return f}else{var h=this.getLastSelectableChild(f);if(h!==null){return h}}}else{if(this.isSelectable(f)===true){return f}}}while(f&&!f.previousSibling){f=f.parentNode}if(!f){return null}f=f.previousSibling;if(this.isSelectable(f)===true){return f}else{if(e&&ice.dom.isBlockElement(f)===true){e.push(f)}}var g=this.getLastSelectableChild(f);if(g!==null){return g}return this.getPreviousContainer(f,e)};rangy.rangePrototype.getNextTextNode=function(e){if(e.nodeType===ice.dom.ELEMENT_NODE){if(e.childNodes.length!==0){return this.getFirstSelectableChild(e)}}e=this.getNextContainer(e);if(e.nodeType===ice.dom.TEXT_NODE){return e}return this.getNextTextNode(e)};rangy.rangePrototype.getPreviousTextNode=function(e,f){e=this.getPreviousContainer(e,f);if(e.nodeType===ice.dom.TEXT_NODE){return e}return this.getPreviousTextNode(e,f)};rangy.rangePrototype.getFirstSelectableChild=function(f){if(f){if(f.nodeType!==ice.dom.TEXT_NODE){var g=f.firstChild;while(g){if(this.isSelectable(g)===true){return g}else{if(g.firstChild){var e=this.getFirstSelectableChild(g);if(e!==null){return e}else{g=g.nextSibling}}else{g=g.nextSibling}}}}else{return f}}return null};rangy.rangePrototype.getLastSelectableChild=function(f){if(f){if(f.nodeType!==ice.dom.TEXT_NODE){var g=f.lastChild;while(g){if(this.isSelectable(g)===true){return g}else{if(g.lastChild){var e=this.getLastSelectableChild(g);if(e!==null){return e}else{g=g.previousSibling}}else{g=g.previousSibling}}}}else{return f}}return null};rangy.rangePrototype.isSelectable=function(e){if(e&&e.nodeType===ice.dom.TEXT_NODE&&e.data.length!==0){return true}return false};rangy.rangePrototype.getHTMLContents=function(e){if(!e){e=this.cloneContents()}var f=d.env.document.createElement("div");f.appendChild(e.cloneNode(true));return f.innerHTML};rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}};a.Selection=b}).call(this.ice);(function(){var a=this,b;b=function(i,f,o){this.env=i;this.element=i.element;this.selection=this.env.selection;if(!o){this.removeBookmarks(this.element)}var m=f||this.selection.getRangeAt(0),f=m.cloneRange(),c=f.startContainer,n=f.endContainer,k=f.startOffset,l=f.endOffset,d;f.collapse(false);var h=this.env.document.createElement("span");h.style.display="none";ice.dom.setHtml(h,"&nbsp;");ice.dom.addClass(h,"iceBookmark iceBookmark_end");h.setAttribute("iceBookmark","end");f.insertNode(h);if(!ice.dom.isChildOf(h,this.element)){this.element.appendChild(h)}f.setStart(c,k);f.collapse(true);var g=this.env.document.createElement("span");g.style.display="none";ice.dom.addClass(g,"iceBookmark iceBookmark_start");ice.dom.setHtml(g,"&nbsp;");g.setAttribute("iceBookmark","start");try{f.insertNode(g);if(g.previousSibling===h){d=g;g=h;h=d}}catch(j){ice.dom.insertBefore(h,g)}if(ice.dom.isChildOf(g,this.element)===false){if(this.element.firstChild){ice.dom.insertBefore(this.element.firstChild,g)}else{this.element.appendChild(g)}}if(!h.previousSibling){d=this.env.document.createTextNode("");ice.dom.insertBefore(h,d)}if(!g.nextSibling){d=this.env.document.createTextNode("");ice.dom.insertAfter(g,d)}m.setStart(g.nextSibling,0);m.setEnd(h.previousSibling,(h.previousSibling.length||0));this.start=g;this.end=h};b.prototype={selectBookmark:function(){var d=this.selection.getRangeAt(0);var h=null;var g=null;var c=0;var f=null;if(this.start.nextSibling===this.end||ice.dom.getElementsBetween(this.start,this.end).length===0){if(this.end.nextSibling){h=ice.dom.getFirstChild(this.end.nextSibling)}else{if(this.start.previousSibling){h=ice.dom.getFirstChild(this.start.previousSibling);if(h.nodeType===ice.dom.TEXT_NODE){c=h.length}}else{this.end.parentNode.appendChild(this.env.document.createTextNode(""));h=ice.dom.getFirstChild(this.end.nextSibling)}}}else{if(this.start.nextSibling){h=ice.dom.getFirstChild(this.start.nextSibling)}else{if(!this.start.previousSibling){var i=this.env.document.createTextNode("");ice.dom.insertBefore(this.start,i)}h=ice.dom.getLastChild(this.start.previousSibling);c=h.length}if(this.end.previousSibling){g=ice.dom.getLastChild(this.end.previousSibling)}else{g=ice.dom.getFirstChild(this.end.nextSibling||this.end);f=0}}ice.dom.remove([this.start,this.end]);if(g===null){d.setEnd(h,c);d.collapse(false)}else{d.setStart(h,c);if(f===null){f=(g.length||0)}d.setEnd(g,f)}try{this.selection.addRange(d)}catch(j){}},getBookmark:function(d,c){var e=ice.dom.getClass("iceBookmark_"+c,d)[0];return e},removeBookmarks:function(c){ice.dom.remove(ice.dom.getClass("iceBookmark",c,"span"))}};a.Bookmark=b}).call(this.ice);var LITE={Events:{INIT:"lite:init",ACCEPT:"lite:accept",REJECT:"lite:reject",SHOW_HIDE:"lite:showHide",TRACKING:"lite:tracking",CHANGE:"lite:change"},Commands:{TOGGLE_TRACKING:"lite.ToggleTracking",TOGGLE_SHOW:"lite.ToggleShow",ACCEPT_ALL:"lite.AcceptAll",REJECT_ALL:"lite.RejectAll",ACCEPT_ONE:"lite.AcceptOne",REJECT_ONE:"lite.RejectOne",TOGGLE_TOOLTIPS:"lite.ToggleTooltips"}};
/* Copyright (C) 2014 LoopIndex - All Rights Reserved
 * You may use, distribute and modify this code under the
 * terms of the LoopIndex Comments CKEditor plugin license.
 *
 * You should have received a copy of the LoopIndex Comments CKEditor plugin license with
 * this file. If not, please write to: loopindex@gmail.com, or visit http://www.loopindex.com
 * written by (David *)Frenkiel (https://github.com/imdfl) 
 */