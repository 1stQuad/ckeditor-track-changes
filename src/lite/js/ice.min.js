/* Source version: 1.1.5 */
(function(){function d(f){return f}var a=this,c,b;c={attributes:{changeId:"data-cid",userId:"data-userid",userName:"data-username",time:"data-time",changeData:"data-changedata",},attrValuePrefix:"",blockEl:"p",blockEls:["div","p","ol","ul","li","h1","h2","h3","h4","h5","h6","blockquote"],stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"span",alias:"ins",action:"Inserted"},deleteType:{tag:"span",alias:"del",action:"Deleted"}},handleEvents:false,contentEditable:undefined,_isTracking:true,noTrack:".ice-no-track",tooltips:false,tooltipsDelay:200,mergeBlocks:true,_isVisible:true,_changeData:null,_handleSelectAll:false,};b=function(f){f||(f={});if(!f.element){throw new Error("`options.element` must be defined for ice construction.")}this._changes={};this._userStyles={};this._styles={};this._refreshInterval=null;this.$this=jQuery(this);this._browser=ice.dom.browser();this._tooltipMouseOver=this._tooltipMouseOver.bind(this);this._tooltipMouseOut=this._tooltipMouseOut.bind(this);ice.dom.extend(true,this,c,f);if(f.tooltips&&(!jQuery.isFunction(f.hostMethods.showTooltip)||!jQuery.isFunction(f.hostMethods.hideTooltip))){throw new Error("hostMethods.showTooltip and hostMethods.hideTooltip must be defined if tooltips is true")}var g=f.userStyles||{};for(var h in g){if(g.hasOwnProperty(h)){var e=g[h];if(!isNaN(e)){this._userStyles[h]=this.stylePrefix+"-"+e;this._uniqueStyleIndex=Math.max(e,this._uniqueStyleIndex);this._styles[e]=true}}}};b.prototype={_uniqueStyleIndex:0,_browserType:null,_batchChangeid:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:false,startTracking:function(){if(typeof(this.contentEditable)=="boolean"){this.element.setAttribute("contentEditable",this.contentEditable)}if(this.handleEvents){var e=this;ice.dom.bind(e.element,"keyup.ice keydown.ice keypress.ice",function(f){return e.handleEvent(f)})}this.initializeEnvironment();this.initializeEditor();this.initializeRange();this._updateTooltipsState();return this},stopTracking:function(g){this._isTracking=false;try{if(this.element){ice.dom.unbind(this.element,"keyup.ice keydown.ice keypress.ice")}if(!g&&(typeof(this.contentEditable)!="undefined")){this.element.setAttribute("contentEditable",!this.contentEditable)}}catch(f){}this._updateTooltipsState();return this},initializeEnvironment:function(){this.env||(this.env={});this.env.element=this.element;this.env.document=this.element.ownerDocument;this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window;this.env.frame=this.env.window.frameElement;this.env.selection=this.selection=new ice.Selection(this.env);this.env.document.createElement(this.changeTypes.insertType.tag);this.env.document.createElement(this.changeTypes.deleteType.tag)},initializeRange:function(){},initializeEditor:function(){this._loadFromDom();this._updateTooltipsState()},isTracking:function(){return this._isTracking},enableChangeTracking:function(){this._isTracking=true},disableChangeTracking:function(){this._isTracking=false},toggleChangeTracking:function(e){e=(undefined===e)?!this._isTracking:!!e;this._isTracking=e},setCurrentUser:function(e){this.currentUser=e;this._updateUserData(e)},toggleTooltips:function(e){e=(undefined===e)?!this.tooltips:!!e;this.tooltips=e;this._updateTooltipsState()},handleEvent:function(g){if(!this._isTracking){return true}if(g.type=="keypress"){var f=this.keyPress(g);if(!f){g.preventDefault()}return f}else{if(g.type=="keydown"){var f=this.keyDown(g);if(!f){g.preventDefault()}return f}}},visible:function(e){if(e.nodeType===ice.dom.TEXT_NODE){e=e.parentNode}var f=e.getBoundingClientRect();return(f.top>0&&f.left>0)},_createIceNode:function(e,f){var g=this.env.document.createElement(this.changeTypes[e].tag);ice.dom.addClass(g,this.__getIceNodeClass(e));if(f){g.appendChild(f)}this.__addChange(this.changeTypes[e].alias,[g]);return g},insert:function(f){var e=this.getCurrentRange(),g=e?null:this.hostMethods.getHostRange(),h=this._batchChangeid?null:this.startBatchChange();if(e&&!e.collapsed){this._deleteContents(false,e,g);e=this.getCurrentRange();if(e.startContainer===e.endContainer&&this.element===e.startContainer){ice.dom.empty(this.element);e=this.selection.getRangeAt(0);e.collapse(true)}}else{if(!e&&!f){return true}}if(f&&!jQuery.isArray(f)){f=[f]}this._moveRangeToValidTrackingPos(e,g);this._insertNodes(e,g,f);this.endBatchChange(h);return true},_deleteContents:function(h,f){var e=true,g=this._browser;if(f){this.selection.addRange(f)}else{f=this.getCurrentRange()}var l=this._batchChangeid?null:this.startBatchChange();if(f.collapsed===false){if(this._currentUserIceNode(f.startContainer.parentNode)){this._deleteSelection(f)}else{this._deleteSelection(f);if(this._browser.mozilla){if(f.startContainer.parentNode.previousSibling){f.setEnd(f.startContainer.parentNode.previousSibling,0);f.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(f.endContainer))}else{f.setEndAfter(f.startContainer.parentNode)}f.collapse(false)}else{if(!this.visible(f.endContainer)){f.setEnd(f.endContainer,Math.max(0,f.endOffset-1));f.collapse(false)}}}}else{if(h){if(g.type==="mozilla"){e=this._deleteRight(f);if(!this.visible(f.endContainer)){if(f.endContainer.parentNode.nextSibling){f.setEndBefore(f.endContainer.parentNode.nextSibling)}else{f.setEndAfter(f.endContainer)}f.collapse(false)}}else{if(f.endOffset===ice.dom.getNodeCharacterLength(f.endContainer)){var i=f.startContainer.nextSibling;if(ice.dom.is(i,"."+this.__getIceNodeClass("deleteType"))){while(i){if(ice.dom.is(i,"."+this.__getIceNodeClass("deleteType"))){i=i.nextSibling;continue}f.setStart(i,0);f.collapse(true);break}}}e=this._deleteRight(f);if(!this.visible(f.endContainer)){if(ice.dom.is(f.endContainer.parentNode,"."+this.__getIceNodeClass("insertType")+", ."+this.__getIceNodeClass("deleteType"))){f.setStartAfter(f.endContainer.parentNode);f.collapse(true)}}}}else{if(g.mozilla){e=this._deleteLeft(f);if(!this.visible(f.startContainer)){if(f.startContainer.parentNode.previousSibling){f.setEnd(f.startContainer.parentNode.previousSibling,0)}else{f.setEnd(f.startContainer.parentNode,0)}f.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(f.endContainer));f.collapse(false)}}else{if(!this.visible(f.startContainer)){if(f.endOffset===ice.dom.getNodeCharacterLength(f.endContainer)){var k=f.startContainer.previousSibling;if(ice.dom.is(k,"."+this.__getIceNodeClass("deleteType"))){while(k){if(ice.dom.is(k,"."+this.__getIceNodeClass("deleteType"))){k=k.prevSibling;continue}f.setEndBefore(k.nextSibling,0);f.collapse(false);break}}}}e=this._deleteLeft(f)}}}this.selection.addRange(f);this.endBatchChange(l);return e},getChanges:function(){return this._changes},getChangeUserids:function(){var e=[];var g=Object.keys(this._changes);for(var f in g){e.push(this._changes[g[f]].userid)}return e.sort().filter(function(l,k,h){if(k==h.indexOf(l)){return 1}return 0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(e,h,f){var g=this.getCleanDOM(e,h,f);return(g&&g.innerHTML)||""},getCleanDOM:function(e,l,g){var k="";var f=this;ice.dom.each(this.changeTypes,function(n,m){if(n!="deleteType"){if(m>0){k+=","}k+="."+f.__getIceNodeClass(n)}});if(e){if(typeof e==="string"){e=ice.dom.create("<div>"+e+"</div>")}else{e=ice.dom.cloneNode(e,false)[0]}}else{e=ice.dom.cloneNode(this.element,false)[0]}e=g?g.call(this,e):e;var h=ice.dom.find(e,k);ice.dom.each(h,function(n,m){ice.dom.replaceWith(this,ice.dom.contents(this))});var i=ice.dom.find(e,"."+this.__getIceNodeClass("deleteType"));ice.dom.remove(i);e=l?l.call(this,e):e;return e},acceptAll:function(e){if(e){return this._acceptRejectSome(e,true)}else{this.element.innerHTML=this.getCleanContent();this._changes={};this._triggerChange()}},rejectAll:function(f){if(f){return this._acceptRejectSome(f,false)}else{var g="."+this.__getIceNodeClass("insertType");var e="."+this.__getIceNodeClass("deleteType");ice.dom.remove(ice.dom.find(this.element,g));ice.dom.each(ice.dom.find(this.element,e),function(h,k){ice.dom.replaceWith(k,ice.dom.contents(k))});this._changes={};this._triggerChange()}},acceptChange:function(e){this.acceptRejectChange(e,true)},rejectChange:function(e){this.acceptRejectChange(e,false)},acceptRejectChange:function(h,o){var q,n,i,p,f,e,m,k=ice.dom;if(!h){var l=this.getCurrentRange();if(!l.collapsed){return}else{h=l.startContainer}}q=p="."+this.__getIceNodeClass("deleteType");n=f="."+this.__getIceNodeClass("insertType");i=q+","+n;e=k.getNode(h,i);var g=k.attr(e,this.attributes.changeId);m=k.find(this.element,"["+this.attributes.changeId+"="+g+"]");if(!o){p=n;f=q}if(ice.dom.is(e,f)){k.each(m,function(r,s){k.replaceWith(s,ice.dom.contents(s))})}else{if(k.is(e,p)){k.remove(m)}else{return}}if(m.length<=1){delete this._changes[g]}this._triggerChange()},isInsideChange:function(f){try{return !!this.currentChangeNode(f)}catch(g){return false}},_getIceNode:function(g,f){var e="."+this.__getIceNodeClass(f);return ice.dom.getNode((g&&g.$)||g,e)},_moveRangeToValidTrackingPos:function(f,i){if(!(f=i||f)){return}var h,g=null;while(h=this._getVoidElement(f&&f.endContainer)){if(i){h=this.hostMethods.makeHostElement(h)}if(h==g||(i&&h.equals(g))){break}try{f.setEndAfter(h);f.collapse()}catch(k){break}}},_getNoTrackElement:function(g){var f=this._getNoTrackSelector();var e=ice.dom.is(g,f)?g:(ice.dom.parents(g,f)[0]||null);return e},_getNoTrackSelector:function(){return this.noTrack},_getVoidElement:function(h){if(h.$){h=h.$}try{var g=this._getVoidElSelector(),f=ice.dom.is(h,g)?h:(ice.dom.parents(h,g)[0]||null);if(!f){if(3==h.nodeType&&h.nodeValue=="\u200B"){return h}}}catch(i){return null}},_getVoidElSelector:function(){return"."+this.__getIceNodeClass("deleteType")},_currentUserIceNode:function(e){return ice.dom.attr(e,this.attributes.userId)==this.currentUser.id},_getChangeTypeFromAlias:function(f){var g,e=null;for(g in this.changeTypes){if(this.changeTypes.hasOwnProperty(g)){if(this.changeTypes[g].alias==f){e=g}}}return e},__getIceNodeClass:function(e){return this.attrValuePrefix+this.changeTypes[e].alias},_getUserStyle:function(e){if(e===null||e===""||"undefined"==typeof e){return this.stylePrefix}var f=null;if(this._userStyles[e]){f=this._userStyles[e]}else{f=this._setUserStyle(e,this._getNewStyleId())}return f},_setUserStyle:function(e,g){var f=this.stylePrefix+"-"+g;if(!this._styles[g]){this._styles[g]=true}return this._userStyles[e]=f},_getNewStyleId:function(){var e=++this._uniqueStyleIndex;if(this._styles[e]){return this._getNewStyleId()}else{this._styles[e]=true;return e}},__addChange:function(f,h){var g=this._batchChangeid||this.getNewChangeId(),e=this;if(!this._changes[g]){this._changes[g]={type:this._getChangeTypeFromAlias(f),time:(new Date()).getTime(),userid:String(this.currentUser.id),username:this.currentUser.name,data:this._changeData||""};this._triggerChange()}ice.dom.foreach(h,function(k){e.addNodeToChange(g,h[k])});return g},addNodeToChange:function(i,h){i=this._batchChangeid||i;var k=this.getChange(i);if(!h.getAttribute(this.attributes.changeId)){h.setAttribute(this.attributes.changeId,i)}var f=h.getAttribute(this.attributes.userId);if(!f){h.setAttribute(this.attributes.userId,f=k.userid)}if(f==k.userid){h.setAttribute(this.attributes.userName,k.username)}var e=h.getAttribute(this.attributes.changeData);if(null==e){h.setAttribute(this.attributes.changeData,this._changeData||"")}if(!h.getAttribute(this.attributes.time)){h.setAttribute(this.attributes.time,k.time)}if(!ice.dom.hasClass(h,this.__getIceNodeClass(k.type))){ice.dom.addClass(h,this.__getIceNodeClass(k.type))}var g=this._getUserStyle(k.userid);if(!ice.dom.hasClass(h,g)){ice.dom.addClass(h,g)}this._updateNodeTooltip(h)},getChange:function(e){return this._changes[e]||null},getNewChangeId:function(){var e=++this._uniqueIDIndex;if(this._changes[e]){e=this.getNewChangeId()}return e},startBatchChange:function(){this._batchChangeid=this.getNewChangeId();return this._batchChangeid},endBatchChange:function(e){if(e!==this._batchChangeid){return}this._batchChangeid=null;this._triggerChangeText()},getCurrentRange:function(){try{return this.selection.getRangeAt(0)}catch(f){return null}},_insertNodes:function(e,r,s){var p=r||e,w=p.startContainer,m=(w&&w.$)||w,x=r?this.hostMethods.makeHostElement:d;if(!ice.dom.isBlockElement(m)&&!ice.dom.canContainTextElement(ice.dom.getBlockParent(m,this.element))&&m.previousSibling){p.setStart(x(m.previousSibling),0);m=r?r.startContainer&&r.startContainer.$:p.startContainer}var q=this._getIceNode(m,"insertType"),k=this._currentUserIceNode(q);if(k){var n=s&&s[0];if(n){p.insertNode(x(n));var o=n.parentNode,y=n.nextSibling;for(var u=1;u<s.length;++u){if(y){o.insertBefore(s[u],y)}else{o.appendChild(s[u])}}}}else{var t=this._createIceNode("insertType");if(q){var g=q.childNodes.length;q.normalize();if(g!=q.childNodes.length){if(r){r=p=this.hostMethods.getHostRange()}else{p=this.getCurrentRange()}}if(q){var l=(r&&r.endContainer.$)||p.endContainer;if((l.nodeType==3&&p.endOffset<p.endContainer.length)||(l!=q.lastChild)){q=this._splitNode(q,p.endContainer,p.endOffset)}}}if(q){p.setStartAfter(x(q));p.collapse(true)}p.insertNode(x(t));var v=(s&&s.length)||0;if(v){for(var u=0;u<v;++u){t.appendChild(s[u])}p.setStartAfter(x(t.lastChild))}else{var h=this.element.ownerDocument.createTextNode("\uFEFF");t.appendChild(h);h=x(h);p.setStartAndEnd(h,0,h,1)}if(r){this.hostMethods.setHostRange(r)}else{this.selection.addRange(p)}}},_handleVoidEl:function(f,e){var g=f&&this._getVoidElement(f);if(g&&!this._getIceNode(g,"deleteType")){e.collapse(true);return true}return false},_deleteSelection:function(n){var o=new ice.Bookmark(this.env,n),e=ice.dom.getElementsBetween(o.start,o.end),q=ice.dom.parents(n.startContainer,this.blockEls.join(", "))[0],p=ice.dom.parents(n.endContainer,this.blockEls.join(", "))[0],r=new Array();for(var m=0;m<e.length;m++){var h=e[m];if(ice.dom.isBlockElement(h)){r.push(h);if(!ice.dom.canContainTextElement(h)){for(var l=0;l<h.childNodes.length;l++){e.push(h.childNodes[l])}continue}}if(h.nodeType===ice.dom.TEXT_NODE&&ice.dom.getNodeTextContent(h).length===0){continue}if(!this._getVoidElement(h)){if(h.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(h)){continue}if(ice.dom.isStubElement(h)){this._addNodeTracking(h,false,true);continue}if(ice.dom.hasNoTextOrStubContent(h)){ice.dom.remove(h)}for(j=0;j<h.childNodes.length;j++){var g=h.childNodes[j];e.push(g)}continue}var f=ice.dom.getBlockParent(h);this._addNodeTracking(h,false,true,true);if(ice.dom.hasNoTextOrStubContent(f)){ice.dom.remove(f)}}}if(this.mergeBlocks&&q!==p){while(r.length){ice.dom.mergeContainers(r.shift(),q)}ice.dom.removeBRFromChild(p);ice.dom.removeBRFromChild(q);ice.dom.mergeContainers(p,q)}o.selectBookmark();n.collapse(true)},_deleteRight:function(s){var g=ice.dom.isBlockElement(s.startContainer)&&s.startContainer||ice.dom.getBlockParent(s.startContainer,this.element)||null,t=g?(ice.dom.hasNoTextOrStubContent(g)):false,q=g&&ice.dom.getNextContentNode(g,this.element),u=q?(ice.dom.hasNoTextOrStubContent(q)):false,n=s.endContainer,m=s.endOffset,h=s.commonAncestorContainer,o,y;if(t){return false}if(h.nodeType!==ice.dom.TEXT_NODE){if(m===0&&ice.dom.isBlockElement(h)&&(!ice.dom.canContainTextElement(h))){var w=h.firstElementChild;if(w){s.setStart(w,0);s.collapse();return this._deleteRight(s)}}if(h.childNodes.length>m){var k=document.createTextNode(" ");h.insertBefore(k,h.childNodes[m]);s.setStart(k,1);s.collapse(true);y=this._deleteRight(s);ice.dom.remove(k);return y}else{o=ice.dom.getNextContentNode(h,this.element);s.setEnd(o,0);s.collapse();return this._deleteRight(s)}}s.moveEnd(ice.dom.CHARACTER_UNIT,1);s.moveEnd(ice.dom.CHARACTER_UNIT,-1);if(m===n.data.length&&(!ice.dom.hasNoTextOrStubContent(n))){o=ice.dom.getNextNode(n,this.element);if(!o){s.selectNodeContents(n);s.collapse();return false}if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(o)){o=ice.dom.getNextNode(o,this.element)}if(o.nodeType===ice.dom.TEXT_NODE){o=o.parentNode}if(!o.isContentEditable){y=this._addNodeTracking(o,false,false);var l=document.createTextNode("");o.parentNode.insertBefore(l,o.nextSibling);s.selectNode(l);s.collapse(true);return y}if(this._handleVoidEl(o,s)){return true}if(ice.dom.isChildOf(o,g)&&ice.dom.isStubElement(o)){return this._addNodeTracking(o,s,false)}}if(this._handleVoidEl(o,s)){return true}if(this._getNoTrackElement(s.endContainer.parentElement)){s._deleteContents();return false}if(ice.dom.isOnBlockBoundary(s.startContainer,s.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(o,this.element),this.blockEl)){if(q!==ice.dom.getBlockParent(s.endContainer,this.element)){s.setEnd(q,0)}var r=ice.dom.getElementsBetween(s.startContainer,s.endContainer);for(var v=0;v<r.length;v++){ice.dom.remove(r[v])}var x=s.startContainer;var z=s.endContainer;ice.dom.remove(ice.dom.find(x,"br"));ice.dom.remove(ice.dom.find(z,"br"));return ice.dom.mergeBlockWithSibling(s,ice.dom.getBlockParent(s.endContainer,this.element)||g)}else{if(u){ice.dom.remove(q);s.collapse(true);return true}s.setStart(q,0);s.collapse(true);return true}}var e=s.endContainer,p=e.splitText(s.endOffset),f=p.splitText(1);return this._addNodeTracking(p,s,false)},_deleteLeft:function(s){var h=ice.dom.isBlockElement(s.startContainer)&&s.startContainer||ice.dom.getBlockParent(s.startContainer,this.element)||null,t=h?ice.dom.hasNoTextOrStubContent(h):false,o=h&&ice.dom.getPrevContentNode(h,this.element),w=o?ice.dom.hasNoTextOrStubContent(o):false,n=s.startContainer,m=s.startOffset,k=s.commonAncestorContainer,g,v;if(t){return false}if(m===0||k.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(k)&&(!ice.dom.canContainTextElement(k))){if(m===0){var x=k.firstElementChild;if(x){s.setStart(x,0);s.collapse();return this._deleteLeft(s)}}else{var q=k.lastElementChild;if(q){g=s.getLastSelectableChild(q);if(g){s.setStart(g,g.data.length);s.collapse();return this._deleteLeft(s)}}}}if(m===0){v=ice.dom.getPrevContentNode(n,this.element)}else{v=k.childNodes[m-1]}if(!v){return false}if(ice.dom.is(v,"."+this.__getIceNodeClass("insertType")+", ."+this.__getIceNodeClass("deleteType"))&&v.childNodes.length>0&&v.lastChild){v=v.lastChild}if(v.nodeType===ice.dom.TEXT_NODE){v=v.parentNode}if(!v.isContentEditable){var z=this._addNodeTracking(v,false,true);var l=document.createTextNode("");v.parentNode.insertBefore(l,v);s.selectNode(l);s.collapse(true);return z}if(this._handleVoidEl(v,s)){return true}if(ice.dom.isStubElement(v)&&ice.dom.isChildOf(v,h)||!v.isContentEditable){return this._addNodeTracking(v,s,true)}if(ice.dom.isStubElement(v)){ice.dom.remove(v);s.collapse(true);return false}if(v!==h&&!ice.dom.isChildOf(v,h)){if(!ice.dom.canContainTextElement(v)){v=v.lastElementChild}if(v.lastChild&&v.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(v.lastChild)&&v.lastChild.tagName!=="BR"){s.setStartAfter(v.lastChild);s.collapse(true);return true}g=s.getLastSelectableChild(v);if(g&&!ice.dom.isOnBlockBoundary(s.startContainer,g,this.element)){s.selectNodeContents(g);s.collapse();return true}}}if(m===1&&!ice.dom.isBlockElement(k)&&s.startContainer.childNodes.length>1&&s.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&s.startContainer.childNodes[0].data.length===0){s.setStart(s.startContainer,0);return this._deleteLeft(s)}s.moveStart(ice.dom.CHARACTER_UNIT,-1);s.moveStart(ice.dom.CHARACTER_UNIT,1);if(this._getNoTrackElement(s.startContainer.parentElement)){s._deleteContents();return false}if(ice.dom.isOnBlockBoundary(s.startContainer,s.endContainer,this.element)){if(w){ice.dom.remove(o);s.collapse();return true}if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(v,this.element),this.blockEl)){if(o!==ice.dom.getBlockParent(s.startContainer,this.element)){s.setStart(o,o.childNodes.length)}var r=ice.dom.getElementsBetween(s.startContainer,s.endContainer);for(var u=0;u<r.length;u++){ice.dom.remove(r[u])}var y=s.startContainer;var A=s.endContainer;ice.dom.remove(ice.dom.find(y,"br"));ice.dom.remove(ice.dom.find(A,"br"));return ice.dom.mergeBlockWithSibling(s,ice.dom.getBlockParent(s.endContainer,this.element)||h)}if(o&&o.lastChild&&ice.dom.isStubElement(o.lastChild)){s.setStartAfter(o.lastChild);s.collapse(true);return true}g=s.getLastSelectableChild(o);if(g){s.setStart(g,g.data.length);s.collapse(true)}else{if(o){s.setStart(o,o.childNodes.length);s.collapse(true)}}return true}var e=s.startContainer,p=e.splitText(s.startOffset-1),f=p.splitText(1);return this._addNodeTracking(p,s,true)},_addNodeTracking:function(k,l,m){var n=this._getIceNode(k,"insertType");if(n&&this._currentUserIceNode(n)){if(l&&m){l.selectNode(k)}k.parentNode.removeChild(k);var e=ice.dom.cloneNode(n);ice.dom.remove(ice.dom.find(e,".iceBookmark"));if(n!==null&&(ice.dom.hasNoTextOrStubContent(e[0]))){var o=this.env.document.createTextNode("");ice.dom.insertBefore(n,o);if(l){l.setStart(o,0);l.collapse(true)}ice.dom.replaceWith(n,ice.dom.contents(n))}return true}else{if(l&&this._getIceNode(k,"deleteType")){this._normalizeNode(k);var s=false;if(m){var f=ice.dom.getPrevContentNode(k,this.element);while(!s){q=this._getIceNode(f,"deleteType");if(!q){s=true}else{f=ice.dom.getPrevContentNode(f,this.element)}}if(f){var p=l.getLastSelectableChild(f);if(p){f=p}l.setStart(f,ice.dom.getNodeCharacterLength(f));l.collapse(true)}return true}else{var i=ice.dom.getNextContentNode(k,this.element);while(!s){q=this._getIceNode(i,"deleteType");if(!q){s=true}else{i=ice.dom.getNextContentNode(i,this.element)}}if(i){l.selectNodeContents(i);l.collapse(true)}return true}}}if(k.previousSibling&&k.previousSibling.nodeType===ice.dom.TEXT_NODE&&k.previousSibling.length===0){k.parentNode.removeChild(k.previousSibling)}if(k.nextSibling&&k.nextSibling.nodeType===ice.dom.TEXT_NODE&&k.nextSibling.length===0){k.parentNode.removeChild(k.nextSibling)}var g=this._getIceNode(k.previousSibling,"deleteType");var r=this._getIceNode(k.nextSibling,"deleteType");var q;if(g&&this._currentUserIceNode(g)){q=g;q.appendChild(k);if(r&&this._currentUserIceNode(r)){var h=ice.dom.extractContent(r);ice.dom.append(q,h);r.parentNode.removeChild(r)}}else{if(r&&this._currentUserIceNode(r)){q=r;q.insertBefore(k,q.firstChild)}else{q=this._createIceNode("deleteType");k.parentNode.insertBefore(q,k);q.appendChild(k)}}if(l){if(ice.dom.isStubElement(k)){l.selectNode(k)}else{l.selectNodeContents(k)}if(m){l.collapse(true)}else{l.collapse()}this._normalizeNode(k)}return true},_handleAncillaryKey:function(m){var l=m.keyCode?m.keyCode:m.which,i=this._browser,h=true,k=m.shiftKey,g=this,f=g.getCurrentRange();switch(l){case ice.dom.DOM_VK_DELETE:h=this._deleteContents();break;case 46:h=this._deleteContents(true);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:if(i.type==="mozilla"){if(!this.visible(f.startContainer)){if(f.startContainer.parentNode.previousSibling){f.setEnd(f.startContainer.parentNode.previousSibling,0);f.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(f.endContainer));f.collapse(false)}else{f.setEnd(f.startContainer.parentNode.nextSibling,0);f.collapse(false)}}}h=false;break;case ice.dom.DOM_VK_RIGHT:if(i.type==="mozilla"){if(!this.visible(f.startContainer)){if(f.startContainer.parentNode.nextSibling){f.setStart(f.startContainer.parentNode.nextSibling,0);f.collapse(true)}}}h=false;break;default:h=false;break}if(h===true){ice.dom.preventDefault(m);return false}return true},keyDown:function(g){var f=false;if(this._handleSpecialKey(g)===false){if(ice.dom.isBrowser("msie")!==true){this._preventKeyPress=true}return false}switch(g.keyCode){case 27:break;default:if(!this._browser.firefox){f=!(this._handleAncillaryKey(g))}break}if(f){ice.dom.preventDefault(g);return false}return true},keyPress:function(i){if(this._preventKeyPress===true){this._preventKeyPress=false;return}var k=null;if(i.which==null){k=String.fromCharCode(i.keyCode)}else{if(i.which>0){k=String.fromCharCode(i.which)}}if(i.ctrlKey||i.metaKey){return true}var f=this.getCurrentRange(),h=f&&ice.dom.parents(f.startContainer,"br")[0]||null;if(h){f.moveToNextEl(h)}if(k!==null&&i.ctrlKey!==true&&i.metaKey!==true){var g=i.keyCode?i.keyCode:i.which;switch(g){case ice.dom.DOM_VK_DELETE:return this._handleAncillaryKey(i);case ice.dom.DOM_VK_ENTER:return this._handleEnter();default:this._moveRangeToValidTrackingPos(f);return this.insert()}}return this._handleAncillaryKey(i)},_handleEnter:function(){var e=this.getCurrentRange();if(e&&!e.collapsed){this._deleteContents()}return true},_handleSpecialKey:function(l){var k=l.which;if(k===null){k=l.keyCode}var h=false;switch(k){case 65:if(!this._handleSelectAll){return true}if(l.ctrlKey===true||l.metaKey===true){h=true;var g=this.getCurrentRange();if(ice.dom.isBrowser("msie")===true){var m=this.env.document.createTextNode("");var f=this.env.document.createTextNode("");if(this.element.firstChild){ice.dom.insertBefore(this.element.firstChild,m)}else{this.element.appendChild(m)}this.element.appendChild(f);g.setStart(m,0);g.setEnd(f,0)}else{g.setStart(g.getFirstSelectableChild(this.element),0);var i=g.getLastSelectableChild(this.element);g.setEnd(i,i.length)}this.selection.addRange(g)}break;default:break}if(h===true){ice.dom.preventDefault(l);return false}return true},getContentElement:function(){return this.element},_getIceNodes:function(){var f=[];var e=this;ice.dom.each(this.changeTypes,function(h,g){f.push("."+e.__getIceNodeClass(h))});f=f.join(",");return jQuery(this.element).find(f)},currentChangeNode:function(g){var e="."+this.__getIceNodeClass("insertType")+", ."+this.__getIceNodeClass("deleteType");if(!g){var f=this.getCurrentRange();if(!f||!f.collapsed){return false}else{g=f.startContainer}}return ice.dom.getNode(g,e)},setShowChanges:function(e){e=!!e;this._isVisible=e;var f=jQuery(this.element);f.toggleClass("ICE-Tracking",e);this._showTitles(e);this._updateTooltipsState()},reload:function(){this._loadFromDom()},hasChanges:function(){for(var e in this._changes){var f=this._changes[e];if(f&&f.type){return true}}return false},countChanges:function(e){var f=this._filterChanges(e);return f.count},setChangeData:function(e){if(null==e||(typeof e=="undefined")){e=""}this._changeData=String(e)},getDeleteClass:function(){return this.__getIceNodeClass("deleteType")},toString:function(){return"ICE "+((this.element&&this.element.id)||"(no element id)")},_splitNode:function(i,m,e){var h=i.parentNode,f=rangy.dom.getNodeIndex(i),l=m.ownerDocument,g=l.createRange(),k;g.setStart(h,f);g.setEnd(m,e);k=g.extractContents();h.insertBefore(k,i);return i.previousSibling},_triggerChange:function(){this.$this.trigger("change")},_triggerChangeText:function(){this.$this.trigger("textChange")},_updateNodeTooltip:function(e){if(this.tooltips&&this._isTracking&&this._isVisible){this._addTooltip(e)}},_acceptRejectSome:function(h,e){var k=(function(f,m){this.acceptRejectChange(m,e)}).bind(this);var i=this._filterChanges(h);for(var l in i.changes){var g=ice.dom.find(this.element,"["+this.attributes.changeId+"="+l+"]");g.each(k)}if(i.count){this._triggerChange()}},_filterChanges:function(n){var h=0,k={};var f=n&&n.filter;var g=n&&n.exclude?jQuery.map(n.exclude,function(o){return String(o)}):null;var e=n&&n.include?jQuery.map(n.include,function(o){return String(o)}):null;for(var m in this._changes){var i=this._changes[m];if(i&&i.type){var l=(f&&!f({userid:i.userid,time:i.time,data:i.data}))||(g&&g.indexOf(i.userid)>=0)||(e&&e.indexOf(i.userid)<0);if(!l){++h;k[m]=i}}}return{count:h,changes:k}},_loadFromDom:function(){this._changes={};this._uniqueStyleIndex=0;var k=this.currentUser&&this.currentUser.id;var i=(this.currentUser&&this.currentUser.name)||"";var h=(new Date()).getTime();var m=[];for(var e in this.changeTypes){m.push(this.__getIceNodeClass(e))}var g=this._getIceNodes();function l(p,n){var t=0;var w="";var f=n.className.split(" ");for(var p=0;p<f.length;p++){var v=new RegExp(this.stylePrefix+"-(\\d+)").exec(f[p]);if(v){t=v[1]}var x=new RegExp("("+m.join("|")+")").exec(f[p]);if(x){w=this._getChangeTypeFromAlias(x[1])}}var q=ice.dom.attr(n,this.attributes.userId);var u;if(k&&(q==k)){u=i;n.setAttribute(this.attributes.userName,i)}else{u=n.getAttribute(this.attributes.userName)}this._setUserStyle(q,Number(t));var y=parseInt(ice.dom.attr(n,this.attributes.changeId)||"");if(isNaN(y)){y=this.getNewChangeId();n.setAttribute(this.attributes.changeId,y)}var o=parseInt(n.getAttribute(this.attributes.time)||"");if(isNaN(o)){o=h}var r=ice.dom.attr(n,this.attributes.changeData)||"";var s={type:w,userid:String(q),username:u,time:o,data:r};this._changes[y]=s;this._updateNodeTooltip(n)}g.each(l.bind(this));this._triggerChange()},_updateUserData:function(f){if(f){for(var g in this._changes){var h=this._changes[g];if(h.userid==f.id){h.username=f.name}}}var e=this._getIceNodes();e.each((function(l,m){var k=(!f)||(f.id==m.getAttribute(this.attributes.userId));if(f&&k){m.setAttribute(this.userNameAttribute,f.name)}}).bind(this))},_showTitles:function(f){var e=this._getIceNodes();if(f){jQuery(e).each((function(g,h){this._updateNodeTooltip(h)}).bind(this))}else{jQuery(e).removeAttr("title")}},_updateTooltipsState:function(){if(this.tooltips&&this._isTracking&&this._isVisible){if(!this._showingTips){this._showingTips=true;var f=this._getIceNodes(),e=this;f.each(function(g,h){e._addTooltip(h)})}}else{if(this._showingTips){this._showingTips=false;var f=this._getIceNodes();f.each(function(g,h){jQuery(h).unbind("mouseover").unbind("mouseout")})}}},_addTooltip:function(e){jQuery(e).unbind("mouseover").unbind("mouseout").mouseover(this._tooltipMouseOver).mouseout(this._tooltipMouseOut)},_tooltipMouseOver:function(h){var g=h.currentTarget,f=jQuery(g),e=this;if(!f.data("_tooltip_t")){var i=setTimeout(function(){var l=f.attr(e.attributes.changeId),k=e.getChange(l);if(k){f.removeData("_tooltip_t");e.hostMethods.showTooltip(g,jQuery.extend({},k))}},this.tooltipsDelay);f.data("_tooltip_t",i)}},_tooltipMouseOut:function(g){var f=g.currentTarget,e=jQuery(f),h=e.data("_tooltip_t");e.removeData("_tooltip_t");if(h){clearTimeout(h)}else{this.hostMethods.hideTooltip(f)}},_normalizeNode:function(e){if(!e){return}if(typeof e.normalize=="function"){return e.normalize()}return this._myNormalizeNode(e)},_myNormalizeNode:function(h){if(!h){return}var e=1;var f=3;var k=h.firstChild;while(k){if(k.nodeType==e){this._myNormalizeNode(k)}else{if(k.nodeType==f){var g;while((g=k.nextSibling)&&g.nodeType==f){var i=g.nodeValue;if(i!=null&&i.length){k.nodeValue=k.nodeValue+i}h.removeChild(g)}}}k=k.nextSibling}}};a.ice=this.ice||{};a.ice.InlineChangeEditor=b}).call(this);
/* Copyright (C) 2014 LoopIndex - All Rights Reserved
 * You may use, distribute and modify this code under the
 * terms of the LoopIndex Comments CKEditor plugin license.
 *
 * You should have received a copy of the LoopIndex Comments CKEditor plugin license with
 * this file. If not, please write to: loopindex@gmail.com, or visit http://www.loopindex.com
 * written by (David *)Frenkiel (https://github.com/imdfl) 
 */